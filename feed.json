{
    "version": "https://jsonfeed.org/version/1",
    "title": "好暖好温暖的博客",
    "subtitle": "Do one thing and do it well.",
    "icon": "https://soruan.github.io/assets/favicon.ico",
    "description": "生活有多种可能性",
    "home_page_url": "https://soruan.github.io",
    "items": [
        {
            "id": "https://soruan.github.io/2025/11/28/Frp%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E5%88%B0%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8/",
            "url": "https://soruan.github.io/2025/11/28/Frp%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E5%88%B0%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8/",
            "title": "Frp内网穿透到云服务器",
            "date_published": "2025-11-28T06:59:32.000Z",
            "content_html": "<h1 id=\"frp内网穿透\"><a class=\"anchor\" href=\"#frp内网穿透\">#</a> Frp内网穿透</h1>\n<p>把本地服务器的端口映射到公网服务器，通过公网服务器ip地址+端口来访问内网</p>\n<p>具体为：<img loading=\"lazy\" src=\"https://markdownforyuanhao.oss-cn-hangzhou.aliyuncs.com/img1/20251128141147350.png\" alt=\"截屏2025-11-28 14.11.44\" /></p>\n<p>其中<code>192.168.31.29</code>为本地服务器内网ip</p>\n<h2 id=\"公网服务器frp服务端\"><a class=\"anchor\" href=\"#公网服务器frp服务端\">#</a> 公网服务器（Frp服务端）</h2>\n<p>下载amd64/Linux的frp</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">wget</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> https://github.com/fatedier/frp/releases/download/v0.65.0/frp_0.65.0_linux_amd64.tar.gz</span></span></code></pre>\n<p>解压</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">tar</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -zxvf</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> frp_0.65.0_linux_amd64.tar.gz</span></span></code></pre>\n<p>把frpc复制到<code>/usr/local/bin</code></p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#998418;--shiki-dark:#B8A965\">cd</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> frp_0.65.0_linux_amd64/</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> cp</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> frps</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> /usr/local/bin/</span></span></code></pre>\n<p>设置配置文件</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> mkdir</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -p</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> /etc/frp</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> vim</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> /etc/frp/frps.toml</span></span></code></pre>\n<p>填入以下内容</p>\n<p><code>auth.token</code>和<code>webServer.password</code>要配置的足够安全，不然有安全隐患。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-toml\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># /etc/frp/frps.toml</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># frp 服务端监听的控制端口，用于和客户端建立连接</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">bindPort</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 7000</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 鉴权机制 </span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">auth</span><span style=\"color:#999999;--shiki-dark:#666666\">.</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">method</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">token</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">auth</span><span style=\"color:#999999;--shiki-dark:#666666\">.</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">token</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">password</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># FRP Dashboard 面板，方便监控连接数和流量</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">webServer</span><span style=\"color:#999999;--shiki-dark:#666666\">.</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">addr</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">0.0.0.0</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">webServer</span><span style=\"color:#999999;--shiki-dark:#666666\">.</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">port</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 7500</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">webServer</span><span style=\"color:#999999;--shiki-dark:#666666\">.</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">user</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">admin</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">webServer</span><span style=\"color:#999999;--shiki-dark:#666666\">.</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">password</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">password</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span></code></pre>\n<p>创建和配置<code>/etc/systemd/system/frps.service</code></p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-toml\"><span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#59873A;--shiki-dark:#80A665\">Unit</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">Description</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">F</span><span style=\"color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic\">rp Server Service</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">After</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">n</span><span style=\"color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic\">etwork.target</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#59873A;--shiki-dark:#80A665\">Service</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">Type</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">s</span><span style=\"color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic\">imple</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">User</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">r</span><span style=\"color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic\">oot</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">Restart</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">o</span><span style=\"color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic\">n-failure</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">RestartSec</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">5</span><span style=\"color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic\">s</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 注意配置文件的路径</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">ExecStart</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">/</span><span style=\"color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic\">usr/local/bin/frps -c /etc/frp/frps.toml</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#59873A;--shiki-dark:#80A665\">Install</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">WantedBy</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">m</span><span style=\"color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic\">ulti-user.target</span></span></code></pre>\n<p>启动和检查状态</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> systemctl</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> enable</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> --now</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> frps</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">systemctl</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> status</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> frps</span></span></code></pre>\n<p><strong>云服务器放行端口</strong>：</p>\n<p><strong>公网防火墙 (安全组)</strong>： 在服务器的控制台的<strong>安全组</strong> 中放行以下端口：</p>\n<ul>\n<li><code>7000</code> (FRP 通信)</li>\n<li><code>8000</code> (映射后的 WS)</li>\n<li><code>8002</code> (映射后的 Web)</li>\n<li><code>8003</code> (映射后的 Vision)</li>\n</ul>\n<p>以及确保云服务器中的对应端口没有被占用</p>\n<p>可以通过服务器ip和7500端口进入控制面板</p>\n<p><img loading=\"lazy\" src=\"https://markdownforyuanhao.oss-cn-hangzhou.aliyuncs.com/img1/20251128135233845.png\" alt=\"截屏2025-11-28 13.52.28\" /></p>\n<hr />\n<h2 id=\"内网服务器frp客户端\"><a class=\"anchor\" href=\"#内网服务器frp客户端\">#</a> 内网服务器（Frp客户端）</h2>\n<p>同样的下载和解压Frp，把frpc复制到<code>/usr/local/bin</code></p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> cp</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> frpc</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> /usr/local/bin/</span></span></code></pre>\n<p>创建配置文件</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> mkdir</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -p</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> /etc/frp</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> vim</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> /etc/frp/frpc.toml</span></span></code></pre>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-toml\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># /etc/frp/frpc.toml</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 公网服务器 IP</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">serverAddr</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">x.x.x.x</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">serverPort</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 7000</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 鉴权 Token (必须与服务端 frps.toml 一致)</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">auth</span><span style=\"color:#999999;--shiki-dark:#666666\">.</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">method</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">token</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">auth</span><span style=\"color:#999999;--shiki-dark:#666666\">.</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">token</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">password</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># --- 隧道 1: WebSocket API ---</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">[</span><span style=\"color:#59873A;--shiki-dark:#80A665\">proxies</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">]</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">name</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">xiaozhi-ws-8000</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">type</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">tcp</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">localIP</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">127.0.0.1</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">localPort</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 8000</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">remotePort</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 8000</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">transport</span><span style=\"color:#999999;--shiki-dark:#666666\">.</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">useEncryption</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> true</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">transport</span><span style=\"color:#999999;--shiki-dark:#666666\">.</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">useCompression</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> true</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># --- 隧道 2: Web 管理 &#x26; OTA ---</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">[</span><span style=\"color:#59873A;--shiki-dark:#80A665\">proxies</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">]</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">name</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">xiaozhi-web-8002</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">type</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">tcp</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">localIP</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">127.0.0.1</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">localPort</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 8002</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">remotePort</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 8002</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">transport</span><span style=\"color:#999999;--shiki-dark:#666666\">.</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">useEncryption</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> true</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">transport</span><span style=\"color:#999999;--shiki-dark:#666666\">.</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">useCompression</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> true</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># --- 隧道 3: 视觉分析接口 ---</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">[</span><span style=\"color:#59873A;--shiki-dark:#80A665\">proxies</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">]</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">name</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">xiaozhi-vision-8003</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">type</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">tcp</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">localIP</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">127.0.0.1</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">localPort</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 8003</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">remotePort</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 8003</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">transport</span><span style=\"color:#999999;--shiki-dark:#666666\">.</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">useEncryption</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> true</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">transport</span><span style=\"color:#999999;--shiki-dark:#666666\">.</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">useCompression</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> true</span></span></code></pre>\n<p>对应内网服务器的8000、8002、8003端口</p>\n<p><img loading=\"lazy\" src=\"https://markdownforyuanhao.oss-cn-hangzhou.aliyuncs.com/img1/20251128141147350.png\" alt=\"截屏2025-11-28 14.11.44\" /></p>\n<p>临时测试</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">frpc</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -c</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> frpc.toml</span></span></code></pre>\n<p>参考云服务器配置，设置为systemd守护进程并启动运行</p>\n<p>创建和配置<code>/etc/systemd/system/frpc.service</code></p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-toml\"><span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#59873A;--shiki-dark:#80A665\">Unit</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">Description</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">F</span><span style=\"color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic\">rp Client Service</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">After</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">n</span><span style=\"color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic\">etwork.target</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#59873A;--shiki-dark:#80A665\">Service</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">Type</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">s</span><span style=\"color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic\">imple</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">User</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">r</span><span style=\"color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic\">oot</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">Restart</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">o</span><span style=\"color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic\">n-failure</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">RestartSec</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">5</span><span style=\"color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic\">s</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 注意配置文件的路径</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">ExecStart</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">/</span><span style=\"color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic\">usr/local/bin/frpc -c /etc/frp/frpc.toml</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#59873A;--shiki-dark:#80A665\">Install</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">WantedBy</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">m</span><span style=\"color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic\">ulti-user.target</span></span></code></pre>\n<p>启动和检查状态</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> systemctl</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> enable</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> --now</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> frpc</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">systemctl</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> status</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> frpc</span></span></code></pre>\n<h2 id=\"理论上实现的效果\"><a class=\"anchor\" href=\"#理论上实现的效果\">#</a> 理论上实现的效果</h2>\n<p>假设公网服务器ip地址为<code>xxx.xxx.xxx.xxx</code>，浏览器输入<code>http://xxx.xxx.xxx.xxx:8002</code>即可进入AI对话服务端的web界面，其他以此类推。</p>\n<p>后面再在公网服务器上部署 Nginx ，把形如<code>http://xxx.com/xiaozhi/ota/</code>到地址指向指定端口。</p>\n",
            "tags": [
                "环境配置&工具使用",
                "Frp"
            ]
        },
        {
            "id": "https://soruan.github.io/2025/11/12/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE&%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/ADB%E5%B7%A5%E5%85%B7%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95/",
            "url": "https://soruan.github.io/2025/11/12/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE&%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/ADB%E5%B7%A5%E5%85%B7%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95/",
            "title": "ADB工具基础用法",
            "date_published": "2025-11-12T07:30:32.000Z",
            "content_html": "<h3 id=\"设备管理-device-management\"><a class=\"anchor\" href=\"#设备管理-device-management\">#</a> 设备管理 (Device Management)</h3>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">命令 (Command)</th>\n<th style=\"text-align:left\">功能说明 (Description)</th>\n<th style=\"text-align:left\">示例 (Example)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\"><code>adb devices</code></td>\n<td style=\"text-align:left\">列出所有已连接的设备及其状态。</td>\n<td style=\"text-align:left\"><code>adb devices -l</code></td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><code>adb root</code></td>\n<td style=\"text-align:left\">以 root 权限重启 <code>adbd</code> 服务，获取完全访问权限。</td>\n<td style=\"text-align:left\"><code>adb root</code></td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><code>adb reboot</code></td>\n<td style=\"text-align:left\">重启开发板。</td>\n<td style=\"text-align:left\"><code>adb reboot</code></td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><code>adb reboot bootloader</code></td>\n<td style=\"text-align:left\">重启到 Bootloader 模式。</td>\n<td style=\"text-align:left\"><code>adb reboot bootloader</code></td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><code>adb get-serialno</code></td>\n<td style=\"text-align:left\">获取设备的序列号。</td>\n<td style=\"text-align:left\"><code>adb get-serialno</code></td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><code>adb get-state</code></td>\n<td style=\"text-align:left\">获取设备状态 (<code>device</code>, <code>offline</code>, <code>bootloader</code>)。</td>\n<td style=\"text-align:left\"><code>adb get-state</code></td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"文件传输-file-transfer\"><a class=\"anchor\" href=\"#文件传输-file-transfer\">#</a> 文件传输 (File Transfer)</h3>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">命令 (Command)</th>\n<th style=\"text-align:left\">功能说明 (Description)</th>\n<th style=\"text-align:left\">示例 (Example)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\"><code>adb push &lt;本地&gt; &lt;远程&gt;</code></td>\n<td style=\"text-align:left\">从电脑向开发板推送文件或文件夹。</td>\n<td style=\"text-align:left\"><code>adb push main /data/local/tmp/</code></td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><code>adb pull &lt;远程&gt; &lt;本地&gt;</code></td>\n<td style=\"text-align:left\">从开发板向电脑拉取文件或文件夹。</td>\n<td style=\"text-align:left\"><code>adb pull /data/anr/traces.txt .</code></td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"应用管理-application-management-主要用于android\"><a class=\"anchor\" href=\"#应用管理-application-management-主要用于android\">#</a> 应用管理 (Application Management - 主要用于Android)</h3>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">命令 (Command)</th>\n<th style=\"text-align:left\">功能说明 (Description)</th>\n<th style=\"text-align:left\">示例 (Example)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\"><code>adb install &lt;apk路径&gt;</code></td>\n<td style=\"text-align:left\">安装一个 APK 应用。</td>\n<td style=\"text-align:left\"><code>adb install my_app.apk</code></td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><code>adb uninstall &lt;包名&gt;</code></td>\n<td style=\"text-align:left\">卸载一个应用。</td>\n<td style=\"text-align:left\"><code>adb uninstall com.example.myapp</code></td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><code>adb shell pm list packages</code></td>\n<td style=\"text-align:left\">列出设备上所有应用的包名。</td>\n<td style=\"text-align:left\"><code>adb shell pm list packages \\| grep myapp</code></td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"远程-shell-与调试-remote-shell-debugging\"><a class=\"anchor\" href=\"#远程-shell-与调试-remote-shell-debugging\">#</a> 远程 Shell 与调试 (Remote Shell &amp; Debugging)</h3>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">命令 (Command)</th>\n<th style=\"text-align:left\">功能说明 (Description)</th>\n<th style=\"text-align:left\">示例 (Example)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\"><code>adb shell</code></td>\n<td style=\"text-align:left\">进入开发板的交互式 Shell 环境。</td>\n<td style=\"text-align:left\"><code>adb shell</code></td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><code>adb shell &lt;命令&gt;</code></td>\n<td style=\"text-align:left\">在开发板上执行单条 Shell 命令。</td>\n<td style=\"text-align:left\"><code>adb shell &quot;ps -ef \\| grep main&quot;</code></td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><code>adb logcat</code></td>\n<td style=\"text-align:left\">查看 Android 系统的实时日志。</td>\n<td style=\"text-align:left\"><code>adb logcat</code></td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><code>adb bugreport</code></td>\n<td style=\"text-align:left\">生成一份包含所有系统信息的完整 bug 报告。</td>\n<td style=\"text-align:left\"><code>adb bugreport ./report.zip</code></td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><code>adb forward</code></td>\n<td style=\"text-align:left\">端口转发，将主机的端口映射到开发板的端口。</td>\n<td style=\"text-align:left\"><code>adb forward tcp:8080 tcp:80</code></td>\n</tr>\n</tbody>\n</table>\n",
            "tags": [
                "环境配置&工具使用",
                "ADB"
            ]
        },
        {
            "id": "https://soruan.github.io/2025/11/12/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE&%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/NetWorkManager/",
            "url": "https://soruan.github.io/2025/11/12/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE&%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/NetWorkManager/",
            "title": "NetWorkManager",
            "date_published": "2025-11-12T07:30:16.000Z",
            "content_html": "<h1 id=\"使用-nmcli-管理网络连接\"><a class=\"anchor\" href=\"#使用-nmcli-管理网络连接\">#</a> 使用 <code>nmcli</code> 管理网络连接</h1>\n<p><code>nmcli</code> 是 NetworkManager 的命令行客户端，是在现代 Linux 发行版（如 Debian、Ubuntu、CentOS）中管理网络连接的强大工具。</p>\n<h2 id=\"一-基础查看命令\"><a class=\"anchor\" href=\"#一-基础查看命令\">#</a> 一、基础查看命令</h2>\n<h3 id=\"1-查看网络设备\"><a class=\"anchor\" href=\"#1-查看网络设备\">#</a> 1. 查看网络设备</h3>\n<p>使用 <code>nmcli device</code> (或 <code>nmcli device status</code>) 查看系统中所有网络设备及其状态。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">❯</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> device</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">DEVICE</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">           TYPE</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">      STATE</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">         CONNECTION</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">      </span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">wlp2s0</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">           wifi</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">      已连接</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">        虚空终端</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">        </span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">tailscale0</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">       tun</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">       连接（外部）</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  tailscale0</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">      </span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">docker0</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">          bridge</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    连接（外部）</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  docker0</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">         </span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">lo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">               loopback</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  连接（外部）</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  lo</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">              </span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">br-2dd69cafb18b</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  bridge</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    连接（外部）</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  br-2dd69cafb18b</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span></span>\n<span class=\"line\"><span style=\"color:#998418;--shiki-dark:#B8A965\">...</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">enp6s0f3u2u4</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">     ethernet</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  已断开</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">        --</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">              </span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">p2p-dev-wlp2s0</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">   wifi-p2p</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  已断开</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">        --</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">   </span></span></code></pre>\n<h3 id=\"2-查看所有连接配置\"><a class=\"anchor\" href=\"#2-查看所有连接配置\">#</a> 2. 查看所有连接配置</h3>\n<p>使用 <code>nmcli connection show</code> 列出所有已保存的网络连接配置。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">hao@archlinux </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">~</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">$ nmcli connection show</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">NAME</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">        UUID</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">                                  TYPE</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">      DEVICE</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">     </span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">有线连接</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 1</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  605f8e47-9a35-3183-80af-447a18307c8b</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  ethernet</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  enp2s0</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">    </span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">Kwrt_5G</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">     536344bf-a2df-41cf-9dfe-f71ca37fe4d7</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  wifi</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">      wlan0</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">     </span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">tailscale0</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  a8ebcfa3-e44d-472c-9ead-65fc154d2bb7</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  tun</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">       tailscale0</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span></span>\n<span class=\"line\"><span style=\"color:#998418;--shiki-dark:#B8A965\">...</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">      </span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">N100-Setup</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  a655b45d-1c87-468f-8a14-914534aa6c63</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  wifi</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">      --</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">         </span></span></code></pre>\n<h3 id=\"3-查看连接的自动连接状态\"><a class=\"anchor\" href=\"#3-查看连接的自动连接状态\">#</a> 3. 查看连接的自动连接状态</h3>\n<p>可以-f指定字段，查看更详细的自启配置。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">hao@archlinux </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">~</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">$ nmcli -f NAME,TYPE,AUTOCONNECT,AUTOCONNECT-PRIORITY connection show</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">NAME</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">           TYPE</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">      AUTOCONNECT</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  AUTOCONNECT-PRIORITY</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">有线连接</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 1</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">     ethernet</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  是</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">           -999</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">                 </span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">Kwrt_5G</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">        wifi</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">      是</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">           0</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">                    </span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">tailscale0</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">     tun</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">       是</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">           0</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">                    </span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">lo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">             loopback</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  是</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">           0</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">                    </span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">Hotspot</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">        wifi</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">      否</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">           0</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">                    </span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">N100-Setup</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">     wifi</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">      否</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">           0</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">                    </span></span></code></pre>\n<h2 id=\"二-wifi-配置\"><a class=\"anchor\" href=\"#二-wifi-配置\">#</a> 二、WiFi 配置</h2>\n<h3 id=\"1-扫描-wifi-网络\"><a class=\"anchor\" href=\"#1-扫描-wifi-网络\">#</a> 1. 扫描 WiFi 网络</h3>\n<p>使用以下命令扫描并列出周围可用的 WiFi 网络。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">hao@archlinux </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">~</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">$ nmcli dev wifi list</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">IN-USE</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  BSSID</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">              SSID</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">                MODE</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">   CHAN</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  RATE</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">         SIGNAL</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  BARS</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  SECURITY</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">  </span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        80:AF:CA:C9:50:B3</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  Kwrt_2.4G</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">           Infra</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">  1</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">     130</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Mbit/s</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">   100</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">     ▂▄▆█</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  WPA2</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> WPA3</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> 82:AF:CA:C9:50:B4  Kwrt_5G             Infra  36    1170 Mbit/s  99      ▂▄▆█  WPA2 WPA3 </span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        4C:C6:4C:BE:77:10</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  Xiaomi_770F</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">         Infra</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">  11</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">    270</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Mbit/s</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">   79</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">      ▂▄▆_</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  WPA1</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> WPA2</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span></span>\n<span class=\"line\"><span style=\"color:#998418;--shiki-dark:#B8A965\">...</span></span></code></pre>\n<h3 id=\"2-连接-断开与删除-wifi\"><a class=\"anchor\" href=\"#2-连接-断开与删除-wifi\">#</a> 2. 连接、断开与删除 WiFi</h3>\n<h4 id=\"连接到-wifi\"><a class=\"anchor\" href=\"#连接到-wifi\">#</a> 连接到 WiFi</h4>\n<p>使用 <code>connect</code> 命令连接到指定的 WiFi 网络 (SSID)。连接成功后，NetworkManager 会自动创建一个同名的连接配置文件。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 格式: sudo nmcli device wifi connect &#x3C;SSID> password &#x3C;密码></span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> device</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> wifi</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connect</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Kwrt_5G</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> password</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 20542054</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> device</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> wifi</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connect</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 503</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> password</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 503503503</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> device</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> wifi</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connect</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 虚空终端</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> password</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 503503503</span></span></code></pre>\n<h4 id=\"设置为开机自动连接\"><a class=\"anchor\" href=\"#设置为开机自动连接\">#</a> 设置为开机自动连接</h4>\n<p>默认情况下，新连接会自动设为自动连接。如果需要手动修改：</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 格式: sudo nmcli connection modify &#x3C;连接名称> connection.autoconnect yes</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connection</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> modify</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Kwrt_5G</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connection.autoconnect</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> yes</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connection</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> modify</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 503</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connection.autoconnect</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> yes</span></span></code></pre>\n<h4 id=\"断开连接\"><a class=\"anchor\" href=\"#断开连接\">#</a> 断开连接</h4>\n<p>可以断开指定网卡（<code>device disconnect</code>）或断开某个连接配置（<code>connection down</code>）。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 方式一：断开指定连接配置</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connection</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> down</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Kwrt_5G</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 方式二：断开指定网卡</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> device</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> disconnect</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> wlan0</span></span></code></pre>\n<h4 id=\"删除配置\"><a class=\"anchor\" href=\"#删除配置\">#</a> 删除配置</h4>\n<p>永久删除（遗忘）指定名称的连接配置文件。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 格式: sudo nmcli connection delete &#x3C;连接名称></span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connection</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> delete</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Kwrt_5G</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connection</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> delete</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 虚空终端</span></span></code></pre>\n<h2 id=\"三-有线连接\"><a class=\"anchor\" href=\"#三-有线连接\">#</a> 三、有线连接</h2>\n<p>对于有线连接，如果网卡已插入网线，可以直接 <code>connect</code> 设备名。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 激活名为 enp6s0f3u2u4 的有线网卡</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> device</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connect</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> enp6s0f3u2u4</span></span></code></pre>\n<h2 id=\"四-设置静态-ip-地址\"><a class=\"anchor\" href=\"#四-设置静态-ip-地址\">#</a> 四、设置静态 IP 地址</h2>\n<p>在某些场景下（如将设备用作服务器或通过旁路由上网），需要将动态 IP (DHCP) 修改为静态 IP。</p>\n<h3 id=\"1-确定要修改的连接\"><a class=\"anchor\" href=\"#1-确定要修改的连接\">#</a> 1. 确定要修改的连接</h3>\n<p>首先，使用 <code>nmcli connection show</code> 找到需要修改的连接配置的名称 (<code>NAME</code>)。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connection</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> show</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># NAME                UUID                                  TYPE      DEVICE </span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 503                 82cbca27-7035-420a-96c0-f54aef5c5f83  wifi      wlan0  </span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 有线连接 1          xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx  ethernet  enp2s0</span></span></code></pre>\n<h3 id=\"2-修改连接为静态-ip\"><a class=\"anchor\" href=\"#2-修改连接为静态-ip\">#</a> 2. 修改连接为静态 IP</h3>\n<p>使用 <code>nmcli connection modify</code> 命令修改指定连接的网络参数。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 语法示例</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connection</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> modify</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">&#x3C;连接名称></span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    ipv4.method</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> manual</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    ipv4.addresses</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">IP地</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">址</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">/</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">子网掩码前</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">缀</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    ipv4.gateway</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">网关地</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">址</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    ipv4.dns</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">&#x3C;DNS服务器1>,&#x3C;DNS服务器2></span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 示例：将名为 \"503\" 的 WiFi 连接修改为静态IP</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connection</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> modify</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">503</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    ipv4.method</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> manual</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    ipv4.addresses</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 192.168.31.152/24</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    ipv4.gateway</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 192.168.31.141</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    ipv4.dns</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">223.5.5.5,114.114.114.114</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">    </span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 示例：将名为 \"有线连接 1\" 的有线连接修改为静态IP</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connection</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> modify</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">有线连接 1</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    ipv4.method</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> manual</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    ipv4.addresses</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 192.168.31.68/24</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    ipv4.gateway</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 192.168.31.141</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    ipv4.dns</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">223.5.5.5,114.114.114.114</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span></code></pre>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\"><strong>参数</strong></th>\n<th style=\"text-align:left\"><strong>说明</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\"><code>ipv4.method</code></td>\n<td style=\"text-align:left\"><code>manual</code> 表示静态 IP，<code>auto</code> 表示 DHCP。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><code>ipv4.addresses</code></td>\n<td style=\"text-align:left\">设置静态 IP 地址和子网掩码（使用 CIDR 表示法）。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><code>ipv4.gateway</code></td>\n<td style=\"text-align:left\">设置默认网关地址。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><code>ipv4.dns</code></td>\n<td style=\"text-align:left\">设置 DNS 服务器，多个服务器用逗号分隔。</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"3-应用更改\"><a class=\"anchor\" href=\"#3-应用更改\">#</a> 3. 应用更改</h3>\n<p>修改配置后，需要重新激活连接以使设置生效。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connection</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> down</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">503</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\"> &#x26;&#x26;</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connection</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> up</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">503</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connection</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> down</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">有线连接 1</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\"> &#x26;&#x26;</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connection</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> up</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">有线连接 1</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span></code></pre>\n<h3 id=\"4-恢复为-dhcp\"><a class=\"anchor\" href=\"#4-恢复为-dhcp\">#</a> 4. 恢复为 DHCP</h3>\n<p>如果需要从静态 IP 切换回动态 IP (DHCP)，只需将 <code>ipv4.method</code> 修改为 <code>auto</code> 并清空静态配置即可。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connection</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> modify</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">503</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> ipv4.method</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> auto</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 清空静态配置（可选但推荐）</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connection</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> modify</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">503</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> ipv4.addresses</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> ipv4.gateway</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> ipv4.dns</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"\"</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 重启连接</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connection</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> up</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">503</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span></code></pre>\n<h2 id=\"五-网络测试\"><a class=\"anchor\" href=\"#五-网络测试\">#</a> 五、网络测试</h2>\n<p>配置完成后，可以使用以下工具测试网络连通性。</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\"><strong>命令</strong></th>\n<th style=\"text-align:left\"><strong>用途</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\"><code>ping</code></td>\n<td style=\"text-align:left\">测试与目标主机（IP或域名）的基本连通性和延迟。 <code>ping 8.8.8.8</code></td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><code>ip addr</code></td>\n<td style=\"text-align:left\">查看网络接口的 IP 地址、MAC 地址等详细信息。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><code>iwconfig</code></td>\n<td style=\"text-align:left\">（旧工具）查看无线网卡的连接状态，如 SSID、信号强度 (Link Quality)、比特率 (Bit Rate) 等。</td>\n</tr>\n</tbody>\n</table>\n",
            "tags": [
                "环境配置&工具使用",
                "网络"
            ]
        },
        {
            "id": "https://soruan.github.io/2025/11/12/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE&%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/Tmux%E7%BB%88%E7%AB%AF%E5%A4%8D%E7%94%A8%E5%B7%A5%E5%85%B7/",
            "url": "https://soruan.github.io/2025/11/12/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE&%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/Tmux%E7%BB%88%E7%AB%AF%E5%A4%8D%E7%94%A8%E5%B7%A5%E5%85%B7/",
            "title": "Tmux终端复用工具",
            "date_published": "2025-11-12T07:30:04.000Z",
            "content_html": "<p><strong><code>tmux</code> (Terminal Multiplexer)</strong> 是一种终端复用器。它可以让你：</p>\n<ol>\n<li>在一个终端窗口中创建<strong>多个虚拟终端会话（Session）</strong>。</li>\n<li>即使 SSH 连接中断、直接关掉终端，<strong>服务器上的 <code>tmux</code> 会话及其中运行的程序（如编译、下载、服务）也会继续运行</strong>。</li>\n<li>可以随时从任何设备<strong>重新连接（Attach）</strong> 到这个会话。</li>\n</ol>\n<h3 id=\"tmux-基础命令和使用方式\"><a class=\"anchor\" href=\"#tmux-基础命令和使用方式\">#</a> 🚀 <code>tmux</code> 基础命令和使用方式</h3>\n<table>\n<thead>\n<tr>\n<th><strong>概念</strong></th>\n<th><strong>场景</strong></th>\n<th><strong>命令 (在 Shell 中输入)</strong></th>\n<th><strong>快捷键 (在 tmux 内部操作)</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>创建</strong></td>\n<td>开启一个新的会话。</td>\n<td><code>tmux new -s &lt;会话名&gt;</code></td>\n<td>N/A</td>\n</tr>\n<tr>\n<td><strong>创建并进入</strong></td>\n<td>如果不指定会话名，<code>tmux</code> 会自动创建一个会话并进入。</td>\n<td><code>tmux</code></td>\n<td>N/A</td>\n</tr>\n<tr>\n<td><strong>离开/分离</strong></td>\n<td>保持会话在后台运行，安全地离开终端。</td>\n<td>N/A</td>\n<td><code>Ctrl + b</code> 然后按 <code>d</code></td>\n</tr>\n<tr>\n<td><strong>查看会话</strong></td>\n<td>列出当前服务器上所有正在运行的会话。</td>\n<td><code>tmux ls</code> 或 <code>tmux attach</code></td>\n<td>N/A</td>\n</tr>\n<tr>\n<td><strong>重新连接</strong></td>\n<td>重新进入你离开的会话。</td>\n<td><code>tmux attach -t &lt;会话名&gt;</code></td>\n<td>N/A</td>\n</tr>\n<tr>\n<td><strong>关闭/停止</strong></td>\n<td>彻底杀死一个或多个会话。</td>\n<td><code>tmux kill-session -t &lt;会话名&gt;</code></td>\n<td>N/A</td>\n</tr>\n<tr>\n<td><strong>切换会话</strong></td>\n<td>在多个会话之间快速跳转。</td>\n<td>N/A</td>\n<td><code>Ctrl + b</code> 然后按 <code>s</code></td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"进阶窗格-panes-和窗口-windows\"><a class=\"anchor\" href=\"#进阶窗格-panes-和窗口-windows\">#</a> 💡 进阶：窗格 (Panes) 和窗口 (Windows)</h3>\n<p><code>tmux</code> 的强大之处在于它可以在一个会话中管理多个窗口和窗格：</p>\n<table>\n<thead>\n<tr>\n<th><strong>对象</strong></th>\n<th><strong>作用</strong></th>\n<th><strong>快捷键 (Ctrl + b 后按)</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>窗口</strong></td>\n<td>多个全屏虚拟终端（如桌面环境中的多个桌面）。</td>\n<td><code>c</code> (Create), <code>n</code> (Next), <code>p</code> (Previous)</td>\n</tr>\n<tr>\n<td><strong>窗格</strong></td>\n<td>将一个窗口分割成多个子区域（如 <code>htop</code> 在左边，代码在右边）。</td>\n<td><code>%</code> (垂直分割), <code>&quot;</code> (水平分割)</td>\n</tr>\n</tbody>\n</table>\n",
            "tags": [
                "环境配置&工具使用",
                "Tmux"
            ]
        },
        {
            "id": "https://soruan.github.io/2025/11/12/SBC/%E4%B8%80%E7%A7%8D%E5%9F%BA%E4%BA%8E%E8%BD%AFAP%E7%9A%84Linux%E8%AE%BE%E5%A4%87%E9%85%8D%E7%BD%91%E7%AD%96%E7%95%A5/",
            "url": "https://soruan.github.io/2025/11/12/SBC/%E4%B8%80%E7%A7%8D%E5%9F%BA%E4%BA%8E%E8%BD%AFAP%E7%9A%84Linux%E8%AE%BE%E5%A4%87%E9%85%8D%E7%BD%91%E7%AD%96%E7%95%A5/",
            "title": "一种基于软AP的Linux设备配网策略",
            "date_published": "2025-11-12T07:03:52.000Z",
            "content_html": "<h1 id=\"一种基于软ap的linux设备配网策略\"><a class=\"anchor\" href=\"#一种基于软ap的linux设备配网策略\">#</a> 一种基于软AP的Linux设备配网策略</h1>\n<h4 id=\"背景\"><a class=\"anchor\" href=\"#背景\">#</a> 背景</h4>\n<p>对于某些设备，比如物联网设备、机器人，本身不带屏幕键鼠，不方便进shell里操作，也没有桌面或者其他GUI可供配网，就可以用软AP策略来进行配网。完整的软AP策略可以让手机链接热点后进入一个web界面，本文章提供一种较为原始但简单的方案。</p>\n<p>当设备启动后检测不到网络链接，尝试链接已保存的Wi-Fi也不成功后，它会进入ap模式，提供一个热点供其他设备链接。其他设备链接后，就可以ssh进本设备，在shell里执行配网操作。</p>\n<p>本文章的具体思路基于systemd和networkmanager，其他情景思路大致相同。</p>\n<h3 id=\"一-创建ap热点连接配置文件\"><a class=\"anchor\" href=\"#一-创建ap热点连接配置文件\">#</a> 一、创建AP（热点）连接配置文件</h3>\n<p>我们将创建一个名为 <code>N100-Setup</code> 的AP。最关键的设置是 <code>autoconnect no</code>，因为我们不希望它在正常情况下（例如在家时）自动启动，我们只希望在脚本调用它时才启动。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 请将 'wlan0' 替换为实际的Wi-Fi设备名 (用 `nmcli dev` 查看)</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connection</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> add</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    type</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> wifi</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    ifname</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> wlan0</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    con-name</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">N100-Setup</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    autoconnect</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> no</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    ssid</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">N100-Setup</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    802-11-wireless.mode</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> ap</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    802-11-wireless.band</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> bg</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    ipv4.method</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> shared</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    ipv4.addresses</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 192.168.42.1/24</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    wifi-sec.key-mgmt</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> wpa-psk</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    wifi-sec.psk</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">YourPassword</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span></code></pre>\n<ul>\n<li><code>con-name &quot;N100-Setup&quot;</code>: 连接的名称。</li>\n<li><code>autoconnect no</code>: 我们只在需要时手动（通过脚本）启动它，所以设置为不允许自动链接。</li>\n<li><code>802-11-wireless.mode ap</code>: 将此接口设为AP（热点）模式。</li>\n<li><code>ipv4.method shared</code>: NM会自动为此连接启动一个DHCP服务器（在 <code>192.168.42.0/24</code> 网段）并处理NAT（如果N100未来有其他方式联网）。</li>\n<li><code>ipv4.addresses 192.168.42.1/24</code>: 定义AP的网关IP。其他设备连上后，会获取一个 <code>192.168.42.x</code> 的IP，而N100本身就是 <code>192.168.42.1</code>。</li>\n<li><code>wifi-sec.*</code>: 设置WPA2密码。</li>\n</ul>\n<hr />\n<h3 id=\"二-创建回落检查脚本\"><a class=\"anchor\" href=\"#二-创建回落检查脚本\">#</a> 二、创建回落检查脚本</h3>\n<p>我们将创建一个Shell脚本，由 <code>systemd</code> 定时调用。</p>\n<p><strong>创建脚本文件：</strong></p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> mkdir</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -p</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> /usr/local/bin</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> vim</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> /usr/local/bin/check-network-and-fallback.sh</span></span></code></pre>\n<p>存放以下内容</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">#!/bin/bash</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 脚本的目的是：检查NM是否处于\"完全连接\"状态。</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 如果不是，就启动AP回落热点。</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># NM状态码: 70 = 已连接 (全局)</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 详情: nmcli general status</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">#       STATE          CONNECTIVITY  WIFI-HW  WIFI     WWAN-HW  WWAN</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">#       connected      full          enabled  enabled  enabled  enabled</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># `nmcli -t -f STATE general` 的输出会是 \"connected\", \"connecting\", \"disconnected\"</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">if</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> nmcli</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -t</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -f</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> STATE</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> general</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> |</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> grep</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -q</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">^connected</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> then</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    # 状态是 \"connected\"，意味着我们已经连上了某个网络（有线或无线）。</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    # 任务完成，什么也不做。</span></span>\n<span class=\"line\"><span style=\"color:#998418;--shiki-dark:#B8A965\">    exit</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 0</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">else</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    # 状态不是 \"connected\" (可能是 'disconnected' 或 'connecting')</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    # 我们认为这是“在新环境”，需要启动AP。</span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">    </span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    # 使用 systemd-cat 将日志发送到 systemd-journal，方便排查</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    systemd-cat</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -t</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> ap-fallback</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> echo</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">No network detected. Activating AP fallback 'N100-Setup'.</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">    </span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    # 启动我们的AP连接</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    # (如果它已启动，此命令也无害)</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connection</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> up</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">N100-Setup</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fi</span></span></code></pre>\n<p><strong>使其可执行：</strong></p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> chmod</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> +x</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> /usr/local/bin/check-network-and-fallback.sh</span></span></code></pre>\n<hr />\n<h3 id=\"三-创建-systemd-服务和定时器\"><a class=\"anchor\" href=\"#三-创建-systemd-服务和定时器\">#</a> 三、创建 <code>systemd</code> 服务和定时器</h3>\n<p>我们需要两个 <code>systemd</code> 单元文件：一个 <code>.service</code> 文件来运行脚本，一个 <code>.timer</code> 文件来定时触发它。</p>\n<h4 id=\"1-创建-service-文件\"><a class=\"anchor\" href=\"#1-创建-service-文件\">#</a> 1. 创建 <code>.service</code> 文件</h4>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nano</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> /etc/systemd/system/ap-fallback.service</span></span></code></pre>\n<p>粘贴以下内容：</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-toml\"><span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#59873A;--shiki-dark:#80A665\">Unit</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">Description</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">A</span><span style=\"color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic\">ctivate AP mode fallback if no network is available</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 确保在NetworkManager准备就绪后才运行</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">After</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">N</span><span style=\"color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic\">etworkManager-wait-online.service</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#59873A;--shiki-dark:#80A665\">Service</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">Type</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">o</span><span style=\"color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic\">neshot</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">ExecStart</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">/</span><span style=\"color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic\">usr/local/bin/check-network-and-fallback.sh</span></span></code></pre>\n<h4 id=\"2-创建-timer-文件\"><a class=\"anchor\" href=\"#2-创建-timer-文件\">#</a> 2. 创建 <code>.timer</code> 文件</h4>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> vim</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> /etc/systemd/system/ap-fallback.timer</span></span></code></pre>\n<p>粘贴以下内容：</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">Unit</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">Description</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Run</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> AP</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> fallback</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> check</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 2</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> minutes</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> after</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> boot</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">Timer</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 在开机1分钟后执行</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">OnBootSec</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">1min</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 保持此设置，以便在系统休眠唤醒后也能正确触发</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">Persistent</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">true</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">Install</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">WantedBy</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">timers.target</span></span></code></pre>\n<p><strong>参数说明：</strong></p>\n<ul>\n<li><code>OnBootSec=2min</code>: 我们给N100和NetworkManager <strong>1分钟</strong>的时间去尝试连接所有它已知的Wi-Fi（比如你家里的）。如果1分钟后（由 <code>ap-fallback.service</code> 检查）它仍然没连上，就启动AP。</li>\n</ul>\n<hr />\n<h3 id=\"四-启用并启动服务\"><a class=\"anchor\" href=\"#四-启用并启动服务\">#</a> 四、启用并启动服务</h3>\n<ol>\n<li>\n<p><strong>重新加载 systemd daemon：</strong></p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> systemctl</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> daemon-reload</span></span></code></pre>\n</li>\n<li>\n<p><strong>启用并立即启动定时器：</strong></p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> systemctl</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> enable</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> --now</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> ap-fallback.timer</span></span></code></pre>\n</li>\n<li>\n<p><strong>检查定时器状态：</strong></p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">systemctl</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> list-timers</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> |</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> grep</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> ap-fallback</span></span></code></pre>\n<p>应该能看到 <code>ap-fallback.timer</code> 和 <code>ap-fallback.service</code> 的条目。</p>\n</li>\n</ol>\n<hr />\n<h3 id=\"五-在新环境中的工作流程\"><a class=\"anchor\" href=\"#五-在新环境中的工作流程\">#</a> 五、在新环境中的工作流程</h3>\n<ol>\n<li>\n<p>给设备通电启动。</p>\n</li>\n<li>\n<p>设备启动后，<code>ap-fallback.timer</code> 开始计时。NetworkManager会尝试连接它所有已知的、<code>autoconnect yes</code> 的Wi-Fi网络。</p>\n</li>\n<li>\n<p>在1分钟的等待时间内，所有尝试都失败了（因为在新环境）。</p>\n</li>\n<li>\n<p>1分钟后，<code>ap-fallback.timer</code> 触发 <code>ap-fallback.service</code>。</p>\n</li>\n<li>\n<p><code>check-network-and-fallback.sh</code> 脚本运行。它通过 <code>nmcli general status</code> 发现状态是 <code>disconnected</code>。</p>\n</li>\n<li>\n<p>脚本执行 <code>nmcli connection up &quot;N100-Setup&quot;</code>。</p>\n</li>\n<li>\n<p>设备开始广播一个名为 <strong>&quot;N100-Setup&quot;</strong> 的Wi-Fi热点。</p>\n</li>\n<li>\n<p>其他设备连接到这个 &quot;N100-Setup&quot; Wi-Fi。</p>\n</li>\n<li>\n<p>连接成功后，终端，SSH登入设备的固定IP：</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">ssh</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> hao@192.168.42.1</span></span></code></pre>\n</li>\n<li>\n<p>在设备的Shell中，你运行 <code>nmcli</code> 来扫描并连接到<em>新环境</em>的Wi-Fi：</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 1. 添加一个新连接。这个命令*不会*尝试立即连接，它只是创建配置文件。</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connection</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> add</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    type</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> wifi</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    con-name</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Kwrt_5G</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    ifname</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> wlan0</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    ssid</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Kwrt_5G</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 2. 为这个新连接设置密码</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connection</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> modify</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Kwrt_5G</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    wifi-sec.key-mgmt</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> wpa-psk</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#B56959;--shiki-dark:#C98A7D\">    wifi-sec.psk</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">20542054</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 3. 确保这个新连接会自动连接</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connection</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> modify</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Kwrt_5G</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connection.autoconnect</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> yes</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 4. 主动断开AP</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 这个命令会立即关闭 N100-Setup AP</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nmcli</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> connection</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> down</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">N100-Setup</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span></code></pre>\n</li>\n<li>\n<p>当设备成功连接到新环境的Wi-Fi后，<code>nmcli general status</code> 就会变为 <code>connected</code>。</p>\n</li>\n<li>\n<p>下次启动时，<code>check-network-and-fallback.sh</code> 脚本会在2分钟后运行，但它会检测到状态是 <code>connected</code>（因为连上了新环境的Wi-Fi），因此它<strong>不会</strong>再启动AP热点。</p>\n</li>\n</ol>\n",
            "tags": [
                "SBC",
                "网络"
            ]
        },
        {
            "id": "https://soruan.github.io/2025/11/01/Programming/Rust/Rust%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/",
            "url": "https://soruan.github.io/2025/11/01/Programming/Rust/Rust%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/",
            "title": "Rust生命周期",
            "date_published": "2025-11-01T15:24:54.000Z",
            "content_html": "<h1 id=\"rust-生命周期-lifetime\"><a class=\"anchor\" href=\"#rust-生命周期-lifetime\">#</a> Rust 生命周期 (Lifetime)</h1>\n<p>Rust 中的每一个引用都有其生命周期（lifetime），也就是引用保持有效的作用域。大部分时候，生命周期是隐式且可以被推断的，类似于类型推断。然而，当引用的生命周期可能以多种方式互相关联时，Rust 会要求我们使用泛型生命周期参数来手动标注生命周期，以确保运行时不会出现悬垂引用。</p>\n<hr />\n<h2 id=\"借用检查器与生命周期\"><a class=\"anchor\" href=\"#借用检查器与生命周期\">#</a> 借用检查器与生命周期</h2>\n<p>生命周期的主要目标是避免悬垂引用，它会导致程序引用了非预期引用的数据。</p>\n<p>考虑一个返回两个字符串切片中较长者的函数。下面的代码无法通过编译，因为 Rust 编译器无法在编译期知道返回的引用指向 <code>x</code> 还是 <code>y</code>，因此无法确定其生命周期。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 无法编译：返回的引用的生命周期不明确</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// fn longest(x: &#x26;str, y: &#x26;str) -> &#x26;str &#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">//     if x.len() > y.len() &#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">//         x</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">//     &#125; else &#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">//         y</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">//     &#125;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// &#125;</span></span></code></pre>\n<blockquote>\n<p>错误信息：missing lifetime specifier</p>\n<p>这个错误表明，编译器需要我们明确告知返回的引用的生命周期与输入参数的生命周期之间的关系。</p>\n</blockquote>\n<hr />\n<h2 id=\"泛型生命周期注解\"><a class=\"anchor\" href=\"#泛型生命周期注解\">#</a> 泛型生命周期注解</h2>\n<p>为了解决上述问题，我们需要为函数签名添加泛型生命周期参数。生命周期注解不会改变任何引用的生命周期，而是描述多个引用生命周期之间的关系。</p>\n<ul>\n<li>生命周期参数以撇号（<code>'</code>）开头，名称通常是小写字母，如 <code>'a</code>。</li>\n<li><code>&amp;'a str</code> 读作 “一个至少活得和生命周期 <code>'a</code> 一样长的字符串切片引用”。</li>\n</ul>\n<p>通过添加泛型生命周期 <code>'a</code>，我们告诉编译器：输入参数 <code>x</code>、<code>y</code> 和返回的引用必须拥有相同的生命周期（即它们中生命周期最短的那个）。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 添加泛型生命周期参数'a，表示返回值的生命周期与输入参数中生命周期较短的一个相同</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> longest_with_lifetime</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#999999;--shiki-dark:#666666\">'</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">a</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">x</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;</span><span style=\"color:#999999;--shiki-dark:#666666\">'</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">a</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> str</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> y</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;</span><span style=\"color:#999999;--shiki-dark:#666666\">'</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">a</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> str</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;</span><span style=\"color:#999999;--shiki-dark:#666666\">'</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">a</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> str</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    if</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> x</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">len</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> y</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">len</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> x</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> else</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> y</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<p>在下面的 <code>main</code> 函数示例中，<code>string1</code> 的生命周期比 <code>string2</code> 长。当它们被传入 <code>longest_with_lifetime</code> 时，<code>'a</code> 的具体生命周期将等于 <code>string2</code> 的生命周期。因此，返回的 <code>result</code> 的生命周期也与 <code>string2</code> 相同。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> main</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> string1</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">abcd</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">        let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> string2</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">xyz</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">        let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> result</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> longest_with_lifetime</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">string1</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">as_str</span><span style=\"color:#a13865;--shiki-dark:#d9739f\">(</span><span style=\"color:#a13865;--shiki-dark:#d9739f\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> string2</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">as_str</span><span style=\"color:#a13865;--shiki-dark:#d9739f\">(</span><span style=\"color:#a13865;--shiki-dark:#d9739f\">)</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        println!</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">The longest string is </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> result</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // string2 在这里失效，result 的生命周期也到此结束</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<hr />\n<h2 id=\"结构体定义中的生命周期注解\"><a class=\"anchor\" href=\"#结构体定义中的生命周期注解\">#</a> 结构体定义中的生命周期注解</h2>\n<p>当结构体持有引用时，我们也必须在其定义中添加生命周期注解。这保证了该结构体的实例存活时间不会超过其包含的引用的存活时间。</p>\n<p><code>ImportantExcerpt</code> 结构体持有一个字符串切片 <code>part</code>。其定义中的生命周期注解 <code>'a</code> 表明，<code>ImportantExcerpt</code> 的实例不能比它所引用的 <code>part</code> 活得更久。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// Struct 中使用生命周期注解</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 指明 ImportantExcerpt 实例的生命周期不能超过 part 引用的生命周期</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">struct</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> ImportantExcerpt</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#999999;--shiki-dark:#666666\">'</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">a</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">    part</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;</span><span style=\"color:#999999;--shiki-dark:#666666\">'</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">a</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> str</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> main</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> novel</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Call me Ishmael. Some years ago...</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> first_sentence</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> novel</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">split</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#999999;--shiki-dark:#666666\">'</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">.</span><span style=\"color:#999999;--shiki-dark:#666666\">'</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">next</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">unwrap</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> i</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> ImportantExcerpt</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">        part</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> first_sentence</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<hr />\n<h2 id=\"生命周期省略规则lifetime-elision-rules\"><a class=\"anchor\" href=\"#生命周期省略规则lifetime-elision-rules\">#</a> 生命周期省略规则（Lifetime Elision Rules）</h2>\n<p>在实践中，为了方便，编译器内置了一套生命周期省略规则。如果代码符合这些规则，我们就不需要显式地标注生命周期。这些规则不是让编译器猜测，而是遵循一套明确的算法。</p>\n<p>首先，定义两个术语：</p>\n<ul>\n<li><strong>输入生命周期</strong>：函数或方法参数上的生命周期。</li>\n<li><strong>输出生命周期</strong>：函数或方法返回值上的生命周期。</li>\n</ul>\n<p>编译器使用以下三条规则来推断生命周期：</p>\n<table>\n<thead>\n<tr>\n<th><strong>规则</strong></th>\n<th><strong>描述</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>规则 1</strong></td>\n<td>编译器为每个输入引用（函数或方法的参数）分配一个不同的生命周期参数。</td>\n</tr>\n<tr>\n<td><strong>规则 2</strong></td>\n<td>如果只有一个输入生命周期参数，那么该生命周期会被赋给所有输出生命周期参数。</td>\n</tr>\n<tr>\n<td><strong>规则 3</strong></td>\n<td>如果有多个输入生命周期参数，但其中一个是 <code>&amp;self</code> 或 <code>&amp;mut self</code>，那么 <code>self</code> 的生命周期会被赋给所有输出生命周期参数。</td>\n</tr>\n</tbody>\n</table>\n<p>如果编译器应用完这三条规则后，仍然无法确定所有输出引用的生命周期，就会报错并要求手动标注。</p>\n<hr />\n<h2 id=\"方法定义中的生命周期\"><a class=\"anchor\" href=\"#方法定义中的生命周期\">#</a> 方法定义中的生命周期</h2>\n<p>在为带有生命周期的结构体实现方法时，其语法与泛型类型参数相似。</p>\n<ul>\n<li>需要在 <code>impl</code> 关键字后声明生命周期参数 <code>'a</code>。</li>\n<li>这些生命周期参数是 <code>ImportantExcerpt</code> 类型的一部分。</li>\n</ul>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">impl</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#999999;--shiki-dark:#666666\">'</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">a</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> ImportantExcerpt</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#999999;--shiki-dark:#666666\">'</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">a</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 规则 3 适用：输入生命周期是 &#x26;'a self，所以输出生命周期也被推断为 'a</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 因此 &#x26;self 和返回的 &#x26;str 拥有相同的生命周期</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> announce_and_return_part</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> announcement</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">str</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">str</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        println!</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Attention please: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> announcement</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#A65E2B;--shiki-dark:#C99076\">        self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">part</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<p>由于生命周期省略规则（特别是第三条），<code>announce_and_return_part</code> 方法不需要显式标注生命周期。</p>\n<hr />\n<h2 id=\"静态生命周期-static\"><a class=\"anchor\" href=\"#静态生命周期-static\">#</a> 静态生命周期 (<code>'static</code>)</h2>\n<p><code>'static</code> 是一个特殊的生命周期，它表示引用在整个程序的运行期间都有效。所有的字符串字面量都拥有 <code>'static</code> 生命周期，因为它们被直接存储在程序的二进制文件中。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> s</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;</span><span style=\"color:#999999;--shiki-dark:#666666\">'</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">static</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> str</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">I have a static lifetime.</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span></code></pre>\n<h2 id=\"泛型-trait-bound-与生命周期的结合\"><a class=\"anchor\" href=\"#泛型-trait-bound-与生命周期的结合\">#</a> 泛型、Trait Bound 与生命周期的结合</h2>\n<p>我们可以在一个函数签名中同时使用泛型类型参数、Trait Bound 和生命周期，以创建更灵活和强大的函数。</p>\n<p>下面的函数 <code>longest_with_an_announcement</code> 综合了这些概念：</p>\n<ul>\n<li><code>'a</code>：泛型生命周期参数，确保引用的有效性。</li>\n<li><code>T</code>：泛型类型参数。</li>\n<li><code>where T: Display</code>：Trait Bound 约束，要求类型 <code>T</code> 必须实现 <code>Display</code> trait，以便能被打印。</li>\n</ul>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">use</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">fmt</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Display</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> longest_with_an_announcement</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#999999;--shiki-dark:#666666\">'</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">a</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> T</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">x</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;</span><span style=\"color:#999999;--shiki-dark:#666666\">'</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">a</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> str</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> y</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;</span><span style=\"color:#999999;--shiki-dark:#666666\">'</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">a</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> str</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> ann</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> T</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;</span><span style=\"color:#999999;--shiki-dark:#666666\">'</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">a</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> str</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">where</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">    T</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Display</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // Trait bound约束</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    println!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Announcement! </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> ann</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    if</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> x</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">len</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> y</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">len</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">        x</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> else</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">        y</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n",
            "tags": [
                "Programming",
                "Rust"
            ]
        },
        {
            "id": "https://soruan.github.io/2025/11/01/Programming/Rust/Rust%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88/",
            "url": "https://soruan.github.io/2025/11/01/Programming/Rust/Rust%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88/",
            "title": "Rust智能指针",
            "date_published": "2025-11-01T15:24:39.000Z",
            "content_html": "<h1 id=\"智能指针\"><a class=\"anchor\" href=\"#智能指针\">#</a> 智能指针</h1>\n<p>智能指针（Smart Pointers）是类似指针的数据结构，但它们具有额外的元数据和功能。与引用（<code>&amp;</code>）不同，引用仅借用数据，而智能指针通常拥有它们指向的数据。</p>\n<p>常见的智能指针包括：</p>\n<ul>\n<li><code>Box&lt;T&gt;</code></li>\n<li><code>Rc&lt;T&gt;</code></li>\n<li><code>RefCell&lt;T&gt;</code></li>\n<li><code>Ref&lt;T&gt;</code></li>\n<li><code>Mutex&lt;T&gt;</code></li>\n<li><code>Arc&lt;T&gt;</code></li>\n</ul>\n<hr />\n<h3 id=\"1-boxt在堆上分配数据\"><a class=\"anchor\" href=\"#1-boxt在堆上分配数据\">#</a> 1. <code>Box&lt;T&gt;</code>：在堆上分配数据</h3>\n<p><code>Box&lt;T&gt;</code> 智能指针用于将数据存储在堆（Heap）上，而不是栈（Stack）上。它提供了数据的所有权，并在 <code>Box&lt;T&gt;</code> 离开作用域时自动释放堆上的数据。留在栈中的只是指向堆数据的指针。</p>\n<p><code>Box&lt;T&gt;</code> 的一个常见用途是构建递归数据结构（如链表），因为它可以帮助 Rust 确定结构的大小。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 示例：使用 Box 构建递归的 List</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">enum</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> List</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    Cons</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">i32</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Box</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">List</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">    Nil</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> main_box</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // b 在栈上，但值 5 在堆上</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> b</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Box</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">new</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">5</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    println!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Boxed value: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> b</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> x</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 5</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 将 x 的值（5）复制到堆上</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> y</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Box</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">new</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">x</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    assert_eq!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">5</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> x</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 使用 * 解引用操作符来访问堆上的数据</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    assert_eq!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">5</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> *</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">y</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<hr />\n<h3 id=\"2-deref-trait自定义解引用行为\"><a class=\"anchor\" href=\"#2-deref-trait自定义解引用行为\">#</a> 2. <code>Deref</code> Trait：自定义解引用行为</h3>\n<p><code>Deref</code> Trait 允许我们自定义解引用操作符（<code>*</code>）的行为，使其能够像常规指针一样被解引用。</p>\n<p>实现 <code>Deref</code> Trait 只需要实现 <code>deref</code> 方法：</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">use</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">ops</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Deref</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 自定义一个类似 Box 的结构</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">struct</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> MyBox</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">T</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">T</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">impl</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">T</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> MyBox</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">T</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> new</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">x</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> T</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> MyBox</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">T</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        MyBox</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">x</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 为 MyBox 实现 Deref</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">impl</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">T</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Deref</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> for</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> MyBox</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">T</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    type</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Target</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> T</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> deref</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">Self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Target</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">        // 返回元组结构中的第一个元素 (T) 的引用</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">        &#x26;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">0</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<h4 id=\"deref-强制转换-deref-coercion\"><a class=\"anchor\" href=\"#deref-强制转换-deref-coercion\">#</a> Deref 强制转换 (Deref Coercion)</h4>\n<p>Deref Coercion（解引用强制转换）是 Rust 的一项便利特性。如果一个类型 <code>A</code> 实现了 <code>Deref&lt;Target = B&gt;</code>，那么 Rust 会在需要时自动将 <code>&amp;A</code> 转换为 <code>&amp;B</code>。</p>\n<ul>\n<li>例如：<code>String</code> 实现了 <code>Deref&lt;Target = str&gt;</code>，所以 <code>&amp;String</code> 可以自动转换（强制转换）为 <code>&amp;str</code>。</li>\n</ul>\n<p>这同样适用于我们自定义的 <code>MyBox&lt;T&gt;</code>：</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// (接上文 MyBox 的定义)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> hello</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">name</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">str</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    println!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Hello, </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">!</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> name</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> main_deref_coercion</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> m</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> MyBox</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">new</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#59873A;--shiki-dark:#80A665\">String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Rust</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // Rust 自动执行了 &#x26;MyBox&#x3C;String> -> &#x26;String -> &#x26;str</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    hello</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">m</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<hr />\n<h3 id=\"3-drop-trait自定义清理逻辑\"><a class=\"anchor\" href=\"#3-drop-trait自定义清理逻辑\">#</a> 3. <code>Drop</code> Trait：自定义清理逻辑</h3>\n<p><code>Drop</code> Trait 允许我们在值离开作用域时，自定义需要执行的清理逻辑（类似于其他语言的析构函数）。</p>\n<p>实现 <code>Drop</code> Trait 只需要实现 <code>drop</code> 方法：</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">struct</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> CustomSmartPointer</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">    data</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">impl</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Drop</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> for</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> CustomSmartPointer</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> drop</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;mut</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">        // 定义清理逻辑</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        println!</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Dropping CustomSmartPointer with data `</span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">`!</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">data</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> main_drop</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> c</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> CustomSmartPointer</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">        data</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">my stuff</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> d</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> CustomSmartPointer</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">        data</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">other stuff</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    println!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">CustomSmartPointers created.</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 当 main 结束时，变量会按其入栈顺序的逆序被 Drop</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // d 先被 drop，然后 c 被 drop</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<h4 id=\"提前释放资源-stdmemdrop\"><a class=\"anchor\" href=\"#提前释放资源-stdmemdrop\">#</a> 提前释放资源 <code>std::mem::drop</code></h4>\n<p>我们不能手动调用 <code>drop</code> 方法（例如 <code>c.drop()</code>）。如果需要提前释放资源，必须使用标准库提供的 <code>std::mem::drop</code> 函数。</p>\n<p><code>std::mem::drop</code> 会接管值的所有权，并在该函数结束时自动调用其 <code>Drop::drop</code> 方法，这可以防止双重释放（Double Free）错误。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// (接上文 CustomSmartPointer 的定义)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> main_mem_drop</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> c</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> CustomSmartPointer</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">        data</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">my stuff</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    println!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">CustomSmartPointer c created.</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">    </span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 提前释放 c</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    std</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">mem</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">drop</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">c</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">    </span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    println!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">CustomSmartPointer c dropped before end of main.</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<hr />\n<h3 id=\"4-rct引用计数\"><a class=\"anchor\" href=\"#4-rct引用计数\">#</a> 4. <code>Rc&lt;T&gt;</code>：引用计数</h3>\n<p><code>Rc&lt;T&gt;</code> (Reference Counting) 是一种引用计数智能指针，它允许多个所有者（Multiple Ownership）共同拥有同一份堆上的数据。</p>\n<ul>\n<li>它会跟踪指向数据的引用数量。</li>\n<li>只有当引用计数归零时，数据才会被清理。</li>\n<li><code>Rc&lt;T&gt;</code> <strong>只可用于单线程场景</strong>。</li>\n</ul>\n<hr />\n<h3 id=\"5-refcellt-与内部可变性\"><a class=\"anchor\" href=\"#5-refcellt-与内部可变性\">#</a> 5. <code>RefCell&lt;T&gt;</code> 与内部可变性</h3>\n<p><code>RefCell&lt;T&gt;</code> (Reference Cell) 提供了一种实现<strong>内部可变性</strong>（Interior Mutability）的模式。它允许我们在持有不可变引用（<code>&amp;T</code>）的情况下，仍然能够修改内部的数据。</p>\n<ul>\n<li><code>RefCell&lt;T&gt;</code> <strong>只适用于单线程场景</strong>。</li>\n<li>它并不会绕过 Rust 的借用规则，而是将借用规则的检查从<strong>编译时</strong>推迟到<strong>运行时</strong>。</li>\n<li>通过 <code>borrow()</code> (获取不可变引用) 和 <code>borrow_mut()</code> (获取可变引用) 方法在运行时检查借用规则。</li>\n<li>如果违反了借用规则（例如，同时存在多个可变借用），程序将在运行时 <code>panic</code>。</li>\n</ul>\n<h4 id=\"实践示例refcellt-用于模拟mocking\"><a class=\"anchor\" href=\"#实践示例refcellt-用于模拟mocking\">#</a> 实践示例：<code>RefCell&lt;T&gt;</code> 用于模拟（Mocking）</h4>\n<p>在测试中，我们经常需要一个“模拟对象”（Mock Object）来记录其上发生了哪些调用。</p>\n<p>在下面的例子中，<code>MockMessenger</code> 需要在 <code>send</code> 方法（该方法只接收 <code>&amp;self</code>，即不可变引用）内部修改 <code>sent_messages</code> 向量。<code>RefCell</code> 使得这种内部可变性成为可能。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">pub</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> trait</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Messenger</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // send 方法接收的是不可变引用</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> send</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> msg</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">str</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">pub</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> struct</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> LimitTracker</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#999999;--shiki-dark:#666666\">'</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">a</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> T</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Messenger</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">    messenger</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;</span><span style=\"color:#999999;--shiki-dark:#666666\">'</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">a</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> T</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">    value</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> usize</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">    max</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> usize</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">impl</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#999999;--shiki-dark:#666666\">'</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">a</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> T</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> LimitTracker</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#999999;--shiki-dark:#666666\">'</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">a</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> T</span><span style=\"color:#999999;--shiki-dark:#666666\">></span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">where</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">    T</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Messenger</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    pub</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> new</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">messenger</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;</span><span style=\"color:#999999;--shiki-dark:#666666\">'</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">a</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> T</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> max</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> usize</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> LimitTracker</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#999999;--shiki-dark:#666666\">'</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">a</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> T</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">        LimitTracker</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">            messenger</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">            value</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 0</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">            max</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">        </span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    pub</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> set_value</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;mut</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> value</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> usize</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A65E2B;--shiki-dark:#C99076\">        self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">value </span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> value</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">        let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> percentage_of_max</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">value </span><span style=\"color:#1E754F;--shiki-dark:#4D9375\">as</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> f64</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> /</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">max </span><span style=\"color:#1E754F;--shiki-dark:#4D9375\">as</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> f64</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">        if</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> percentage_of_max</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">=</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 1</span><span style=\"color:#999999;--shiki-dark:#666666\">.</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">0</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A65E2B;--shiki-dark:#C99076\">            self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">messenger</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">send</span><span style=\"color:#a13865;--shiki-dark:#d9739f\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Error: You are over your quota!</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#a13865;--shiki-dark:#d9739f\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">        </span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">&#125;</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> else</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> if</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> percentage_of_max</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">=</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 0</span><span style=\"color:#999999;--shiki-dark:#666666\">.</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">9</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A65E2B;--shiki-dark:#C99076\">            self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">messenger</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">                .</span><span style=\"color:#59873A;--shiki-dark:#80A665\">send</span><span style=\"color:#a13865;--shiki-dark:#d9739f\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Urgent warning: You've used up over 90% of your quota!</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#a13865;--shiki-dark:#d9739f\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">        </span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">&#125;</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> else</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> if</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> percentage_of_max</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">=</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 0</span><span style=\"color:#999999;--shiki-dark:#666666\">.</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">75</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A65E2B;--shiki-dark:#C99076\">            self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">messenger</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">                .</span><span style=\"color:#59873A;--shiki-dark:#80A665\">send</span><span style=\"color:#a13865;--shiki-dark:#d9739f\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Warning: You've used up over 75% of your quota!</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#a13865;--shiki-dark:#d9739f\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">        </span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// --- 测试模块 ---</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">#</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">cfg</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">test</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">mod</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> tests</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    use</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> super</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::*</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    use</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">cell</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">RefCell</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    struct</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> MockMessenger</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">        // 使用 RefCell 包装需要“内部可变”的数据</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">        sent_messages</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> RefCell</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Vec</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">String</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    impl</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> MockMessenger</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">        fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> new</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> MockMessenger</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">            MockMessenger</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#a13865;--shiki-dark:#d9739f\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">                sent_messages</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> RefCell</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">new</span><span style=\"color:#bda437;--shiki-dark:#e6cc77\">(</span><span style=\"color:#59873A;--shiki-dark:#80A665\">vec!</span><span style=\"color:#296aa3;--shiki-dark:#6394bf\">[</span><span style=\"color:#296aa3;--shiki-dark:#6394bf\">]</span><span style=\"color:#bda437;--shiki-dark:#e6cc77\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">            </span><span style=\"color:#a13865;--shiki-dark:#d9739f\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">        </span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    impl</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Messenger</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> for</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> MockMessenger</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">        // 尽管 send 接收的是 &#x26;self，我们依然可以修改内部数据</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">        fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> send</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> msg</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">str</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">            // 1. borrow_mut() 在运行时获取可变引用</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">            // 2. 如果违反借用规则（比如已存在其他借用），这里会 panic</span></span>\n<span class=\"line\"><span style=\"color:#A65E2B;--shiki-dark:#C99076\">            self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">sent_messages</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">borrow_mut</span><span style=\"color:#a13865;--shiki-dark:#d9739f\">(</span><span style=\"color:#a13865;--shiki-dark:#d9739f\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">push</span><span style=\"color:#a13865;--shiki-dark:#d9739f\">(</span><span style=\"color:#59873A;--shiki-dark:#80A665\">String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#bda437;--shiki-dark:#e6cc77\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">msg</span><span style=\"color:#bda437;--shiki-dark:#e6cc77\">)</span><span style=\"color:#a13865;--shiki-dark:#d9739f\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">        </span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    #</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">[</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">test</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">]</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> it_sends_over_75_percent_warning_message</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">        let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> mock_messenger</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> MockMessenger</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">new</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">        let</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> mut</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> limit_tracker</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> LimitTracker</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">new</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">mock_messenger</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 100</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">        limit_tracker</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">set_value</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">80</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">        // 3. borrow() 在运行时获取不可变引用</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        assert_eq!</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">mock_messenger</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">sent_messages</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">borrow</span><span style=\"color:#a13865;--shiki-dark:#d9739f\">(</span><span style=\"color:#a13865;--shiki-dark:#d9739f\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">len</span><span style=\"color:#a13865;--shiki-dark:#d9739f\">(</span><span style=\"color:#a13865;--shiki-dark:#d9739f\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 1</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n",
            "tags": [
                "Programming",
                "Rust"
            ]
        },
        {
            "id": "https://soruan.github.io/2025/11/01/Programming/Rust/Rust%E8%BF%AD%E4%BB%A3%E5%99%A8/",
            "url": "https://soruan.github.io/2025/11/01/Programming/Rust/Rust%E8%BF%AD%E4%BB%A3%E5%99%A8/",
            "title": "Rust迭代器",
            "date_published": "2025-11-01T15:24:21.000Z",
            "content_html": "<h1 id=\"rust-迭代器-iterators\"><a class=\"anchor\" href=\"#rust-迭代器-iterators\">#</a> Rust 迭代器 (Iterators)</h1>\n<p>Rust 的迭代器（Iterator）允许我们对一个序列（如 <code>Vec</code>）中的每个项依次执行某些操作。</p>\n<p>迭代器一个核心特性是<strong>惰性 (Lazy)</strong>：在调用“消耗性”方法（consuming methods）来驱动迭代器之前，迭代器本身不会执行任何操作。</p>\n<h3 id=\"1-创建和使用迭代器\"><a class=\"anchor\" href=\"#1-创建和使用迭代器\">#</a> 1. 创建和使用迭代器</h3>\n<p>可以通过在集合（如 <code>Vec</code>）上调用 <code>iter()</code> 方法来创建一个迭代器。<code>for</code> 循环是使用迭代器最常见的方式之一。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> main</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> v1</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> vec!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">[</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 2</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 3</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 4</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 5</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">]</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // v1.iter() 创建了一个迭代器</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> v1_iter</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> v1</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">iter</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // for 循环会获取迭代器的所有权并自动调用 next()</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    for</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> val</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> in</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> v1_iter</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">         // 因为 .iter() 产生的是不可变引用，所以 val 的类型是 &#x26;i32</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        println!</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Got: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> val</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<h3 id=\"2-iterator-trait-与-next-方法\"><a class=\"anchor\" href=\"#2-iterator-trait-与-next-方法\">#</a> 2. Iterator Trait 与 next 方法</h3>\n<p>所有的迭代器都实现了标准库中的 <code>Iterator</code> Trait。这个 Trait 的核心是 <code>next</code> 方法。</p>\n<ul>\n<li><code>next()</code> 方法：\n<ul>\n<li>每次调用 <code>next</code> 时，它会返回迭代器中的下一项，并将其包装在 <code>Some(T)</code> 中。</li>\n<li>当迭代器耗尽时，它会返回 <code>None</code>。</li>\n</ul>\n</li>\n<li><code>next()</code> 方法会消耗（推进）迭代器的状态，因此如果手动调用 <code>next</code>，迭代器变量必须是可变的（<code>mut</code>）。</li>\n<li><code>for</code> 循环会自动处理迭代器的可变性。</li>\n</ul>\n<p>&lt;!-- end list --&gt;</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">#</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">test</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> iterator_demonstration</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> v1</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> vec!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">[</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 2</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 3</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 4</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 5</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">]</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 当手动调用 next() 时，必须将迭代器声明为 mut</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> mut</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> v1_iter</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> v1</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">iter</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // next() 返回的是 Option&#x3C;&#x26;T></span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    assert_eq!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">v1_iter</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">next</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Some</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    assert_eq!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">v1_iter</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">next</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Some</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">2</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    assert_eq!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">v1_iter</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">next</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Some</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">3</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    assert_eq!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">v1_iter</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">next</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Some</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">4</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    assert_eq!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">v1_iter</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">next</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Some</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">5</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    assert_eq!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">v1_iter</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">next</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> None</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<h3 id=\"3-迭代器种类-iter-iter_mut-into_iter\"><a class=\"anchor\" href=\"#3-迭代器种类-iter-iter_mut-into_iter\">#</a> 3. 迭代器种类 (iter, iter_mut, into_iter)</h3>\n<p>根据创建方式的不同，迭代器可以产生不同类型的项：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">方法</th>\n<th style=\"text-align:left\">返回的项</th>\n<th style=\"text-align:left\">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\"><code>iter()</code></td>\n<td style=\"text-align:left\"><code>&amp;T</code></td>\n<td style=\"text-align:left\">创建一个返回不可变引用的迭代器。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><code>iter_mut()</code></td>\n<td style=\"text-align:left\"><code>&amp;mut T</code></td>\n<td style=\"text-align:left\">创建一个返回可变引用的迭代器。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><code>into_iter()</code></td>\n<td style=\"text-align:left\"><code>T</code></td>\n<td style=\"text-align:left\">创建一个获取集合所有权的迭代器，返回项本身（<code>T</code>）。</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"4-消耗性适配器-consuming-adapters\"><a class=\"anchor\" href=\"#4-消耗性适配器-consuming-adapters\">#</a> 4. 消耗性适配器 (Consuming Adapters)</h3>\n<p>消耗性适配器（Consuming Adapters）是迭代器上的方法，它们会调用 <code>next</code> 来驱动迭代器，并最终消耗（使用掉）它。</p>\n<p><code>next</code> 方法本身就是一个消耗性适配器。</p>\n<p><strong>示例：<code>sum</code></strong><br />\n<code>sum</code> 方法会获取迭代器的所有权，遍历所有元素并计算总和。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">#</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">test</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> iterator_sum</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> v1</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> vec!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">[</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 2</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 3</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 4</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 5</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">]</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> v1_iter</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> v1</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">iter</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // sum() 会获取 v1_iter 的所有权并消耗它</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> total</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> i32</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> v1_iter</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">sum</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 调用 sum 之后，v1_iter 不能再被使用</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    assert_eq!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">total</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 15</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<p><strong>示例：<code>collect</code></strong><br />\n<code>collect</code> 方法会消耗迭代器，并将结果收集到一个新的集合中（如下文 <code>map</code> 示例所示）。</p>\n<h3 id=\"5-迭代器适配器-iterator-adapters\"><a class=\"anchor\" href=\"#5-迭代器适配器-iterator-adapters\">#</a> 5. 迭代器适配器 (Iterator Adapters)</h3>\n<p>迭代器适配器（Iterator Adapters）是 <code>Iterator</code> Trait 上的方法，它们<strong>返回一个新的迭代器</strong>。它们是惰性的，在调用消耗性适配器之前不会执行任何操作。</p>\n<p><strong>示例：<code>map</code></strong><br />\n<code>map</code> 方法接收一个闭包，对迭代器中的每个元素调用该闭包，并返回一个包含新结果的新迭代器。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> main_map</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> v2</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> vec!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">[</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 2</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 3</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 4</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 5</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">]</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">    </span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // .iter() 是迭代器</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // .map() 是迭代器适配器 (惰性的)</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // .collect() 是消耗性适配器 (执行操作)</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> v3</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Vec</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">_</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> v2</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">iter</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">map</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">|</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">x</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">|</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> x</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> +</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 1</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">collect</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">    </span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    assert_eq!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">v3</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> vec!</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">[</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">2</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 3</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 4</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 5</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 6</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">]</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<h3 id=\"6-使用闭包捕获环境\"><a class=\"anchor\" href=\"#6-使用闭包捕获环境\">#</a> 6. 使用闭包捕获环境</h3>\n<p>许多迭代器适配器（如 <code>map</code>、<code>filter</code>）都接收闭包作为参数。闭包可以捕获其定义时所在的环境变量。</p>\n<p><strong>示例：<code>filter</code></strong><br />\n<code>filter</code> 方法接收一个闭包（返回 <code>true</code> 或 <code>false</code>），并返回一个只包含原迭代器中使闭包返回 <code>true</code> 的元素的新迭代器。</p>\n<p>在下面的示例中，<code>filter</code> 闭包 <code>|s| s.size == shoe_size</code> 捕获了 <code>shoes_in_size</code> 函数参数中的 <code>shoe_size</code> 变量。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">#</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">derive</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">PartialEq</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Debug</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">struct</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Shoe</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">    size</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> u32</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">    style</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 找出符合条件的鞋子（size 等于 shoe_size）</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> shoes_in_size</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">shoes</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Vec</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Shoe</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> shoe_size</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> u32</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Vec</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Shoe</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">    shoes</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">into_iter</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 获取所有权，产生 T (Shoe)</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">        .</span><span style=\"color:#59873A;--shiki-dark:#80A665\">filter</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">|</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">s</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">|</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> s</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">size </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">==</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> shoe_size</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 闭包捕获了 shoe_size</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">        .</span><span style=\"color:#59873A;--shiki-dark:#80A665\">collect</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 消耗迭代器，收集结果</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">#</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">cfg</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">test</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">mod</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> tests</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    use</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> super</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::*</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    #</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">[</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">test</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">]</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> filters_by_size</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">        let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> shoes</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> vec!</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">[</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">            Shoe</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#a13865;--shiki-dark:#d9739f\">&#123;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> size</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 10</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> style</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#bda437;--shiki-dark:#e6cc77\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">sneaker</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#bda437;--shiki-dark:#e6cc77\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#a13865;--shiki-dark:#d9739f\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">            Shoe</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#a13865;--shiki-dark:#d9739f\">&#123;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> size</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 13</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> style</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#bda437;--shiki-dark:#e6cc77\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">sandal</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#bda437;--shiki-dark:#e6cc77\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#a13865;--shiki-dark:#d9739f\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">            Shoe</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#a13865;--shiki-dark:#d9739f\">&#123;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> size</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 10</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> style</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#bda437;--shiki-dark:#e6cc77\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">boot</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#bda437;--shiki-dark:#e6cc77\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#a13865;--shiki-dark:#d9739f\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">        </span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">]</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">        let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> in_my_size</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> shoes_in_size</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">shoes</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 10</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        assert_eq!</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">            in_my_size</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">            vec!</span><span style=\"color:#a13865;--shiki-dark:#d9739f\">[</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">                Shoe</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#bda437;--shiki-dark:#e6cc77\">&#123;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> size</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 10</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> style</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#296aa3;--shiki-dark:#6394bf\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">sneaker</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#296aa3;--shiki-dark:#6394bf\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#bda437;--shiki-dark:#e6cc77\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">                Shoe</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#bda437;--shiki-dark:#e6cc77\">&#123;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> size</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 10</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> style</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#296aa3;--shiki-dark:#6394bf\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">boot</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#296aa3;--shiki-dark:#6394bf\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#bda437;--shiki-dark:#e6cc77\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">            </span><span style=\"color:#a13865;--shiki-dark:#d9739f\">]</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">        </span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n",
            "tags": [
                "Programming",
                "Rust"
            ]
        },
        {
            "id": "https://soruan.github.io/2025/11/01/Programming/Rust/Rust%E9%97%AD%E5%8C%85/",
            "url": "https://soruan.github.io/2025/11/01/Programming/Rust/Rust%E9%97%AD%E5%8C%85/",
            "title": "Rust闭包",
            "date_published": "2025-11-01T15:24:05.000Z",
            "content_html": "<h1 id=\"rust-闭包closure\"><a class=\"anchor\" href=\"#rust-闭包closure\">#</a> Rust 闭包（Closure）</h1>\n<p>闭包是一种可以捕获其环境中变量的匿名函数。它在 Rust 中被广泛用于函数式编程、迭代器处理和并发编程。</p>\n<p>下面的示例代码将围绕一个衬衫库存<code>Inventory</code>结构展开，演示闭包在实际场景中的应用。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">use</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">time</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Duration</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">use</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">thread</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">#</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">derive</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Debug</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> PartialEq</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Copy</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Clone</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">enum</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> ShirtColor</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">    Red</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">    Blue</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 库存，表示有多少件不同颜色的衬衫</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">struct</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Inventory</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">    shirts</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Vec</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">ShirtColor</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">impl</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Inventory</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 根据用户偏好选择衬衫颜色，如果没有偏好则选择库存最多的颜色</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> giveaway</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> user_preference</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Option</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">ShirtColor</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> ShirtColor</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">        // unwrap_or_else 在 user_preference 为 None 时调用闭包</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">        // 闭包返回值为T，即 most_stocked() 的返回值</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">        user_preference</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">unwrap_or_else</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">||</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">most_stocked</span><span style=\"color:#a13865;--shiki-dark:#d9739f\">(</span><span style=\"color:#a13865;--shiki-dark:#d9739f\">)</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> most_stocked</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> ShirtColor</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">        let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> red_count</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> self</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">            .</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">shirts</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">            .</span><span style=\"color:#59873A;--shiki-dark:#80A665\">iter</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">            .</span><span style=\"color:#59873A;--shiki-dark:#80A665\">filter</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">|&#x26;&#x26;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">c</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">|</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> c</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> ==</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> ShirtColor</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Red</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">            .</span><span style=\"color:#59873A;--shiki-dark:#80A665\">count</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">        let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> blue_count</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> self</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">            .</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">shirts</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">            .</span><span style=\"color:#59873A;--shiki-dark:#80A665\">iter</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">            .</span><span style=\"color:#59873A;--shiki-dark:#80A665\">filter</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">|&#x26;&#x26;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">c</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">|</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> c</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> ==</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> ShirtColor</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Blue</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">            .</span><span style=\"color:#59873A;--shiki-dark:#80A665\">count</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">        if</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> red_count</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">=</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> blue_count</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">            ShirtColor</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Red</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">        </span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">&#125;</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> else</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">            ShirtColor</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Blue</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">        </span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> main</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> store</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Inventory</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">        shirts</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> vec!</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">[</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">ShirtColor</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Blue</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> ShirtColor</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Red</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> ShirtColor</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Blue</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">]</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> user_pref1</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Some</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">ShirtColor</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Red</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> giveaway1</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> store</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">giveaway</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">user_pref1</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    println!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span></span>\n<span class=\"line\"><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">User preference: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">:?</span><span style=\"color:#999999;--shiki-dark:#666666\">&#125;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">, Given away: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">:?</span><span style=\"color:#999999;--shiki-dark:#666666\">&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">        user_pref1</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> giveaway1</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> user_pref2</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> None</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> giveaway2</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> store</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">giveaway</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">user_pref2</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    println!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span></span>\n<span class=\"line\"><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">        \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">User preference: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">:?</span><span style=\"color:#999999;--shiki-dark:#666666\">&#125;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">, Given away: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">:?</span><span style=\"color:#999999;--shiki-dark:#666666\">&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">        user_pref2</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> giveaway2</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">    </span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // ... 后续代码 ...</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<p>在 <code>giveaway</code> 方法中，<code>unwrap_or_else</code> 接受一个闭包 <code>|| self.most_stocked()</code>。这个闭包没有参数（由 <code>||</code> 表示），并在被调用时执行 <code>self.most_stocked()</code>。</p>\n<hr />\n<h3 id=\"1-闭包的类型推断与标注\"><a class=\"anchor\" href=\"#1-闭包的类型推断与标注\">#</a> 1. 闭包的类型推断与标注</h3>\n<p>Rust 编译器通常可以为闭包推断参数和返回值的类型。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// ... main 函数中 ...</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 1. 为闭包的参数和返回值显式标注类型</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> expensive_closure</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> |</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">num</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> u32</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">|</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> u32</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    println!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">This is an expensive closure!</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    thread</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">sleep</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#59873A;--shiki-dark:#80A665\">Duration</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from_secs</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">2</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">    num</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">println!</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">打印闭包 </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">:?</span><span style=\"color:#999999;--shiki-dark:#666666\">&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> expensive_closure</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">32</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 2. 编译器自动推断类型</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 必须要求闭包的参数类型在上下文中可以被推断出来</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> example_closure</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> |</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">x</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">|</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> x</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> s</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> example_closure</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#59873A;--shiki-dark:#80A665\">String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">hello</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 类型一旦被推断为 String，就不能再传入其他类型</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// let n = example_closure(5);</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 这将导致编译错误</span></span></code></pre>\n<h3 id=\"2-捕获环境借用与所有权\"><a class=\"anchor\" href=\"#2-捕获环境借用与所有权\">#</a> 2. 捕获环境（借用与所有权）</h3>\n<p>闭包的核心特性是它可以捕获其定义时所在作用域中的变量。捕获方式有三种：不可变借用、可变借用和取得所有权。</p>\n<h4 id=\"21-不可变借用-fn\"><a class=\"anchor\" href=\"#21-不可变借用-fn\">#</a> 2.1. 不可变借用 (Fn)</h4>\n<p>闭包默认以最轻量的方式（不可变借用）捕获变量。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// ... main 函数中 ...</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> list</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> vec!</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 2</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 3</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">println!</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Before defining closure: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">:?</span><span style=\"color:#999999;--shiki-dark:#666666\">&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> list</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 闭包不可变地借用了 list</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> only_borrows</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> ||</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> println!</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">From closure: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">:?</span><span style=\"color:#999999;--shiki-dark:#666666\">&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> list</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 调用闭包</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">only_borrows</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 闭包调用后，list 仍然可用</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">println!</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">After calling closure: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">:?</span><span style=\"color:#999999;--shiki-dark:#666666\">&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> list</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span></code></pre>\n<h4 id=\"22-可变借用-fnmut\"><a class=\"anchor\" href=\"#22-可变借用-fnmut\">#</a> 2.2. 可变借用 (FnMut)</h4>\n<p>如果闭包需要修改捕获的变量，它会进行可变借用。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// ... main 函数中 ...</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">let</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> mut</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> list2</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> vec!</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 2</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 3</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">println!</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Before defining closure: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">:?</span><span style=\"color:#999999;--shiki-dark:#666666\">&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> list2</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 闭包可变地借用了 list2</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">let</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> mut</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> borrows_mutably</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> ||</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> list2</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">push</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">7</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 可变借用在闭包调用（borrows_mutably()）之前都有效</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 在此期间（闭包定义后到调用前）无法使用被借用的值</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// println!(\"Before calling closure: &#123;:?&#125;\", list2);</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 错误：不能在可变借用期间再次借用</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">borrows_mutably</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 调用闭包，可变借用在此处使用</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 调用闭包之后，可变借用结束，后续可以正常打印</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">println!</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">After calling closure: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">:?</span><span style=\"color:#999999;--shiki-dark:#666666\">&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> list2</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span></code></pre>\n<h4 id=\"23-取得所有权-fnonce-与-move\"><a class=\"anchor\" href=\"#23-取得所有权-fnonce-与-move\">#</a> 2.3. 取得所有权 (FnOnce 与 <code>move</code>)</h4>\n<p>使用 <code>move</code> 关键字可以强制闭包获取其使用的值（捕获的值）的所有权。这在并发编程中尤其重要，例如将变量传递给新线程。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// ... main 函数中 ...</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> list3</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> vec!</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 2</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 3</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">println!</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Before defining closure: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">:?</span><span style=\"color:#999999;--shiki-dark:#666666\">&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> list3</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 在闭包定义前加 move，表示闭包取得 list3 的所有权</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">thread</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">spawn</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\">move</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> ||</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> println!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">From thread: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">:?</span><span style=\"color:#999999;--shiki-dark:#666666\">&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> list3</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    .</span><span style=\"color:#59873A;--shiki-dark:#80A665\">join</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    .</span><span style=\"color:#59873A;--shiki-dark:#80A665\">unwrap</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">    </span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// list3 的所有权已被移动到线程中，主线程无法再访问</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// println!(\"After thread: &#123;:?&#125;\", list3);</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 错误：value borrowed here after move</span></span></code></pre>\n<p><em>注意：新线程捕获主线程的值时，通常必须获取所有权（使用 <code>move</code>），否则可能在主线程结束后，新线程持有的引用变成悬垂引用。</em></p>\n<hr />\n<h3 id=\"3-闭包的-traitfn-fnmut-fnonce\"><a class=\"anchor\" href=\"#3-闭包的-traitfn-fnmut-fnonce\">#</a> 3. 闭包的 Trait：<code>Fn</code>、<code>FnMut</code>、<code>FnOnce</code></h3>\n<p>Rust 根据闭包如何捕获和使用环境变量，自动为其实现一个或多个 <code>Fn</code> Trait：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">Trait</th>\n<th style=\"text-align:left\">捕获方式</th>\n<th style=\"text-align:left\">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\"><code>FnOnce</code></td>\n<td style=\"text-align:left\">取得所有权</td>\n<td style=\"text-align:left\">闭包必须被调用（消费）一次。所有闭包都至少实现了 <code>FnOnce</code>。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><code>FnMut</code></td>\n<td style=\"text-align:left\">可变借用</td>\n<td style=\"text-align:left\">闭包可以修改捕获的变量，可以被调用多次。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><code>Fn</code></td>\n<td style=\"text-align:left\">不可变借用</td>\n<td style=\"text-align:left\">闭包不能修改捕获的变量，可以被调用多次。</td>\n</tr>\n</tbody>\n</table>\n<p><em>继承关系：<code>Fn</code> 继承自 <code>FnMut</code>，<code>FnMut</code> 继承自 <code>FnOnce</code>。</em></p>\n<p><code>Option&lt;T&gt;</code> 的 <code>unwrap_or_else</code> 方法的签名展示了 <code>FnOnce</code> 的应用：</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// impl&#x3C;T> Option&#x3C;T> &#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">//     pub fn unwrap_or_else&#x3C;F>(self, f: F) -> T</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">//     where</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">//         F: FnOnce() -> T,</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 要求F实现FnOnce，表示闭包可以被调用一次</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">//     &#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">//         match self &#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">//             Some(val) => val,</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">//             None => f(),</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 只有在None的情况下才调用闭包f</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">//         &#125;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">//     &#125;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// &#125;</span></span></code></pre>\n<h3 id=\"4-fnmut-与-sort_by_key-示例\"><a class=\"anchor\" href=\"#4-fnmut-与-sort_by_key-示例\">#</a> 4. <code>FnMut</code> 与 <code>sort_by_key</code> 示例</h3>\n<p><code>sort_by_key</code> 方法需要一个实现了 <code>FnMut</code> 的闭包，因为它在排序过程中可能需要多次调用闭包来获取键值。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">#</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">derive</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Debug</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">struct</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Rectangle</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">    width</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> u32</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">    height</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> u32</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// ... main 函数中 ...</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">let</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> mut</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> list_rect</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">    Rectangle</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> width</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 10</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> height</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 5</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">    Rectangle</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> width</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 20</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> height</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 10</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">    Rectangle</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> width</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 30</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> height</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 15</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 闭包 |r| r.width 实现了 FnMut (实际上也实现了 Fn)</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">list_rect</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">sort_by_key</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">|</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">r</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">|</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> r</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">width</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">println!</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Sorted by width: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">:?</span><span style=\"color:#999999;--shiki-dark:#666666\">&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> list_rect</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// --- 演示 FnMut ---</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">let</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> mut</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> sort_operations</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> vec!</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> value</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">closure called</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 稍后将被克隆</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">let</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> mut</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> num_sort_operations</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 0</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 将被可变借用</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">list_rect</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">sort_by_key</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">|</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">r</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">|</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 闭包内部修改了捕获的变量 num_sort_operations，因此它必须是 FnMut</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">    sort_operations</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">push</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">value</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">clone</span><span style=\"color:#a13865;--shiki-dark:#d9739f\">(</span><span style=\"color:#a13865;--shiki-dark:#d9739f\">)</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // value 被克隆，所有权未移动</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">    num_sort_operations</span><span style=\"color:#999999;--shiki-dark:#666666\"> +=</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 1</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">    r</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">width</span></span>\n<span class=\"line\"><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">println!</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Sort operations: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">, Count: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> sort_operations</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">len</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> num_sort_operations</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span></code></pre>\n",
            "tags": [
                "Programming",
                "Rust"
            ]
        },
        {
            "id": "https://soruan.github.io/2025/11/01/Programming/Rust/Rust%E5%B7%A5%E5%85%B7%E9%93%BE%E7%AE%A1%E7%90%86/",
            "url": "https://soruan.github.io/2025/11/01/Programming/Rust/Rust%E5%B7%A5%E5%85%B7%E9%93%BE%E7%AE%A1%E7%90%86/",
            "title": "Rust工具链管理",
            "date_published": "2025-11-01T15:22:23.000Z",
            "content_html": "<h1 id=\"rust工具链管理\"><a class=\"anchor\" href=\"#rust工具链管理\">#</a> rust工具链管理</h1>\n<p>在 Rust 开发中，我们经常需要在 <code>stable</code>（稳定版）和 <code>nightly</code>（每夜构建版）工具链之间切换，尤其是在需要使用尚未稳定的新特性时。如果为每个项目手动切换全局工具链，会非常繁琐且容易出错。<code>rustup</code> 提供了强大且优雅的机制来解决这个问题。</p>\n<h3 id=\"1-核心工具rustup\"><a class=\"anchor\" href=\"#1-核心工具rustup\">#</a> 1. 核心工具：<code>rustup</code></h3>\n<p><code>rustup</code> 是 Rust 的官方工具链管理器。我们所有的管理操作都围绕它进行。</p>\n<h3 id=\"2-手动管理全局与临时\"><a class=\"anchor\" href=\"#2-手动管理全局与临时\">#</a> 2. 手动管理（全局与临时）</h3>\n<h4 id=\"21-安装与查看工具链\"><a class=\"anchor\" href=\"#21-安装与查看工具链\">#</a> 2.1. 安装与查看工具链</h4>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 安装 stable (稳定版)</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">rustup</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> install</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> stable</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 安装 nightly (每夜构建版)</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">rustup</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> install</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nightly</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 查看所有已安装的工具链</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">rustup</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> toolchain</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> list</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 输出示例:</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># stable-x86_64-apple-darwin (default)</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># nightly-x86_64-apple-darwin</span></span></code></pre>\n<h4 id=\"22-切换全局默认版本\"><a class=\"anchor\" href=\"#22-切换全局默认版本\">#</a> 2.2. 切换全局默认版本</h4>\n<p>这个命令会改变你系统上所有项目的<strong>默认</strong>工具链。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 将全局默认切换为 nightly</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">rustup</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> default</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nightly</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 再切换回 stable</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">rustup</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> default</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> stable</span></span></code></pre>\n<h4 id=\"23-临时单次覆盖\"><a class=\"anchor\" href=\"#23-临时单次覆盖\">#</a> 2.3. 临时单次覆盖</h4>\n<p>可以使用 <code>+</code> 语法，临时为<strong>单条命令</strong>指定工具链，而不改变全局默认值。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 仅本次 build 使用 nightly</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">cargo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> +nightly</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> build</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 仅本次 test 使用 stable</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">cargo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> +stable</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> test</span></span></code></pre>\n<hr />\n<h3 id=\"3-项目级自动覆盖\"><a class=\"anchor\" href=\"#3-项目级自动覆盖\">#</a> 3. 项目级自动覆盖</h3>\n<p><strong>在项目配置中定义所用的 Rust 版本。</strong></p>\n<p><code>rustup</code> 在执行 <code>cargo</code> 或 <code>rustc</code> 时，会自动从当前目录向上查找名为 <code>rust-toolchain</code> 或 <code>rust-toolchain.toml</code> 的配置文件。如果找到，它将<strong>自动使用该文件指定的工具链</strong>，完全覆盖全局默认设置。</p>\n<h4 id=\"方式一使用-rustup-override\"><a class=\"anchor\" href=\"#方式一使用-rustup-override\">#</a> 方式一：使用 <code>rustup override</code></h4>\n<ol>\n<li>\n<p>进入你的项目目录：</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#998418;--shiki-dark:#B8A965\">cd</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> /path/to/my-nightly-project</span></span></code></pre>\n</li>\n<li>\n<p>执行 <code>override</code> 命令，声明此目录使用 <code>nightly</code>：</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">rustup</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> override</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> set</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nightly</span></span></code></pre>\n</li>\n<li>\n<p><code>rustup</code> 会在当前目录下创建一个名为 <code>rust-toolchain</code> 的文件，内容仅一行：</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">nightly</span></span></code></pre>\n</li>\n<li>\n<p>现在，只要终端位于此目录（或其子目录）下，执行 <code>cargo build</code> 或 <code>rustc --version</code> 都会自动使用 <code>nightly</code> 工具链。当你离开这个目录，<code>rustup</code> 会自动用回全局默认（如 <code>stable</code>）工具链。</p>\n</li>\n</ol>\n<p><strong>重要</strong>：<code>rust-toolchain</code> 文件应该<strong>提交到 Git 仓库</strong>。这可以保证所有协作者和 CI/CD 服务器都能自动使用完全一致的工具链，实现可复现构建。</p>\n<ul>\n<li>\n<p><strong>取消覆盖</strong>：</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 这会删除 rust-toolchain 文件</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">rustup</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> override</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> unset</span></span></code></pre>\n</li>\n</ul>\n<h4 id=\"方式二手动创建-rust-toolchaintoml\"><a class=\"anchor\" href=\"#方式二手动创建-rust-toolchaintoml\">#</a> 方式二：手动创建 <code>rust-toolchain.toml</code></h4>\n<p>可以手动在项目根目录创建 <code>rust-toolchain.toml</code> 文件（这是 <code>rust-toolchain</code> 文件的现代 TOML 格式版本），它提供了更丰富的配置选项。</p>\n<p><strong>示例 <code>rust-toolchain.toml</code>：</strong></p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-toml\"><span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#59873A;--shiki-dark:#80A665\">toolchain</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 1. 指定通道</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">channel</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">nightly</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 2. (可选) 确保特定组件被自动安装</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 在 CI 或新环境中非常有用</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">components</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">clippy</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">rustfmt</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 3. (可选) 自动安装指定的目标平台</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 嵌入式开发利器</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># targets = [ \"thumbv7em-none-eabihf\" ]</span></span></code></pre>\n<p><strong>锁定特定版本</strong></p>\n<p>为了防止 <code>nightly</code> 的日常更新破坏你的构建，可以锁定到一个已知可用的特定日期版本：</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-toml\"><span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#59873A;--shiki-dark:#80A665\">toolchain</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 锁定到 2025 年 10 月 20 日的 nightly 版本</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">channel</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">nightly-2025-10-20</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span></code></pre>\n<h3 id=\"4-总结\"><a class=\"anchor\" href=\"#4-总结\">#</a> 4. 总结</h3>\n<ul>\n<li><strong>避免使用 <code>rustup default</code></strong> 来管理项目间的切换。它只应该用来设置你个人的“默认”偏好。</li>\n<li>对于任何需要特定（非 <code>stable</code>）工具链的项目，<strong>一律使用 <code>rustup override set</code> 或创建 <code>rust-toolchain.toml</code> 文件</strong>。</li>\n<li>这套基于目录的覆盖机制，是 Rust 保证项目环境一致性、实现可复现构建的工程化基石。</li>\n</ul>\n",
            "tags": [
                "Programming",
                "Rust"
            ]
        },
        {
            "id": "https://soruan.github.io/2025/09/07/Programming/C++/%E7%8E%B0%E4%BB%A3C-%E5%BC%BA%E5%88%B6%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/",
            "url": "https://soruan.github.io/2025/09/07/Programming/C++/%E7%8E%B0%E4%BB%A3C-%E5%BC%BA%E5%88%B6%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/",
            "title": "现代C++强制类型转换",
            "date_published": "2025-09-06T16:13:19.000Z",
            "content_html": "<h1 id=\"现代c强制类型转换\"><a class=\"anchor\" href=\"#现代c强制类型转换\">#</a> 现代C++强制类型转换</h1>\n<p>在C++中，提供了四种特定的强制类型转换操作符，以提供更安全、更明确的类型转换，它们分别是 <code>static_cast</code>、<code>dynamic_cast</code>、<code>const_cast</code> 和 <code>reinterpret_cast</code>。</p>\n<h2 id=\"static_cast用于良性和相关的转换\"><a class=\"anchor\" href=\"#static_cast用于良性和相关的转换\">#</a> <code>static_cast</code>：用于“良性”和“相关”的转换</h2>\n<p><code>static_cast</code> 在编译期进行类型检查，如果转换在编译期被认为是无效的，则会引发错误。它适用于大部分良性的、有逻辑关联的类型转换。</p>\n<h4 id=\"核心特点\"><a class=\"anchor\" href=\"#核心特点\">#</a> 核心特点</h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">特性</th>\n<th style=\"text-align:left\">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\"><strong>转换时机</strong></td>\n<td style=\"text-align:left\">编译期 (Compile-time)</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><strong>安全性</strong></td>\n<td style=\"text-align:left\">部分安全。编译期会检查类型是否相关，但不进行运行时检查。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><strong>开销</strong></td>\n<td style=\"text-align:left\">无运行时开销，与C风格转换相当。</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"主要用途\"><a class=\"anchor\" href=\"#主要用途\">#</a> 主要用途</h4>\n<ol>\n<li>\n<p><strong>基本数据类型转换</strong><br />\n适用于数值类型之间的转换，如 <code>int</code> 到 <code>double</code>，或者 <code>enum</code> 到 <code>int</code>。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-cpp\"><span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">double</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> pi </span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 3.14159</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">int</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> truncated_pi </span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> static_cast</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">int</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">pi</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 结果为 3</span></span></code></pre>\n</li>\n<li>\n<p><strong>有继承关系的类指针/引用转换</strong></p>\n<ul>\n<li><strong>向上转型 (Upcasting)</strong>：将派生类的指针或引用转换为基类，这是安全的，因为派生类包含了基类的所有成员。</li>\n<li><strong>向下转型 (Downcasting)</strong>：将基类的指针或引用转换为派生类。这是 <strong>不安全</strong> 的，因为它不进行运行时检查来确保基类指针确实指向一个派生类对象。如果转换错误，将导致未定义行为。</li>\n</ul>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-cpp\"><span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">class</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Base</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">class</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Derived</span><span style=\"color:#999999;--shiki-dark:#666666\"> :</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> public</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Base</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">Derived d</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 向上转型：安全</span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">Base</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> b_ptr </span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> static_cast</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">Base</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">d</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 向下转型：不安全，程序员必须确保 b_ptr 确实指向一个 Derived 对象</span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">Derived</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> d_ptr </span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> static_cast</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">Derived</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">b_ptr</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span></code></pre>\n</li>\n<li>\n<p><strong>将<code>void*</code>指针转换为具体类型指针</strong><br />\n<code>static_cast</code> 可以将 <code>void*</code> 指针转回其原始或兼容的类型。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-cpp\"><span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">void*</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> p </span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> malloc</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">10</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">int*</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> int_p </span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> static_cast</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">int*</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">p</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">free</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">int_p</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span></code></pre>\n</li>\n</ol>\n<h2 id=\"dynamic_cast用于安全的向下转型\"><a class=\"anchor\" href=\"#dynamic_cast用于安全的向下转型\">#</a> <code>dynamic_cast</code>：用于“安全”的向下转型</h2>\n<p><code>dynamic_cast</code> 专门用于处理涉及<strong>多态</strong>（polymorphism）的类层次结构中的类型转换。它在<strong>运行时</strong>进行类型检查，以确保转换的安全性。</p>\n<h4 id=\"核心特点-2\"><a class=\"anchor\" href=\"#核心特点-2\">#</a> 核心特点</h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">特性</th>\n<th style=\"text-align:left\">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\"><strong>转换时机</strong></td>\n<td style=\"text-align:left\">运行时 (Run-time)</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><strong>安全性</strong></td>\n<td style=\"text-align:left\">安全。通过运行时类型信息 (RTTI) 检查转换的有效性。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><strong>开销</strong></td>\n<td style=\"text-align:left\">有运行时开销，比 <code>static_cast</code> 慢。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><strong>前提条件</strong></td>\n<td style=\"text-align:left\">只能用于包含虚函数（virtual function）的类，即多态类。</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"主要用途-2\"><a class=\"anchor\" href=\"#主要用途-2\">#</a> 主要用途</h4>\n<ul>\n<li>\n<p><strong>安全的向下转型</strong>：在类继承结构中，安全地将基类指针或引用转换为派生类指针或引用。</p>\n</li>\n<li>\n<p><strong>转换失败的处理</strong>：</p>\n<ul>\n<li>对于指针类型，如果转换失败，它会返回 <code>nullptr</code>。</li>\n<li>对于引用类型，如果转换失败，它会抛出 <code>std::bad_cast</code> 异常。</li>\n</ul>\n</li>\n</ul>\n<p>&lt;!-- end list --&gt;</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-cpp\"><span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">class</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Base</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> public</span><span style=\"color:#999999;--shiki-dark:#666666\">:</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> virtual</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> ~</span><span style=\"color:#59873A;--shiki-dark:#80A665\">Base</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 必须有虚函数</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">class</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Derived</span><span style=\"color:#999999;--shiki-dark:#666666\"> :</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> public</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Base</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> public</span><span style=\"color:#999999;--shiki-dark:#666666\">:</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> void</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> derived_only_func</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">class</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Another</span><span style=\"color:#999999;--shiki-dark:#666666\"> :</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> public</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Base</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">void</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> process</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Base</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> b_ptr</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 尝试将基类指针安全地转换为派生类指针</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    if</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">Derived</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> d_ptr </span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> dynamic_cast</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">Derived</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">b_ptr</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">        // 转换成功，b_ptr 确实指向一个 Derived 或其子类的对象</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">        d_ptr</span><span style=\"color:#999999;--shiki-dark:#666666\">-</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#59873A;--shiki-dark:#80A665\">derived_only_func</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> else</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">        // 转换失败，b_ptr 指向的不是 Derived 对象</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">        // 在这里安全地处理其他情况</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<h2 id=\"const_cast用于移除-const-或-volatile-属性\"><a class=\"anchor\" href=\"#const_cast用于移除-const-或-volatile-属性\">#</a> <code>const_cast</code>：用于移除 <code>const</code> 或 <code>volatile</code> 属性</h2>\n<p><code>const_cast</code> 是唯一能修改类型的 <code>const</code> 或 <code>volatile</code> 限定符的转换符。它的主要使用场景是与一些旧的、未正确使用 <code>const</code> 的API交互。</p>\n<h4 id=\"核心特点-3\"><a class=\"anchor\" href=\"#核心特点-3\">#</a> 核心特点</h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">特性</th>\n<th style=\"text-align:left\">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\"><strong>转换时机</strong></td>\n<td style=\"text-align:left\">编译期 (Compile-time)</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><strong>安全性</strong></td>\n<td style=\"text-align:left\">不安全。如果试图通过 <code>const_cast</code> 移除 <code>const</code> 后去修改一个本身被定义为 <code>const</code> 的对象，将导致未定义行为。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><strong>开销</strong></td>\n<td style=\"text-align:left\">无运行时开销。</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"主要用途-3\"><a class=\"anchor\" href=\"#主要用途-3\">#</a> 主要用途</h4>\n<ul>\n<li><strong>移除 <code>const</code></strong>：将 <code>const</code> 指针/引用转换为非 <code>const</code> 指针/引用。</li>\n<li><strong>添加 <code>const</code></strong>：将非 <code>const</code> 指针/引用转换为 <code>const</code> 指针/引用。</li>\n</ul>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-cpp\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 一个老旧的C风格API，它不会修改数据，但参数不是 const</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">void</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> legacy_c_api</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">char*</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> str</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // ...</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">void</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> call_legacy_api</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    const</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> char*</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> my_str </span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">hello</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // my_str 是 const，不能直接传递给 legacy_c_api</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 我们确信 API 不会修改它，因此使用 const_cast</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    legacy_c_api</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">const_cast</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">char*</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">my_str</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<p><strong>警告</strong>：只有当你知道被转换的对象最初不是 <code>const</code> 时，才能安全地通过 <code>const_cast</code> 后的指针修改它。</p>\n<h2 id=\"reinterpret_cast用于处理无关类型的转换\"><a class=\"anchor\" href=\"#reinterpret_cast用于处理无关类型的转换\">#</a> <code>reinterpret_cast</code>：用于处理“无关”类型的转换</h2>\n<p><code>reinterpret_cast</code> 是最危险的类型转换，它执行底层的、与实现相关的位模式重新解释。编译器不会进行任何类型检查，完全信任程序员的操作。</p>\n<h4 id=\"核心特点-4\"><a class=\"anchor\" href=\"#核心特点-4\">#</a> 核心特点</h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">特性</th>\n<th style=\"text-align:left\">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\"><strong>转换时机</strong></td>\n<td style=\"text-align:left\">编译期 (Compile-time)</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><strong>安全性</strong></td>\n<td style=\"text-align:left\">极度不安全。它仅仅是重新解释内存中的位，结果是平台相关的。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><strong>开销</strong></td>\n<td style=\"text-align:left\">无运行时开销。</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"主要用途-4\"><a class=\"anchor\" href=\"#主要用途-4\">#</a> 主要用途</h4>\n<p>只在非常底层的编程中才需要它，比如：</p>\n<ul>\n<li><strong>指针与整数之间的转换</strong>：如将指针地址存为一个整数。</li>\n<li><strong>不同类型的指针转换</strong>：在不相关的类型之间进行指针转换，例如将一个 <code>int*</code> 转换为 <code>MyClass*</code>。</li>\n<li><strong>与硬件交互</strong>：将一个特定的整数地址转换为设备寄存器的指针。</li>\n</ul>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-cpp\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 场景：将一个对象地址存为整数，之后再转回来</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">class</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> MyClass</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">MyClass obj</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 将指针地址转换为整数类型 uintptr_t</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">uintptr_t</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> addr </span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> reinterpret_cast</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">uintptr_t</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">obj</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// ... 在某个时刻 ...</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 将整数地址转回原始指针类型</span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">MyClass</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> obj_ptr </span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> reinterpret_cast</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">MyClass</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">addr</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 场景：字节流的重新解释</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">char</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> buffer</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">sizeof</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">MyClass</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// ... 从网络或文件读取字节到 buffer ...</span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">MyClass</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> p_obj_from_buffer </span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> reinterpret_cast</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">MyClass</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">buffer</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span></code></pre>\n<h2 id=\"四种转换总结\"><a class=\"anchor\" href=\"#四种转换总结\">#</a> 四种转换总结</h2>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">转换类型</th>\n<th style=\"text-align:left\">转换时机</th>\n<th style=\"text-align:left\">安全性</th>\n<th style=\"text-align:left\">主要用途</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\"><strong><code>static_cast</code></strong></td>\n<td style=\"text-align:left\">编译期</td>\n<td style=\"text-align:left\">部分安全</td>\n<td style=\"text-align:left\">相关类型转换（数值、继承、void*）</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><strong><code>dynamic_cast</code></strong></td>\n<td style=\"text-align:left\">运行时</td>\n<td style=\"text-align:left\">安全</td>\n<td style=\"text-align:left\">多态类层次结构中的安全向下转型</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><strong><code>const_cast</code></strong></td>\n<td style=\"text-align:left\">编译期</td>\n<td style=\"text-align:left\">不安全</td>\n<td style=\"text-align:left\">添加或移除 <code>const</code> / <code>volatile</code> 属性</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><strong><code>reinterpret_cast</code></strong></td>\n<td style=\"text-align:left\">编译期</td>\n<td style=\"text-align:left\">极度不安全</td>\n<td style=\"text-align:left\">底层、无关类型的位模式重新解释</td>\n</tr>\n</tbody>\n</table>\n",
            "tags": [
                "Programming",
                "C",
                "C++"
            ]
        },
        {
            "id": "https://soruan.github.io/2025/09/07/Programming/C++/%E5%AD%97%E8%8A%82%E5%BA%8F%E4%B8%8E%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90/",
            "url": "https://soruan.github.io/2025/09/07/Programming/C++/%E5%AD%97%E8%8A%82%E5%BA%8F%E4%B8%8E%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90/",
            "title": "字节序与内存对齐",
            "date_published": "2025-09-06T16:12:51.000Z",
            "content_html": "<h3 id=\"1-字节序-endianness-大小端模式\"><a class=\"anchor\" href=\"#1-字节序-endianness-大小端模式\">#</a> 1. 字节序 (Endianness / 大小端模式)</h3>\n<p><strong>核心概念</strong>：字节序定义了<strong>多字节数据类型</strong>（例如 <code>int</code>, <code>short</code>, <code>double</code> 等）在内存中是如何存储其字节的顺序。</p>\n<p>一个32位的整数 <code>0x01020304</code> 由4个字节组成：<code>0x01</code>, <code>0x02</code>, <code>0x03</code>, <code>0x04</code>。</p>\n<ul>\n<li><code>0x01</code> 是<strong>最高有效字节 (Most Significant Byte, MSB)</strong></li>\n<li><code>0x04</code> 是<strong>最低有效字节 (Least Significant Byte, LSB)</strong></li>\n</ul>\n<p>内存地址总是从低到高增长。根据将 MSB 还是 LSB 存放在低地址，产生了两种模式：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">模式</th>\n<th style=\"text-align:left\">描述</th>\n<th style=\"text-align:left\">存储示例 (int 0x01020304)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\"><strong>大端模式 (Big-Endian)</strong></td>\n<td style=\"text-align:left\"><strong>最高有效字节 (MSB)</strong> 存放在 <strong>最低的内存地址</strong>。符合人类阅读习惯。</td>\n<td style=\"text-align:left\"><code>01</code> <code>02</code> <code>03</code> <code>04</code></td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><strong>小端模式 (Little-Endian)</strong></td>\n<td style=\"text-align:left\"><strong>最低有效字节 (LSB)</strong> 存放在 <strong>最低的内存地址</strong>。符合计算机处理逻辑。</td>\n<td style=\"text-align:left\"><code>04</code> <code>03</code> <code>02</code> <code>01</code></td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"a-大端模式-big-endian\"><a class=\"anchor\" href=\"#a-大端模式-big-endian\">#</a> a. 大端模式 (Big-Endian)</h4>\n<p>对于 <code>int num = 0x01020304;</code>，其在内存中的存储方式如下：</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-text\"><span class=\"line\"><span>内存地址 (低 ---> 高)</span></span>\n<span class=\"line\"><span>+--------+--------+--------+--------+</span></span>\n<span class=\"line\"><span>|  0x01  |  0x02  |  0x03  |  0x04  |</span></span>\n<span class=\"line\"><span>+--------+--------+--------+--------+</span></span>\n<span class=\"line\"><span> 0x1000   0x1001   0x1002   0x1003</span></span></code></pre>\n<ul>\n<li><strong>常见架构</strong>：PowerPC, SPARC, 网络字节序 (Network Byte Order)。</li>\n</ul>\n<h4 id=\"b-小端模式-little-endian\"><a class=\"anchor\" href=\"#b-小端模式-little-endian\">#</a> b. 小端模式 (Little-Endian)</h4>\n<p>对于 <code>int num = 0x01020304;</code>，其在内存中的存储方式如下：</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-text\"><span class=\"line\"><span>内存地址 (低 ---> 高)</span></span>\n<span class=\"line\"><span>+--------+--------+--------+--------+</span></span>\n<span class=\"line\"><span>|  0x04  |  0x03  |  0x02  |  0x01  |</span></span>\n<span class=\"line\"><span>+--------+--------+--------+--------+</span></span>\n<span class=\"line\"><span> 0x1000   0x1001   0x1002   0x1003</span></span></code></pre>\n<ul>\n<li><strong>常见架构</strong>：x86, x86-64, ARM (大部分模式下)。</li>\n</ul>\n<h4 id=\"c-如何判断当前系统的字节序\"><a class=\"anchor\" href=\"#c-如何判断当前系统的字节序\">#</a> c. 如何判断当前系统的字节序？</h4>\n<p>可以通过检查一个整数的第一个字节来判断。整数 <code>1</code> 在内存中表示为 <code>0x00000001</code>。</p>\n<ul>\n<li>在小端系统中，最低地址存放的是 <code>0x01</code>。</li>\n<li>在大端系统中，最低地址存放的是 <code>0x00</code>。</li>\n</ul>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-cpp\"><span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">#</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\">include</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> &#x3C;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">iostream</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">></span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">void</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> check_endianness</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    int</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> num </span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 1</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 将int指针强制转换为char指针，指向num的最低地址</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    char*</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> ptr </span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> reinterpret_cast</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">char*</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">num</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    if</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">*</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">ptr </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">==</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 1</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        std</span><span style=\"color:#999999;--shiki-dark:#666666\">::</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">cout </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">本系统是 小端模式 (Little-Endian)</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#999999;--shiki-dark:#666666\">::</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">endl</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> else</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        std</span><span style=\"color:#999999;--shiki-dark:#666666\">::</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">cout </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">本系统是 大端模式 (Big-Endian)</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#999999;--shiki-dark:#666666\">::</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">endl</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<hr />\n<h3 id=\"2-内存对齐-memory-alignment\"><a class=\"anchor\" href=\"#2-内存对齐-memory-alignment\">#</a> 2. 内存对齐 (Memory Alignment)</h3>\n<p><strong>核心概念</strong>：CPU访问内存不是逐字节进行的，而是以块（通常是2, 4, 8字节）为单位。为了让CPU高效地读取数据，编译器会自动将数据存放在特定地址，这个地址通常是其数据类型大小的整数倍。</p>\n<p><strong>为什么需要对齐？</strong></p>\n<ul>\n<li><strong>性能</strong>：对齐的数据可以被CPU在一个总线周期内读取。如果数据未对齐，CPU可能需要两次读取再拼接数据，降低性能。</li>\n<li><strong>硬件要求</strong>：某些硬件平台（尤其是RISC架构，如ARM）<strong>不允许</strong>访问未对齐的数据，强行访问会触发硬件异常。</li>\n</ul>\n<h4 id=\"a-对齐规则\"><a class=\"anchor\" href=\"#a-对齐规则\">#</a> a. 对齐规则</h4>\n<ol>\n<li><strong>成员对齐</strong>：结构体(<code>struct</code>)或类(<code>class</code>)的每个成员，其存放的起始地址相对于结构体起始地址的偏移量，必须是其自身大小（或指定对齐值）的整数倍。</li>\n<li><strong>整体对齐</strong>：结构体或类的总大小，必须是其<strong>最宽的成员</strong>（或指定对齐值）大小的整数倍。</li>\n</ol>\n<p><strong>示例分析</strong>：</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-cpp\"><span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">#</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\">include</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> &#x3C;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">iostream</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">></span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">struct</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> MyStruct</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    char</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> a</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 1字节</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    int</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> b</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">     // 4字节</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    short</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> c</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">   // 2字节</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">int</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> main</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 预期大小: 1 + 4 + 2 = 7</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 实际大小: 12</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    std</span><span style=\"color:#999999;--shiki-dark:#666666\">::</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">cout </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">sizeof(MyStruct) = </span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> sizeof</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">MyStruct</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#999999;--shiki-dark:#666666\">::</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">endl</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<p><strong>内存布局</strong>：</p>\n<p><img loading=\"lazy\" src=\"https://markdownforyuanhao.oss-cn-hangzhou.aliyuncs.com/img1/20250907001714517.png\" alt=\"Snipaste_2025-09-07_00-16-45\" /></p>\n<ul>\n<li><code>char a</code>: 位于偏移量 <code>0</code>。</li>\n<li><code>int b</code>: 大小为4，其偏移量必须是4的倍数。因此编译器在 <code>a</code> 后填充3字节，使 <code>b</code> 从偏移量 <code>4</code> 开始。</li>\n<li><code>short c</code>: 大小为2，<code>b</code> 结束后偏移量为 <code>8</code>，是2的倍数，可以直接存放。</li>\n<li><strong>整体对齐</strong>: 结构体最宽成员是 <code>int b</code> (4字节)，总大小必须是4的倍数。当前大小为 <code>1 (a) + 3 (pad) + 4 (b) + 2 (c) = 10</code> 字节。为满足4的倍数要求，末尾再填充2字节，最终大小为12字节。</li>\n</ul>\n<h4 id=\"b-如何控制对齐-pragma-packn\"><a class=\"anchor\" href=\"#b-如何控制对齐-pragma-packn\">#</a> b. 如何控制对齐 <code>#pragma pack(n)</code></h4>\n<p>可以使用预处理指令 <code>#pragma pack(n)</code> 来改变编译器的默认对齐系数。<code>n</code> 可以是 <code>1</code>, <code>2</code>, <code>4</code>, <code>8</code> 等。成员对齐时，将按照 <code>n</code> 和成员自身大小中 <strong>较小</strong> 的值进行对齐。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-cpp\"><span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">#</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\">pragma</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> pack</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">1</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 设置对齐系数为1，即无填充</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">struct</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> MyStructPacked</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    char</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> a</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 1字节</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    int</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> b</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">     // 4字节</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    short</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> c</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">   // 2字节</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">#</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\">pragma</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> pack</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 恢复默认对齐</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// sizeof(MyStructPacked) 的结果将是 1 + 4 + 2 = 7</span></span></code></pre>\n<hr />\n<h3 id=\"3-常见导致问题的场景\"><a class=\"anchor\" href=\"#3-常见导致问题的场景\">#</a> 3. 常见导致问题的场景</h3>\n<h4 id=\"a-网络通信-字节序问题\"><a class=\"anchor\" href=\"#a-网络通信-字节序问题\">#</a> a. 网络通信 (字节序问题)</h4>\n<p>不同架构的计算机字节序可能不同。而<strong>网络协议规定字节序为大端模式 (Network Byte Order)</strong>。</p>\n<ul>\n<li>\n<p><strong>问题</strong>：小端机器 (x86) 发送 <code>0x01020304</code> (内存中为 <code>04 03 02 01</code>)，大端服务器接收后会误读为 <code>0x04030201</code>。</p>\n</li>\n<li>\n<p><strong>解决方案</strong>：发送前，统一将数据从主机字节序 (Host Order) 转换到网络字节序 (Big-Endian)；接收后反向转换。</p>\n<ul>\n<li><strong>常用函数</strong>：<code>htons()</code>, <code>htonl()</code>, <code>ntohs()</code>, <code>ntohl()</code>\n<ul>\n<li><code>h</code> 代表 host, <code>to</code> 代表 to, <code>n</code> 代表 network, <code>s</code> 代表 short, <code>l</code> 代表 long。</li>\n</ul>\n</li>\n</ul>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-cpp\"><span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">#</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\">include</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> &#x3C;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">arpa/inet.h</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">></span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 在Linux/macOS中</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// #include &#x3C;winsock2.h></span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 在Windows中</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">uint32_t</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> num </span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> 0x</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">01020304</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">uint32_t</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> net_num </span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> htonl</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">num</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 转换为主机序到网络序</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// send(socket, &#x26;net_num, sizeof(net_num), 0);</span></span></code></pre>\n</li>\n</ul>\n<h4 id=\"b-文件读写与数据持久化-字节序与对齐问题\"><a class=\"anchor\" href=\"#b-文件读写与数据持久化-字节序与对齐问题\">#</a> b. 文件读写与数据持久化 (字节序与对齐问题)</h4>\n<p>直接将结构体的二进制内存写入文件，会同时写入字节序和内存对齐产生的填充字节。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-cpp\"><span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">MyStruct data</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// file.write(reinterpret_cast&#x3C;char*>(&#x26;data), sizeof(MyStruct));</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 错误做法</span></span></code></pre>\n<ul>\n<li><strong>问题</strong>:\n<ol>\n<li><strong>字节序</strong>：在小端机器上写的文件，用大端机器读会出错。</li>\n<li><strong>对齐</strong>：不同编译器或编译选项可能导致填充方式不同，造成跨平台/版本解析失败。</li>\n</ol>\n</li>\n<li><strong>解决方案</strong>：采用<strong>序列化 (Serialization)</strong>。逐个成员地进行读写，并为文件格式定义统一的字节序（通常推荐大端）。</li>\n</ul>\n<h4 id=\"c-嵌入式开发与硬件交互-字节序与对齐问题\"><a class=\"anchor\" href=\"#c-嵌入式开发与硬件交互-字节序与对齐问题\">#</a> c. 嵌入式开发与硬件交互 (字节序与对齐问题)</h4>\n<p>直接读写硬件寄存器时，必须严格遵守硬件手册的规定。</p>\n<ul>\n<li><strong>字节序</strong>：硬件寄存器通常是大端模式。小端CPU在写入时必须手动转换字节序。</li>\n<li><strong>对齐</strong>：访问硬件寄存器必须严格对齐。例如，对一个32位(4字节)寄存器，其访问地址必须是4的倍数，否则在很多嵌入式处理器上将导致硬件异常。</li>\n</ul>\n",
            "tags": [
                "Programming",
                "C",
                "C++"
            ]
        },
        {
            "id": "https://soruan.github.io/2025/09/03/Programming/C++/Conan-CMake%E5%9F%BA%E6%9C%AC%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B/",
            "url": "https://soruan.github.io/2025/09/03/Programming/C++/Conan-CMake%E5%9F%BA%E6%9C%AC%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B/",
            "title": "Conan+CMake基本编译流程",
            "date_published": "2025-09-03T14:53:54.000Z",
            "content_html": "<h1 id=\"conancmake基本编译流程\"><a class=\"anchor\" href=\"#conancmake基本编译流程\">#</a> Conan+CMake基本编译流程</h1>\n<h2 id=\"本地编译\"><a class=\"anchor\" href=\"#本地编译\">#</a> 本地编译</h2>\n<h3 id=\"1-conan-安装依赖\"><a class=\"anchor\" href=\"#1-conan-安装依赖\">#</a> 1. Conan 安装依赖</h3>\n<p>首先，使用 Conan 安装项目所需的第三方包。Conan 会根据构建类型（Debug/Release）将生成的文件放置在不同的目录中。</p>\n<ul>\n<li>\n<p>默认情况下，Conan 会创建 <code>build/Release/generators</code> 目录来存放生成文件。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">conan</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> install</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> .</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> --build=missing</span></span></code></pre>\n</li>\n<li>\n<p>可以明确指定构建类型，例如 <code>Debug</code>。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">conan</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> install</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> .</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> --build=missing</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -s</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> build_type=Debug</span></span></code></pre>\n</li>\n<li>\n<p><code>--output-folder</code> 参数可以指定输出目录，但通常不是必需的，因为 Conan 会根据配置自动管理路径。</p>\n</li>\n</ul>\n<h3 id=\"2-cmake-配置与编译\"><a class=\"anchor\" href=\"#2-cmake-配置与编译\">#</a> 2. CMake 配置与编译</h3>\n<p>Conan 在安装依赖后，会自动生成一个 CMake 预设文件 (<code>CMakeUserPresets.json</code>)，其中包含了配置和编译所需的全部信息。因此，推荐直接使用预设来简化操作。</p>\n<h4 id=\"使用-cmake-预设推荐\"><a class=\"anchor\" href=\"#使用-cmake-预设推荐\">#</a> 使用 CMake 预设（推荐）</h4>\n<ul>\n<li>\n<p><strong>配置 CMake</strong></p>\n<p>使用 <code>conan-debug</code> 或 <code>conan-release</code> 预设来配置项目。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 配置 Debug 版本</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">cmake</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> --preset</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> conan-debug</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 配置 Release 版本</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">cmake</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> --preset</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> conan-release</span></span></code></pre>\n</li>\n<li>\n<p><strong>编译</strong></p>\n<p>同样使用预设来执行编译。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 编译 Debug 版本</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">cmake</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> --build</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> --preset</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> conan-debug</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 编译 Release 版本</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">cmake</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> --build</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> --preset</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> conan-release</span></span></code></pre>\n</li>\n</ul>\n<h4 id=\"手动配置\"><a class=\"anchor\" href=\"#手动配置\">#</a> 手动配置</h4>\n<p>如果不使用预设，则需要手动指定工具链文件和构建类型。</p>\n<ul>\n<li>\n<p><strong>配置 CMake</strong></p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 配置 Release 版本</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">cmake</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -S</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> .</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -B</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> build/Release</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -G</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Ninja</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#A65E2B;--shiki-dark:#C99076\">      -DCMAKE_TOOLCHAIN_FILE=build/Release/generators/conan_toolchain.cmake</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#A65E2B;--shiki-dark:#C99076\">      -DCMAKE_BUILD_TYPE=Release</span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">      </span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 配置 Debug 版本</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">cmake</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -S</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> .</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -B</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> build/Debug</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -G</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Ninja</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#A65E2B;--shiki-dark:#C99076\">      -DCMAKE_TOOLCHAIN_FILE=build/Debug/generators/conan_toolchain.cmake</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#A65E2B;--shiki-dark:#C99076\">      -DCMAKE_BUILD_TYPE=Debug</span></span></code></pre>\n</li>\n<li>\n<p><strong>编译</strong></p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 编译 Release 版本</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">cmake</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> --build</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> build/Release</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 编译 Debug 版本</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">cmake</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> --build</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> build/Debug</span></span></code></pre>\n</li>\n</ul>\n<h2 id=\"交叉编译\"><a class=\"anchor\" href=\"#交叉编译\">#</a> 交叉编译</h2>\n<h3 id=\"1-创建-profile-文件\"><a class=\"anchor\" href=\"#1-创建-profile-文件\">#</a> 1. 创建 Profile 文件</h3>\n<p>首先，需要为目标平台创建一个 Conan Profile 文件。例如，为 aarch64 架构创建一个 <code>profiles/aarch64_profile</code> 文件。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-toml\"><span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#59873A;--shiki-dark:#80A665\">settings</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">os</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">L</span><span style=\"color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic\">inux</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">arch</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">a</span><span style=\"color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic\">rmv8</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">compiler</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">g</span><span style=\"color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic\">cc</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">compiler</span><span style=\"color:#999999;--shiki-dark:#666666\">.</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">version</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">15.2</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">compiler</span><span style=\"color:#999999;--shiki-dark:#666666\">.</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">libcxx</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">l</span><span style=\"color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic\">ibstdc++11</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">compiler</span><span style=\"color:#999999;--shiki-dark:#666666\">.</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">cppstd</span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">20</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#59873A;--shiki-dark:#80A665\">conf</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 告诉 Conan 加载我们自定义的 CMake 工具链文件</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 使用 tools.cmake.cmaketoolchain:user_toolchain 来指定</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 注意: $&#123;profile_dir&#125; 是 Conan 变量，但实践中建议使用绝对路径以确保正确识别</span></span>\n<span class=\"line\"><span style=\"color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic\">tools.cmake.cmaketoolchain:user_toolchain=</span><span style=\"color:#2993a3;--shiki-light-font-style:italic;--shiki-dark:#5eaab5;--shiki-dark-font-style:italic\">[</span><span style=\"color:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic\">\"/path/to/your/project/cmake/aarch64-toolchain.cmake\"</span><span style=\"color:#2993a3;--shiki-light-font-style:italic;--shiki-dark:#5eaab5;--shiki-dark-font-style:italic\">]</span></span></code></pre>\n<p>在对应的 <code>.cmake</code> 工具链文件中，你需要设置交叉编译所需的编译器、系统根目录等环境变量。</p>\n<h3 id=\"2-执行编译流程\"><a class=\"anchor\" href=\"#2-执行编译流程\">#</a> 2. 执行编译流程</h3>\n<p>交叉编译的流程与本地编译非常相似，区别在于需要在 <code>conan install</code> 命令中通过 <code>-pr:h</code> 参数指定 Host 平台的 Profile 文件。</p>\n<ul>\n<li>\n<p><strong>Conan 安装依赖</strong></p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">conan</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> install</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> .</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> --build=missing</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -s</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> build_type=Debug</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -pr:h</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> profiles/aarch64_profile</span></span></code></pre>\n</li>\n<li>\n<p><strong>配置 CMake</strong></p>\n<p>Conan 同样会生成适用于交叉编译的 CMake 预设。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">cmake</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> --preset</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> conan-debug</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">cmake</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> --preset</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> conan-release</span></span></code></pre>\n</li>\n<li>\n<p><strong>编译</strong></p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">cmake</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> --build</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> --preset</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> conan-debug</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">cmake</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> --build</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> --preset</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> conan-release</span></span></code></pre>\n</li>\n</ul>\n",
            "tags": [
                "Programming",
                "CMake",
                "Conan"
            ]
        },
        {
            "id": "https://soruan.github.io/2025/08/28/Programming/Rust/Rust%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/",
            "url": "https://soruan.github.io/2025/08/28/Programming/Rust/Rust%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/",
            "title": "Rust的错误处理",
            "date_published": "2025-08-28T15:46:25.000Z",
            "content_html": "<h1 id=\"rust-错误处理机制\"><a class=\"anchor\" href=\"#rust-错误处理机制\">#</a> Rust 错误处理机制</h1>\n<h2 id=\"一-错误分类可恢复与不可恢复\"><a class=\"anchor\" href=\"#一-错误分类可恢复与不可恢复\">#</a> 一、 错误分类：可恢复与不可恢复</h2>\n<p>在 Rust 中，错误被分为两大类：不可恢复的错误和可恢复的错误。系统为这两种错误提供了不同的处理机制。</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">特性</th>\n<th style=\"text-align:left\"><code>panic!</code> (不可恢复错误)</th>\n<th style=\"text-align:left\"><code>Result&lt;T, E&gt;</code> (可恢复错误)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\"><strong>核心用途</strong></td>\n<td style=\"text-align:left\">处理程序缺陷（Bug），表示程序进入了无法安全继续执行的状态。</td>\n<td style=\"text-align:left\">处理可预期的、能够被合理响应的运行时错误。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><strong>典型场景</strong></td>\n<td style=\"text-align:left\">访问数组越界、断言失败等。</td>\n<td style=\"text-align:left\">文件未找到、网络连接中断、输入解析失败等。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><strong>程序行为</strong></td>\n<td style=\"text-align:left\">立即终止当前线程，展开调用栈并清理数据。</td>\n<td style=\"text-align:left\">返回一个包含成功值或错误值的枚举，由调用者决定如何处理。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><strong>触发方式</strong></td>\n<td style=\"text-align:left\">1. 显式调用 <code>panic!(&quot;message&quot;);</code> 2. 代码执行了致命错误操作。</td>\n<td style=\"text-align:left\">函数显式地返回 <code>Ok(value)</code> 或 <code>Err(error)</code>。</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"二-resultt-e-枚举显式处理错误\"><a class=\"anchor\" href=\"#二-resultt-e-枚举显式处理错误\">#</a> 二、 <code>Result&lt;T, E&gt;</code> 枚举：显式处理错误</h2>\n<p><code>Result&lt;T, E&gt;</code> 是一个标准库定义的枚举，专门用于处理可恢复的错误。它有两个变体：</p>\n<ul>\n<li><code>Ok(T)</code>: 表示操作成功，并包含成功时返回的值，其类型为泛型 <code>T</code>。</li>\n<li><code>Err(E)</code>: 表示操作失败，并包含一个描述错误的值，其类型为泛型 <code>E</code>。</li>\n</ul>\n<h3 id=\"1-示例解析字符串\"><a class=\"anchor\" href=\"#1-示例解析字符串\">#</a> 1. 示例：解析字符串</h3>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">use</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">num</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">ParseIntError</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 函数尝试将字符串解析为 i32</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 成功时返回 Ok(i32)，失败时返回 Err(ParseIntError)</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> parse_number</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">s</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">str</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Result</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">i32</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> ParseIntError</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">    s</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">parse</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">i32</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> main</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> success</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> parse_number</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">123</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> failure</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> parse_number</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">abc</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    println!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">尝试解析 '123': </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">:?</span><span style=\"color:#999999;--shiki-dark:#666666\">&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> success</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    println!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">尝试解析 'abc': </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">:?</span><span style=\"color:#999999;--shiki-dark:#666666\">&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> failure</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<p><strong>执行结果：</strong></p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">尝试解析</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> '</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">123</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">'</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Ok</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#59873A;--shiki-dark:#80A665\">123</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">尝试解析</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> '</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">abc</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">'</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Err</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#59873A;--shiki-dark:#80A665\">ParseIntError</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> &#123;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> kind:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> InvalidDigit</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> &#125;</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span></span></code></pre>\n<h3 id=\"2-使用-match-表达式处理\"><a class=\"anchor\" href=\"#2-使用-match-表达式处理\">#</a> 2. 使用 <code>match</code> 表达式处理</h3>\n<p><code>match</code> 是处理 <code>Result</code> 最基础、最明确的方式。Rust 的 <code>match</code> 是穷尽的（exhaustive），编译器会强制你处理所有可能的情况（<code>Ok</code> 和 <code>Err</code>），确保错误不会被意外忽略。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> main</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> number_str</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">42</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">    </span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    match</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">42</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">parse</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">i32</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">        // 如果结果是 Ok，`n` 会绑定到 Ok 内部的值</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">        Ok</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">n</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> =</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#59873A;--shiki-dark:#80A665\"> println!</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">解析成功！数字是: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> n</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">        // 如果结果是 Err，`e` 会绑定到 Err 内部的错误</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">        Err</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">e</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> =</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#59873A;--shiki-dark:#80A665\"> println!</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">解析失败！错误是: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">:?</span><span style=\"color:#999999;--shiki-dark:#666666\">&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> e</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    match</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">hello</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">parse</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">i32</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">        Ok</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">n</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> =</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#59873A;--shiki-dark:#80A665\"> println!</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">解析成功！数字是: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> n</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">        Err</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">e</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> =</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#59873A;--shiki-dark:#80A665\"> println!</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">解析失败！错误是: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">:?</span><span style=\"color:#999999;--shiki-dark:#666666\">&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> e</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<h2 id=\"三-运算符简洁的错误传播\"><a class=\"anchor\" href=\"#三-运算符简洁的错误传播\">#</a> 三、 <code>?</code> 运算符：简洁的错误传播</h2>\n<p>在实际开发中，函数内部常常会调用多个可能失败的操作。如果每个操作都使用 <code>match</code> 处理，代码会变得冗长和嵌套。<code>?</code> 运算符就是为了解决这个问题而生的，它用于实现错误的 <strong>传播（Propagation）</strong>，即如果内部调用失败，则立即将错误返回给当前函数的调用者。</p>\n<ul>\n<li><strong>核心功能</strong>：当 <code>Result</code> 的值为 <code>Ok(T)</code> 时，它会解包出 <code>T</code> 并让程序继续；如果值为 <code>Err(E)</code>，它会立刻中断当前函数的执行，并将 <code>Err(E)</code> 作为当前函数的返回值。</li>\n<li><strong>链式调用</strong>：<code>?</code> 运算符可以使一系列可能失败的操作代码保持线性、清晰和易读。</li>\n</ul>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">use</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">fs</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">File</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">use</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">io</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Read</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 链式调用示例：打开文件并读取其所有内容</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> read_username_from_file</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Result</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">String</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> io</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Error</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> mut</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> username</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">new</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">    </span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 1. File::open 返回 Result&#x3C;File, io::Error></span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    //    `?` 在成功时返回 File 实例，失败时将 io::Error 返回</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 2. .read_to_string 返回 Result&#x3C;usize, io::Error></span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    //    `?` 在成功时返回读取的字节数，失败时将 io::Error 返回</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">    File</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">open</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">username.txt</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">?.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">read_to_string</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;mut</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> username</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">?</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">    </span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">    Ok</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">username</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<h2 id=\"四-运算符的工作机制\"><a class=\"anchor\" href=\"#四-运算符的工作机制\">#</a> 四、 <code>?</code> 运算符的工作机制</h2>\n<h3 id=\"1-使用前提函数的返回类型\"><a class=\"anchor\" href=\"#1-使用前提函数的返回类型\">#</a> 1. 使用前提：函数的返回类型</h3>\n<p><code>?</code> 运算符只能在返回类型为 <code>Result&lt;T, E&gt;</code>、<code>Option&lt;T&gt;</code> 或其他实现了内部 <code>FromResidual</code> Trait 的函数中使用。这是因为 <code>?</code> 的核心行为是“提前返回一个 <code>Err</code> 或 <code>None</code>”，如果当前函数的签名不允许返回这样的类型，编译器就会报错。</p>\n<p><strong>错误示例</strong>： <code>main</code> 函数默认返回 <code>()</code>，不能使用 <code>?</code>。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">use</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">fs</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">File</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> main</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 编译错误！</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // error[E0277]: the `?` operator can only be used in a function that returns `Result` or `Option`</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> f</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> File</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">open</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">hello.txt</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">?</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<h3 id=\"2-错误类型的自动转换\"><a class=\"anchor\" href=\"#2-错误类型的自动转换\">#</a> 2. 错误类型的自动转换</h3>\n<p><code>?</code> 运算符还有一个强大的功能：如果它遇到的错误类型 <code>E1</code> 与当前函数签名的错误类型 <code>E2</code> 不同，它会尝试使用 <code>From</code> Trait 将 <code>E1</code> 自动转换为 <code>E2</code>。这是通过 <code>E2::from(E1)</code> 实现的。这在处理来自不同库的多种错误类型时非常有用。</p>\n<h2 id=\"五-应用程序顶层的错误处理\"><a class=\"anchor\" href=\"#五-应用程序顶层的错误处理\">#</a> 五、 应用程序顶层的错误处理</h2>\n<p>从 Rust 1.26 版本开始，<code>main</code> 函数可以返回一个 <code>Result</code>，只要其错误类型实现了 <code>std::process::Termination</code> Trait（<code>std::error::Error</code> Trait 的实现者通常也满足要求）。最常见的实践是让 <code>main</code> 返回 <code>Result&lt;(), Box&lt;dyn Error&gt;&gt;</code>。</p>\n<ul>\n<li><code>()</code> 作为成功类型：表示程序成功运行到结束，没有特定的返回值。</li>\n<li><code>Box&lt;dyn Error&gt;</code> 作为错误类型：这是一个 <strong>Trait 对象</strong>，可以容纳任何实现了 <code>std::error::Error</code> Trait 的错误类型。</li>\n</ul>\n<p><strong>为什么这样设计？</strong><br />\n一个复杂的程序可能会遇到多种错误，例如 <code>io::Error</code>（文件操作）、<code>serde_json::Error</code>（JSON 解析）或 <code>reqwest::Error</code>（网络请求）。</p>\n<p>借助 <code>?</code> 运算符的自动类型转换能力，任何具体的错误类型（如 <code>io::Error</code>）都可以被自动转换并装箱（Box）成一个 <code>Box&lt;dyn Error&gt;</code>。这使得我们可以在 <code>main</code> 函数中使用 <code>?</code> 来统一处理来自不同模块的异构错误，极大地简化了顶层错误处理逻辑。</p>\n",
            "tags": [
                "Programming",
                "Rust"
            ]
        },
        {
            "id": "https://soruan.github.io/2025/08/28/Programming/Rust/Trait%E4%B8%8E%E5%87%BD%E6%95%B0%E7%AD%BE%E5%90%8D%E7%AE%80%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89/",
            "url": "https://soruan.github.io/2025/08/28/Programming/Rust/Trait%E4%B8%8E%E5%87%BD%E6%95%B0%E7%AD%BE%E5%90%8D%E7%AE%80%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89/",
            "title": "Trait与函数签名简化（三）",
            "date_published": "2025-08-28T15:14:45.000Z",
            "content_html": "<h1 id=\"指定返回类型impl-trait-语法\"><a class=\"anchor\" href=\"#指定返回类型impl-trait-语法\">#</a> 指定返回类型：<code>impl Trait</code> 语法</h1>\n<h3 id=\"核心问题\"><a class=\"anchor\" href=\"#核心问题\">#</a> 核心问题</h3>\n<p>当函数返回一个复杂但实现了某个 trait 的类型时，如何简化函数签名，同时又不丢失必要的类型信息？</p>\n<p>这在以下两种情况中尤为突出：</p>\n<ol>\n<li>\n<p><strong>返回类型极其复杂</strong>：函数的返回值是一个由泛型和闭包等组合而成的具体类型，其名称可能非常长，甚至在语法上无法直接写出。这在 Rust 的迭代器适配器链中尤为常见。</p>\n<p>例如，对于下面的函数，其返回值的具体类型是什么？</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> get_even_plus_one</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">numbers</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Vec</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">u32</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> ???</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">    numbers</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">into_iter</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">        .</span><span style=\"color:#59873A;--shiki-dark:#80A665\">filter</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">|&#x26;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">n</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">|</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> n</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> %</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 2</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> ==</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 0</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">        .</span><span style=\"color:#59873A;--shiki-dark:#80A665\">map</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">|</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">n</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">|</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> n</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> +</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 1</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<p>其具体的返回类型是 <code>std::iter::Map&lt;std::iter::Filter&lt;std::vec::IntoIter&lt;u32&gt;, _&gt;, _&gt;</code>。这种类型既冗长又暴露了实现细节，并且由于闭包的存在，我们无法在代码中显式地写出它。</p>\n</li>\n<li>\n<p><strong>返回类型是实现细节</strong>：作为 API 的设计者，我们可能不希望将返回值的具体类型暴露给调用者。我们只想承诺返回一个“具备某种能力”的对象，而这个对象的具体实现可能会在未来版本中更改，只要它仍然具备承诺的能力即可。</p>\n</li>\n</ol>\n<h3 id=\"impl-trait只描述能力不暴露类型\"><a class=\"anchor\" href=\"#impl-trait只描述能力不暴露类型\">#</a> <code>impl Trait</code>：只描述能力，不暴露类型</h3>\n<p><code>impl Trait</code> 语法允许我们在函数签名中指定一个抽象的返回类型，该类型是静态分发的（在编译期确定）。我们不关心返回值的具体类型是什么，只关心它实现了哪个 <code>Trait</code>。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 我们承诺返回一个“实现了 Iterator trait 的东西”，其迭代的元素类型是 u32</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> get_even_plus_one</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">numbers</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Vec</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">u32</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> impl</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Iterator</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Item</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> u32</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">    numbers</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">into_iter</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">        .</span><span style=\"color:#59873A;--shiki-dark:#80A665\">filter</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">|&#x26;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">n</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">|</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> n</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> %</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 2</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> ==</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 0</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">        .</span><span style=\"color:#59873A;--shiki-dark:#80A665\">map</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">|</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">n</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">|</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> n</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> +</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 1</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> main</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> my_numbers</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> vec!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">[</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 2</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 3</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 4</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 5</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 6</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">]</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">    </span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // a_special_iterator 的具体类型被编译器隐藏了</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 我们只知道它可以像任何迭代器一样被使用</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> a_special_iterator</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> get_even_plus_one</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">my_numbers</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    for</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> num</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> in</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> a_special_iterator</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        println!</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> num</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 输出 3, 5, 7</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<p><strong>优势总结</strong>：</p>\n<ul>\n<li><strong>简化签名</strong>：隐藏了复杂的具体类型。</li>\n<li><strong>封装实现</strong>：允许库作者在不破坏兼容性的前提下改变内部实现。</li>\n<li><strong>零成本抽象</strong>：<code>impl Trait</code> 是静态分发的，没有运行时开销。</li>\n</ul>\n<h3 id=\"与-c-的对比\"><a class=\"anchor\" href=\"#与-c-的对比\">#</a> 与 C++ 的对比</h3>\n<p><code>impl Trait</code> 的概念在 C++ 中可以找到一些类似的模式，但 Rust 提供了更强的编译期保证。</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">C++ 方式</th>\n<th style=\"text-align:left\">描述</th>\n<th style=\"text-align:left\">优点</th>\n<th style=\"text-align:left\">缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\"><code>auto</code> 返回类型</td>\n<td style=\"text-align:left\">使用 <code>auto</code> 关键字让编译器自动推导返回类型，从而隐藏复杂性。</td>\n<td style=\"text-align:left\">隐藏了复杂的模板类型名，简化了函数签名。</td>\n<td style=\"text-align:left\"><code>auto</code> 只隐藏了类型，没有提供任何关于“返回值能力”的契约或接口信息。调用者必须阅读文档或源码才能知道返回的对象能做什么。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">返回基类指针/引用</td>\n<td style=\"text-align:left\">返回一个指向基类（接口类）的指针或引用，以实现多态。</td>\n<td style=\"text-align:left\">在函数签名中明确了接口信息。</td>\n<td style=\"text-align:left\">通常涉及动态分发（虚函数）和堆内存分配（如 <code>std::unique_ptr</code>），会带来运行时开销。</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"c-auto-示例\"><a class=\"anchor\" href=\"#c-auto-示例\">#</a> C++ <code>auto</code> 示例</h4>\n<p>下面的代码使用 <code>auto</code> 隐藏了 C++20 ranges 库生成的复杂类型。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-cpp\"><span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">#</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\">include</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> &#x3C;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">vector</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">></span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">#</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\">include</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> &#x3C;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">iostream</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">></span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">#</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\">include</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> &#x3C;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">ranges</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">></span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 使用 auto，我们也不用写出 ranges 生成的那个复杂类型名</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">auto</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> get_even_plus_one</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">const</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#999999;--shiki-dark:#666666\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">vector</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">int</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> numbers</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    return</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> numbers</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">         |</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#999999;--shiki-dark:#666666\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">views</span><span style=\"color:#999999;--shiki-dark:#666666\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">filter</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">[</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">]</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">int</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> n</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">&#123;</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> return</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> n </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">%</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 2</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> ==</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 0</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">&#125;</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">         |</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#999999;--shiki-dark:#666666\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">views</span><span style=\"color:#999999;--shiki-dark:#666666\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">transform</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">[</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">]</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">int</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> n</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">&#123;</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> return</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> n </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">+</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 1</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">&#125;</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">int</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> main</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    std</span><span style=\"color:#999999;--shiki-dark:#666666\">::</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">vector</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">int</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> my_numbers </span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 2</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 3</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 4</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 5</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 6</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    auto</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> a_special_range </span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> get_even_plus_one</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">my_numbers</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    for</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">int</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> num </span><span style=\"color:#999999;--shiki-dark:#666666\">:</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> a_special_range</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        std</span><span style=\"color:#999999;--shiki-dark:#666666\">::</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">cout </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> num </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#999999;--shiki-dark:#666666\">::</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">endl</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 输出 3, 5, 7</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<p>相较于 C++ 的 <code>auto</code>，Rust 的 <code>impl Trait</code> 不仅隐藏了类型，还明确地在编译期强制约束了该类型必须满足的 <code>Trait</code> 契约，提供了更好的类型安全和代码清晰度。</p>\n",
            "tags": [
                "Programming",
                "Rust"
            ]
        },
        {
            "id": "https://soruan.github.io/2025/08/27/Programming/Rust/Trait%E4%B8%8E%E6%B3%9B%E5%9E%8B%E7%BA%A6%E6%9D%9F%EF%BC%88%E4%BA%8C%EF%BC%89/",
            "url": "https://soruan.github.io/2025/08/27/Programming/Rust/Trait%E4%B8%8E%E6%B3%9B%E5%9E%8B%E7%BA%A6%E6%9D%9F%EF%BC%88%E4%BA%8C%EF%BC%89/",
            "title": "Trait与泛型约束（二）",
            "date_published": "2025-08-27T13:54:39.000Z",
            "content_html": "<h1 id=\"trait-与泛型约束trait-bounds\"><a class=\"anchor\" href=\"#trait-与泛型约束trait-bounds\">#</a> Trait 与泛型约束：Trait Bounds</h1>\n<p><code>Trait</code> 约束（Trait Bounds）是 Rust 泛型系统中的核心特性，它允许我们对泛型参数可以使用的类型进行限制。其功能和设计哲学与 C++20 中引入的 <code>Concepts</code> 非常相似，主要解决了传统 C++ 模板（Templates）因“鸭子类型”而导致的编译错误信息晦涩难懂的问题。</p>\n<h3 id=\"一-c-模板的历史问题鸭子类型\"><a class=\"anchor\" href=\"#一-c-模板的历史问题鸭子类型\">#</a> 一、C++ 模板的历史问题：鸭子类型</h3>\n<p>在 C++20 引入 <code>Concepts</code> 之前，C++ 模板遵循“鸭子类型”原则：“如果一个东西走起来像鸭子，叫起来也像鸭子，那它就是一只鸭子”。编译器不会在定义模板时检查类型的合法性，而是在模板被具体类型实例化时，才去检查模板内的代码是否对该类型有效。</p>\n<p>这种机制导致，如果传入的类型不满足模板内部的隐式要求（例如缺少某个成员函数），编译器不会直接提示“类型不满足约束”，而是会深入模板内部，报告一个具体但脱离上下文的、往往非常冗长的编译错误，增加了调试难度。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-cpp\"><span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">#</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\">include</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> &#x3C;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">iostream</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">></span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">#</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\">include</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> &#x3C;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">string</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">></span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 此模板函数隐式地期望类型 T 有一个 .summarize() 成员函数</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">template</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">typename</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> T</span><span style=\"color:#999999;--shiki-dark:#666666\">></span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">void</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> print_summary</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">const</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> T</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> item</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    std</span><span style=\"color:#999999;--shiki-dark:#666666\">::</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">cout </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> item</span><span style=\"color:#999999;--shiki-dark:#666666\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">summarize</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#999999;--shiki-dark:#666666\">::</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">endl</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">struct</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Article</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    std</span><span style=\"color:#999999;--shiki-dark:#666666\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">string</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> summarize</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> const</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> return</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">This is an article.</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">int</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> main</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">    Article article</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    print_summary</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">article</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // OK，Article 实现了 .summarize()</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    int</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> my_number </span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 5</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 编译失败：int 类型没有 .summarize() 成员函数</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 编译器会产生一大堆晦涩难懂的模板错误信息</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // print_summary(my_number); </span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<h3 id=\"二-基本的-trait-bound-语法\"><a class=\"anchor\" href=\"#二-基本的-trait-bound-语法\">#</a> 二、基本的 Trait Bound 语法</h3>\n<p>Rust 通过 Trait Bounds 在编译时就对泛型参数进行约束，从根本上解决了上述问题。基本语法是 <code>&lt;T: Trait&gt;</code>，它明确告诉编译器：任何用于实例化泛型参数 <code>T</code> 的类型，都<strong>必须</strong>实现了指定的 <code>Trait</code>。</p>\n<p>这样，编译器就可以在函数定义层面进行检查。如果一个类型不满足约束，编译器会立即给出一个清晰、准确的错误提示，指出哪个 Trait 未被实现。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 定义一个 Summary Trait</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">trait</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Summary</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> summarize</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">struct</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Article</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">    headline</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 为 Article 实现 Summary Trait</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">impl</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Summary</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> for</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Article</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> summarize</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        format!</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Article: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">headline</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// &#x3C;T: Summary> 就是 Trait Bound</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 它约束了 T 必须是实现了 Summary Trait 的类型</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 编译器因此可以保证 item.summarize() 调用是合法的</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> notify</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">T</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Summary</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">item</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">T</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    println!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Breaking News! </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> item</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">summarize</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> main</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> article</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Article</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> headline</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Rust is Awesome</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">to_string</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    notify</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">article</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // OK</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> my_number</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 5</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 编译失败：编译器会明确提示 a trait bound was not satisfied:</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // the trait `Summary` is not implemented for `&#123;integer&#125;`</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // notify(&#x26;my_number);</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<p>这与 C++20 <code>Concepts</code> 的作用完全相同，都是将隐式要求明确化。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-cpp\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// C++20 Concepts</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">#</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\">include</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> &#x3C;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">iostream</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">></span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">#</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\">include</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> &#x3C;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">string</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">></span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">#</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\">include</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> &#x3C;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">concepts</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">></span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">template</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">typename</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> T</span><span style=\"color:#999999;--shiki-dark:#666666\">></span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">concept</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> HasSummary </span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> requires</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">const</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> T</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> t</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> t</span><span style=\"color:#999999;--shiki-dark:#666666\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">summarize</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#999999;--shiki-dark:#666666\">::</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">convertible_to</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#59873A;--shiki-dark:#80A665\">std</span><span style=\"color:#999999;--shiki-dark:#666666\">::</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">string</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 约束 T 必须满足 HasSummary</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">template</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">HasSummary</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> T</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">void</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> notify</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">const</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> T</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> item</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    std</span><span style=\"color:#999999;--shiki-dark:#666666\">::</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">cout </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> item</span><span style=\"color:#999999;--shiki-dark:#666666\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">summarize</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#999999;--shiki-dark:#666666\">::</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">endl</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 此时，用 int 调用 notify 会得到一个关于 Concept 不满足的清晰错误</span></span></code></pre>\n<h3 id=\"三-指定多个-trait-bound-语法\"><a class=\"anchor\" href=\"#三-指定多个-trait-bound-语法\">#</a> 三、指定多个 Trait Bound: <code>+</code> 语法</h3>\n<p>当泛型参数需要满足多个约束时，可以使用 <code>+</code> 语法将多个 Trait Bound 组合起来。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">use</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">fmt</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Display</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Debug</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">trait</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Summary</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> summarize</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">struct</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Article</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> headline</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">impl</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Summary</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> for</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Article</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> summarize</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> format!</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Article: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">headline</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">impl</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Display</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> for</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Article</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> fmt</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> f</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;mut</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">fmt</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Formatter</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#999999;--shiki-dark:#666666\">'</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">_</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">fmt</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Result</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> write!</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">f</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">headline</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">impl</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Debug</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> for</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Article</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> fmt</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> f</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;mut</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">fmt</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Formatter</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#999999;--shiki-dark:#666666\">'</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">_</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">fmt</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Result</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> write!</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">f</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Article &#x3C;!--swig￼0--></span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">headline</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// T 必须同时实现 Summary 和 Display 两个 Trait</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> notify_and_print</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">T</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Summary</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> +</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Display</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">item</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">T</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    println!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Summary: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> item</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">summarize</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // item 可以直接用 &#123;&#125; 打印，因为 T 实现了 Display</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    println!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Displaying item: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> item</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> main</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> article</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Article</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> headline</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Rust is Awesome</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">to_string</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    notify_and_print</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">article</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<p>这类似于 C++20 <code>Concepts</code> 中使用 <code>&amp;&amp;</code> 来组合多个约束。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-cpp\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 伪代码示例</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">template</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">typename</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> T</span><span style=\"color:#999999;--shiki-dark:#666666\">></span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">concept</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> IsDisplayable </span><span style=\"color:#999999;--shiki-dark:#666666\">=</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> requires</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">const</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> T</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> t</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> /* ... */</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 要求 T 同时满足 HasSummary 和 IsDisplayable</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">template</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">typename</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> T</span><span style=\"color:#999999;--shiki-dark:#666666\">></span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    requires</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> HasSummary</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">T</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;&#x26;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> IsDisplayable</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">T</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">void</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> some_function</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">const</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> T</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> item</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> /* ... */</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<h3 id=\"四-使用-where-子句处理复杂约束\"><a class=\"anchor\" href=\"#四-使用-where-子句处理复杂约束\">#</a> 四、使用 <code>where</code> 子句处理复杂约束</h3>\n<p>当泛型参数较多，或者每个参数的 Trait Bound 列表很长时，函数签名会变得非常臃肿和难以阅读。此时，可以使用 <code>where</code> 子句来声明约束，将函数签名（做什么）和泛型约束（对谁做）分离开，提高代码的可读性。</p>\n<p><strong>未使用 <code>where</code> 的写法：</strong></p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"># </span><span style=\"color:#1E754F;--shiki-dark:#4D9375\">use</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">fmt</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Display</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Debug</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"># </span><span style=\"color:#1E754F;--shiki-dark:#4D9375\">use</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">cmp</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">PartialEq</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> some_function</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">T</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Display</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> +</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Clone</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> U</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Clone</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> +</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Debug</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">t</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">T</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> u</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">U</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> i32</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 0</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<p><strong>使用 <code>where</code> 子句的写法：</strong></p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">use</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">fmt</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Display</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Debug</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">use</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">cmp</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">PartialEq</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 使用 where 子句将复杂的约束整理到函数签名之后</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> compare_and_print</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">T</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> U</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">a</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">T</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> b</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">U</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">where</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">    T</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Display</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> +</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> PartialEq</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">U</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // T 必须能打印，且能与类型 U 进行相等比较</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">    U</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Display</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> +</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Debug</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">        // U 必须能打印，且支持调试打印</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    println!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">a: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> a</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    println!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">b: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> b</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    println!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Are they equal? </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> a</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">eq</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">b</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    println!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Debug info for b: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">:?</span><span style=\"color:#999999;--shiki-dark:#666666\">&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> b</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<p>C++20 的 <code>requires</code> 子句也提供了类似的功能，用于将复杂的约束条件整理在函数签名之后。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-cpp\"><span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">#</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\">include</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> &#x3C;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">concepts</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">></span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">#</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\">include</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> &#x3C;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">iostream</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">></span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 伪代码，仅为演示结构</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">template</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">typename</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> T</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> concept</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> IsDisplayable </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> /* ... */</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">template</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">typename</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> T</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> concept</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> IsDebuggable </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> /* ... */</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">template</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">typename</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> T</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> typename</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> U</span><span style=\"color:#999999;--shiki-dark:#666666\">></span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">void</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> compare_and_print</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">const</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> T</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> a</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> const</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> U</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> b</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    requires</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#999999;--shiki-dark:#666666\">::</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">equality_comparable_with</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">T</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> U</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;&#x26;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">             IsDisplayable</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">T</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;&#x26;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">             IsDisplayable</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">U</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;&#x26;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">             IsDebuggable</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">U</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 函数体</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n",
            "tags": [
                "Programming",
                "Rust"
            ]
        },
        {
            "id": "https://soruan.github.io/2025/08/27/Programming/Rust/Trait%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%EF%BC%88%E4%B8%80%EF%BC%89/",
            "url": "https://soruan.github.io/2025/08/27/Programming/Rust/Trait%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%EF%BC%88%E4%B8%80%EF%BC%89/",
            "title": "Trait的基本使用（一）",
            "date_published": "2025-08-27T13:54:13.000Z",
            "content_html": "<h2 id=\"一-trait-的本质定义共享行为\"><a class=\"anchor\" href=\"#一-trait-的本质定义共享行为\">#</a> 一、<strong>Trait 的本质：定义共享行为</strong></h2>\n<ul>\n<li><strong>核心类比 (C++)</strong>: <code>trait</code> ≈ 抽象基类 (Abstract Base Class) / 纯虚接口 (Interface)。</li>\n<li><strong>关键区别</strong>: Rust 的 <code>trait</code> 是编译期抽象，且更侧重于行为的“组合”而非类型的“继承”。</li>\n<li><strong>要点</strong>:\n<ul>\n<li>如何定义一个 <code>trait</code>？</li>\n<li>如何为一个类型实现 (<code>impl</code>) <code>trait</code>？</li>\n<li>提供默认实现 (Default Implementation) -&gt; 对比 C++ 抽象基类中的虚函数实现。</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"1-c-中的类比抽象基类\"><a class=\"anchor\" href=\"#1-c-中的类比抽象基类\">#</a> 1. C++ 中的类比：抽象基类</h3>\n<p>在传统的面向对象语言如 C++ 中，实现共享行为通常通过定义一个抽象基类来完成。该基类包含纯虚函数，其他类通过继承这个抽象基类并实现这些纯虚函数来获得共享的行为。</p>\n<h4 id=\"2-定义和实现trait\"><a class=\"anchor\" href=\"#2-定义和实现trait\">#</a> 2、定义和实现trait</h4>\n<p>在 Rust 中，我们通过定义 <code>trait</code> 和为类型 <code>impl</code> 这个 <code>trait</code> 来实现。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 1. 定义一个 Trait，就像定义一个接口</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 它只包含方法的签名，不包含具体实现。</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">pub</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> trait</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Summary</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> summarize</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 定义两个不同的结构体</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">pub</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> struct</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> NewsArticle</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    pub</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> headline</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    pub</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> author</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    pub</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> content</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">pub</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> struct</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Tweet</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    pub</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> username</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    pub</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> content</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 2. 为 NewsArticle 类型实现 (impl) Summary trait</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 这告诉编译器，NewsArticle 实例现在具备了 summarize 的能力。</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">impl</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Summary</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> for</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> NewsArticle</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> summarize</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        format!</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">, by </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">headline</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">author</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 3. 为 Tweet 类型也实现 Summary trait</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">impl</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Summary</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> for</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Tweet</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> summarize</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        format!</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">@</span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> tweeted: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">username</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">content</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> main</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> article</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> NewsArticle</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">        headline</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Rust wins another award!</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">        author</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Rustacean</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">        content</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">...</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> tweet</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Tweet</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">        username</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">johndoe</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">        content</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">I really love Rust's trait system!</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    println!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">New article: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> article</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">summarize</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    println!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">New tweet: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> tweet</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">summarize</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<h4 id=\"3-提供默认实现\"><a class=\"anchor\" href=\"#3-提供默认实现\">#</a> 3、提供默认实现</h4>\n<p>Trait 中的方法可以拥有默认实现。这意味着实现该 Trait 的类型可以无需覆盖这些方法，直接使用默认行为。这类似于 C++ 中拥有函数体的虚函数。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">pub</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> trait</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Summary</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> summarize</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 提供一个有默认实现的方法</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 任何实现 Summary 的类型都会自动获得这个方法</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> read_more</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">        String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">(Read more...)</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 默认行为</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 为 NewsArticle 实现时，我们只关心必须实现的 summarize</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">impl</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Summary</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> for</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> NewsArticle</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> summarize</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        format!</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">, by </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">headline</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">author</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">    </span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 我们可以选择覆盖(override)默认实现</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> read_more</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        format!</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Read more from </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">...</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">author</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">impl</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Summary</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> for</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Tweet</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // Tweet 只实现必须的 summarize，它将免费获得默认的 read_more</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> summarize</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        format!</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">@</span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> tweeted: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">username</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">content</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> main</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> article</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> NewsArticle</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">        headline</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Rust wins another award!</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">        author</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Rustacean</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">        content</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">...</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> tweet</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Tweet</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">        username</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">johndoe</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">        content</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">I really love Rust's trait system!</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">    </span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    println!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> article</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">read_more</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 输出: \"Read more from Rustacean...\"</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    println!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> tweet</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">read_more</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">   // 输出: \"(Read more...)\"</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<p>类似于c++中的普通虚函数，而不是纯虚函数</p>\n<h4 id=\"问题\"><a class=\"anchor\" href=\"#问题\">#</a> 问题</h4>\n<ol>\n<li>\n<p><strong>必须实现 Trait 中的所有方法吗？</strong></p>\n<p>不是。只需要实现那些没有默认实现的方法，这些方法是强制必须实现的。</p>\n</li>\n<li>\n<p><strong>大部分 Trait 的方法都是默认方法吗？</strong></p>\n<p>是的，Rust 标准库遵循一种“最小化 <code>trait</code>”的设计模式。该模式要求实现者仅需提供一两个最核心的方法，<code>trait</code> 会基于这些核心方法，通过默认实现提供大量便捷的高级功能。</p>\n<p>典型的例子是 <code>Iterator</code> trait。要使自定义类型成为一个迭代器，<strong>唯一必须实现的方法就是 <code>next()</code></strong>。一旦实现了 <code>next()</code>，类型就自动获得了数十个强大的方法，如 <code>map()</code>、<code>filter()</code>、<code>fold()</code>、<code>collect()</code> 等。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 示例：一个从 1 数到 5 的简单迭代器</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">struct</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Counter</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">    current</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> u32</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">    max</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> u32</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 我们只需要实现 Iterator trait</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">impl</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Iterator</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> for</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Counter</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    type</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Item</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> u32</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 关联类型，指定迭代器返回的元素类型</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 这是我们唯一需要手写的核心方法！</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> next</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;mut</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Option</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">Self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Item</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">        if</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">current </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">max </span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A65E2B;--shiki-dark:#C99076\">            self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">current </span><span style=\"color:#999999;--shiki-dark:#666666\">+=</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 1</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">            Some</span><span style=\"color:#a13865;--shiki-dark:#d9739f\">(</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">current</span><span style=\"color:#a13865;--shiki-dark:#d9739f\">)</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">        </span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">&#125;</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> else</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">            None</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">        </span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> main</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> counter</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Counter</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> current</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 0</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> max</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 5</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">    </span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">    // 基于 next() 获得的免费功能</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> sum_of_squares_of_even_numbers</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> u32</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> counter</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">        .</span><span style=\"color:#59873A;--shiki-dark:#80A665\">filter</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">|&#x26;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">num</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">|</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> num</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> %</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 2</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> ==</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 0</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // filter 是默认方法</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">        .</span><span style=\"color:#59873A;--shiki-dark:#80A665\">map</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">|</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">num</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">|</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> num</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> *</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> num</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">       // map 是默认方法</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">        .</span><span style=\"color:#59873A;--shiki-dark:#80A665\">sum</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">                     // sum 也是默认方法</span></span>\n<span class=\"line\"><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">        </span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    println!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Sum: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> sum_of_squares_of_even_numbers</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 输出: Sum: 20 (即 2*2 + 4*4)</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n<p>这些默认方法内部的实现，全都是通过反复调用你提供的那个 <code>next()</code> 方法来完成的。</p>\n<ul>\n<li><strong>与C++的区别</strong>: C++ 标准库不把 <code>map</code>, <code>filter</code> 等功能放在迭代器基类中，而是提供大量的<strong>全局算法函数</strong>（如 <code>std::transform</code>, <code>std::copy_if</code>），这些函数接受一对迭代器作为参数。Rust 的方法链调用方式通常被认为可读性更高。</li>\n</ul>\n</li>\n<li>\n<p><strong>如果 Trait 全是默认方法，编译器如何知道类型实现了它？</strong></p>\n<p>Rust 遵循“显式优于隐式”的原则。即使一个 <code>trait</code> 的所有方法都有默认实现，你<strong>仍然必须为这个类型写一个空的 <code>impl</code> 块</strong>来显式地告诉编译器该类型实现了这个 <code>trait</code>。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 假设 MyTrait 的所有方法都有默认实现</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">trait</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> MyTrait</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> do_something</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> println!</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Default action</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">struct</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> MyType</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 必须有这个空的 impl 块</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">impl</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> MyTrait</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> for</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> MyType</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> main</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> instance</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> MyType</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">    instance</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">do_something</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 可以调用</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n</li>\n</ol>\n<h2 id=\"二-trait-的实现规则一致性与孤儿规则\"><a class=\"anchor\" href=\"#二-trait-的实现规则一致性与孤儿规则\">#</a> 二、<strong>Trait 的实现规则：一致性与孤儿规则</strong></h2>\n<ul>\n<li><strong>核心问题</strong>: 谁有权为哪个类型实现哪个 <code>trait</code>？</li>\n<li><strong>C++ 对比</strong>: C++ 没有这个概念，任何地方都可以为任何类写一个自由函数，这有时会导致混乱。孤儿规则系统性地解决了这个问题，保证了代码库的一致性和可维护性。</li>\n<li><strong>要点</strong>: 规则详解：“只要 <code>trait</code> 或者类型其中之一属于当前 <code>crate</code>，就可以为其实现 <code>trait</code>”。</li>\n</ul>\n<h4 id=\"1-c中的对应操作\"><a class=\"anchor\" href=\"#1-c中的对应操作\">#</a> 1、C++中的对应操作</h4>\n<p>在 C++ 中，允许任何人在任何地方为任何类型实现自由函数或重载操作符（只要能访问其定义）。这种灵活性可能导致不可预知的混乱，例如两个不同的第三方库可能为同一个标准库类型重载了相同的操作符，从而引发冲突和不确定性。</p>\n<h4 id=\"2-孤儿原则\"><a class=\"anchor\" href=\"#2-孤儿原则\">#</a> 2、孤儿原则</h4>\n<p>要为一个类型 <code>T</code> 实现一个 <code>trait Tr</code>，那么<strong>类型 <code>T</code></strong> 或 <strong><code>trait Tr</code></strong>，至少有一个必须是在当前 <code>crate</code>（可理解为当前项目或库）中定义的。</p>\n<p>换言之，<strong>不能为一个外部的类型实现一个外部的 <code>trait</code></strong>。这样的实现会像一个没有归属的“孤儿”，因为它既不属于类型 <code>T</code> 的维护者，也不属于 <code>trait Tr</code> 的维护者。</p>\n<p><strong>允许的情况</strong></p>\n<ul>\n<li>\n<p><strong>为 “外部类型” 实现 “本地 Trait”</strong></p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 1. 定义我们自己的 trait，这是“本地的”。</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">trait</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> CsvDisplay</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> to_csv</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 2. 为标准库的 Vec&#x3C;String> (外部类型) 实现我们本地的 CsvDisplay trait。</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">//    这是合法的，因为 `CsvDisplay` trait 是在我们当前的 crate 中定义的。</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">impl</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> CsvDisplay</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> for</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Vec</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">String</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> to_csv</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> String</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A65E2B;--shiki-dark:#C99076\">        self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">join</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">,</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> main</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> data</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> vec!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">[</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">        String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">name</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">        String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">age</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">        String</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#59873A;--shiki-dark:#80A665\">from</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">city</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">]</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    println!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> data</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#59873A;--shiki-dark:#80A665\">to_csv</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 输出: name,age,city</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n</li>\n<li>\n<p><strong>为 “本地类型” 实现 “外部 Trait”</strong></p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// my_crate/src/main.rs</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">use</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">fmt</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 1. 定义我们自己的 struct，这是“本地的”。</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">struct</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Point</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">    x</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> i32</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#B07D48;--shiki-dark:#BD976A\">    y</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> i32</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 2. 为我们本地的 Point 类型实现标准库的 `Display` trait (外部 trait)。</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">//    这是合法的，因为 `Point` 类型是在我们当前的 crate 中定义的。</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">impl</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> fmt</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Display</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> for</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Point</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> fmt</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> f</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;mut</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> fmt</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Formatter</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#999999;--shiki-dark:#666666\">'</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">_</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#59873A;--shiki-dark:#80A665\"> fmt</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Result</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        write!</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">f</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">(</span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">, </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">)</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">x</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> self</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">.</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">y</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> main</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">    let</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> p</span><span style=\"color:#999999;--shiki-dark:#666666\"> =</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Point</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> x</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 10</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> y</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\">5</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">    println!</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">The point is at: </span><span style=\"color:#999999;--shiki-dark:#666666\">&#123;&#125;</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> p</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> // 输出: The point is at: (10, -5)</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n</li>\n</ul>\n<p><strong>违反孤儿原则的情况</strong></p>\n<p>你不能为标准库的 <code>Vec&lt;i32&gt;</code>（外部类型）实现标准库的 <code>fmt::Display</code>（外部 trait），因为类型和 trait 都定义在当前 <code>crate</code> 之外。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// my_crate/src/main.rs</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">use</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> std</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">fmt</span><span style=\"color:#999999;--shiki-dark:#666666\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 尝试为外部类型 `Vec&#x3C;i32>` 实现外部 trait `Display`</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">// 这段代码无法通过编译！</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">impl</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> fmt</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Display</span><span style=\"color:#1E754F;--shiki-dark:#4D9375\"> for</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\"> Vec</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">i32</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#1E754F;--shiki-dark:#4D9375\">    fn</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> fmt</span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">(</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x26;</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">self</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\"> f</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">:</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> &#x26;mut</span><span style=\"color:#59873A;--shiki-dark:#80A665\"> fmt</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Formatter</span><span style=\"color:#999999;--shiki-dark:#666666\">&#x3C;</span><span style=\"color:#999999;--shiki-dark:#666666\">'</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">_</span><span style=\"color:#999999;--shiki-dark:#666666\">></span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">)</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> -</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#59873A;--shiki-dark:#80A665\"> fmt</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">::</span><span style=\"color:#2E8F82;--shiki-dark:#5DA994\">Result</span><span style=\"color:#999999;--shiki-dark:#666666\"> </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#123;</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\">        // ... 实现逻辑 ...</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        write!</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">(</span><span style=\"color:#B07D48;--shiki-dark:#BD976A\">f</span><span style=\"color:#999999;--shiki-dark:#666666\">,</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">A vector of integers</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#a65e2b;--shiki-dark:#d4976c\">)</span></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">    </span><span style=\"color:#1e754f;--shiki-dark:#4d9375\">&#125;</span></span>\n<span class=\"line\"><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">&#125;</span></span></code></pre>\n",
            "tags": [
                "Programming",
                "Rust"
            ]
        },
        {
            "id": "https://soruan.github.io/2025/08/24/Linux/%E5%AF%B9CPU%E9%AB%98%E9%80%9F%E7%BC%93%E5%AD%98%E7%9A%84%E7%90%86%E8%A7%A3/",
            "url": "https://soruan.github.io/2025/08/24/Linux/%E5%AF%B9CPU%E9%AB%98%E9%80%9F%E7%BC%93%E5%AD%98%E7%9A%84%E7%90%86%E8%A7%A3/",
            "title": "对CPU高速缓存的理解",
            "date_published": "2025-08-24T15:38:07.000Z",
            "content_html": "<h3 id=\"一-缓存失效的背后三大核心机制\"><a class=\"anchor\" href=\"#一-缓存失效的背后三大核心机制\">#</a> <strong>一、缓存失效的背后：三大核心机制</strong></h3>\n<p><strong>为何CPU高速缓存中的数据会“失效”，其背后的主要机制有哪些？</strong></p>\n<blockquote>\n<p>CPU高速缓存是提升性能的关键，但它并非一个静态的存储区域。缓存中的数据会因为容量限制、多核间的数据同步以及与外部设备交互等多种原因被替换或宣告无效，理解这些机制是优化性能的基础。</p>\n</blockquote>\n<p>CPU缓存中的数据“失效”，通常指数据被替换或被标记为无效，使其无法再被CPU使用。这一过程主要由以下三种机制驱动：</p>\n<ol>\n<li><strong>容量竞争与替换</strong>：CPU缓存的容量非常有限。当缓存已满时，若要载入新的数据，就必须按照某种替换算法（如 <strong>LRU - 最近最少使用算法</strong>）丢弃一些现有的数据。这是最常见和基本的“失效”形式，由缓存自身的物理限制导致。</li>\n<li><strong>多核一致性协议</strong>：在多核处理器中，同一份内存数据可能被多个核心同时加载到各自的缓存中。如果其中一个核心修改了这份数据，其他核心缓存中的副本就变成了过时的“脏数据”。为了保证数据一致性，硬件层面的缓存一致性协议（如 <strong>MESI协议</strong>）会强制将其他核心的这份数据副本标记为“无效”，迫使它们在需要时重新从内存或已更新的核心获取最新版本。</li>\n<li><strong>外部I/O操作</strong>：当外部设备（如网卡、硬盘控制器）通过 <strong>DMA (直接内存访问)</strong> 技术绕过CPU直接向主内存写入数据时，CPU缓存中可能还保留着这块内存区域的旧副本。由于CPU对此操作无感知，其缓存数据已然过期。在这种情况下，必须由软件（通常是驱动程序）显式地执行缓存无效化指令，才能避免CPU读到脏数据。</li>\n</ol>\n<hr />\n<h3 id=\"二-打破亲和性任务迁移的驱动力\"><a class=\"anchor\" href=\"#二-打破亲和性任务迁移的驱动力\">#</a> <strong>二、打破亲和性：任务迁移的驱动力</strong></h3>\n<p><strong>在调度器倾向于维持“CPU亲和性”的情况下，究竟是哪些更高优先级的考量会促使一个任务被主动迁移到其他CPU核心上执行？</strong></p>\n<blockquote>\n<p>为了最大化利用缓存，操作系统调度器会尽量让一个任务保持在同一个CPU核心上运行。然而，为了保证整个系统的响应速度和资源利用率，调度器在某些特定情境下，不得不打破这种“亲和性”，主动进行跨核心的任务迁移。</p>\n</blockquote>\n<p>尽管维持CPU亲和性可以带来显著的性能优势，但操作系统调度器为了更宏观的目标，会在以下几种主要情境下主动进行任务迁移：</p>\n<ol>\n<li><strong>负载均衡 (Load Balancing)</strong>：这是任务迁移最主要的原因。如果系统中的任务都集中在少数几个核心上，导致它们不堪重负，而其他核心却处于空闲，会造成巨大的资源浪费。调度器的负载均衡模块会周期性地检查各核心的负载，并在发现严重失衡时，将任务从繁忙的核心迁移到空闲的核心，以实现所有计算资源的充分利用。</li>\n<li><strong>提升任务响应速度</strong>：当一个因I/O等待而休眠的任务被唤醒时，它原本所在的“亲和”核心可能正在处理一个高优先级的长耗时任务。为了让被唤醒的任务能尽快得到执行，而不是在原核心上排队等待，调度器可能会选择将它迁移到一个当前负载较低或空闲的核心上。</li>\n<li><strong>功耗与性能策略</strong>：现代CPU的功耗管理非常复杂。例如，为了节省能源，某些核心可能处于深度睡眠状态。此时，将一个新任务迁移到已经处于活跃状态的核心上，可能比花费时间和功耗去唤醒一个睡眠核心更具效率。</li>\n</ol>\n<hr />\n<h3 id=\"三-缓存数据的寿命由竞争决定\"><a class=\"anchor\" href=\"#三-缓存数据的寿命由竞争决定\">#</a> <strong>三、缓存数据的“寿命”：由竞争决定</strong></h3>\n<p><strong>缓存中某个任务的“热数据”能够保存多久，是由时间决定的，还是由CPU核心的竞争和访问模式决定的？</strong></p>\n<blockquote>\n<p>当一个任务被换下CPU时，它留在缓存中的“热数据”并不会立刻消失，但其“寿命”却难以预测。这份数据的存留时间并非由一个固定的计时器来管理，而是取决于后续在该CPU核心上运行的其他任务对其造成的影响。</p>\n</blockquote>\n<p>缓存中数据的“寿命”<strong>并非由时间决定，而是完全由该CPU核心上发生的缓存空间竞争激烈程度所决定</strong>。不存在一个“数据过期计时器”。</p>\n<p>数据的存留情况取决于后续在该核心上运行的其他任务的内存访问模式。我们可以设想两种极端情况：</p>\n<ul>\n<li><strong>低竞争环境</strong>：如果一个核心在接下来的很长一段时间内，运行的任务所访问的数据集很小，或者与之前任务的数据在缓存中占用的位置不冲突，那么之前任务的“热数据”就有可能在缓存中存留很长时间。</li>\n<li><strong>高竞争环境</strong>：如果后续运行的任务是一个需要大量内存的 <strong>“缓存破坏者” (Cache Buster)</strong>，它会大量加载自己的数据，迅速地将前一个任务留下的数据从缓存中替换出去。在这种情况下，前一个任务的数据可能在短短几微秒或几毫秒内就完全“蒸发”了。</li>\n</ul>\n<p>因此，缓存数据的存留期是一个动态变化的过程，直接反映了CPU核心上任务切换和内存访问的实时状况。</p>\n<hr />\n<h3 id=\"四-缓存命中高速公路的入口\"><a class=\"anchor\" href=\"#四-缓存命中高速公路的入口\">#</a> <strong>四、“缓存命中”：高速公路的入口</strong></h3>\n<p><strong>“缓存命中”这一概念的准确定义是什么？它与任务上下文切换后期望的“热数据”重用之间是什么关系？</strong></p>\n<blockquote>\n<p>“缓存命中”是衡量缓存效率的核心指标。它描述了一个基础而关键的事件：CPU需要的数据恰好在高速缓存中被找到。理解其准确定义，有助于我们弄清为何CPU亲和性等调度策略对于提升多任务系统的性能至关重要。</p>\n</blockquote>\n<p><strong>“缓存命中” (Cache Hit)</strong> 的准确定义是：CPU在尝试从某个内存地址读取数据或指令时，在高速缓存中直接找到了所需的内容，无需再访问更低速的主内存。这是一次成功的、高效的内存访问。反之，如果在缓存中没有找到，必须去主内存读取，则称为 <strong>“缓存未命中” (Cache Miss)</strong>。</p>\n<p>它与任务上下文切换的关系体现在：</p>\n<p>上下文切换后，任务能否快速恢复高性能，关键就在于其重新执行时缓存命中的概率有多高。</p>\n<ul>\n<li><strong>CPU亲和性策略</strong>的目的，就是为了让一个任务在被切换出去又切换回来后，能够大概率地在 <strong>同一个CPU核心</strong> 上运行。</li>\n<li>这样做的<strong>最终目标</strong>，是为了让这个任务能够重用上次运行时留在该核心缓存中的 <strong>“热数据”</strong>。</li>\n<li>当任务成功重用这些数据时，就表现为<strong>大量的缓存命中</strong>，从而避免了因缓存未命中而去访问慢速主内存所带来的巨大性能损失。</li>\n</ul>\n<p>简而言之，CPU亲和性是一种<strong>策略</strong>，而缓存命中是该策略成功时所获得的<strong>收益</strong>。</p>\n<hr />\n<h3 id=\"五-单片机中的缓存权责分明\"><a class=\"anchor\" href=\"#五-单片机中的缓存权责分明\">#</a> <strong>五、单片机中的缓存：权责分明</strong></h3>\n<p><strong>对于带有缓存的单片机（如Cortex-M7），其缓存工作机制与通用处理器相比，在内存模型和开发者责任方面最核心的区别是什么？</strong></p>\n<blockquote>\n<p>缓存并非大型CPU的专利，诸如STM32H7系列的高性能单片机也配备了缓存。然而，由于其硬件架构和应用场景的差异，这类嵌入式系统中的缓存工作原理、尤其是在与RTOS和DMA交互时，与我们熟悉的Linux系统存在着根本性的不同。</p>\n</blockquote>\n<p>其核心区别源于有无 <strong>MMU (内存管理单元)</strong>，这直接导致了内存模型和开发者责任的巨大差异。</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">特性</th>\n<th style=\"text-align:left\">通用处理器 (如Linux系统)</th>\n<th style=\"text-align:left\">高性能单片机 (如Cortex-M7)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\"><strong>核心硬件</strong></td>\n<td style=\"text-align:left\">拥有 <strong>MMU (内存管理单元)</strong></td>\n<td style=\"text-align:left\">通常<strong>无MMU</strong></td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><strong>内存模型</strong></td>\n<td style=\"text-align:left\"><strong>虚拟内存</strong>，进程拥有独立地址空间</td>\n<td style=\"text-align:left\"><strong>物理内存</strong>，所有任务共享同一地址空间</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><strong>缓存一致性</strong></td>\n<td style=\"text-align:left\">由<strong>操作系统和驱动</strong>自动处理</td>\n<td style=\"text-align:left\">责任落在<strong>嵌入式开发者</strong>身上</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><strong>开发者操作</strong></td>\n<td style=\"text-align:left\">无需关心底层缓存细节</td>\n<td style=\"text-align:left\">必须<strong>手动调用</strong> <code>SCB_CleanDCache</code> 等函数进行缓存维护</td>\n</tr>\n</tbody>\n</table>\n",
            "tags": [
                "Linux",
                "CPU缓存"
            ]
        },
        {
            "id": "https://soruan.github.io/2025/08/24/Linux/%E5%AF%B9Linux%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E7%9A%84%E7%90%86%E8%A7%A3/",
            "url": "https://soruan.github.io/2025/08/24/Linux/%E5%AF%B9Linux%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E7%9A%84%E7%90%86%E8%A7%A3/",
            "title": "对Linux任务调度的理解",
            "date_published": "2025-08-24T15:13:29.000Z",
            "content_html": "<h3 id=\"一-统一的调度单元任务task\"><a class=\"anchor\" href=\"#一-统一的调度单元任务task\">#</a> <strong>一、统一的调度单元：任务（Task）</strong></h3>\n<p><strong>Linux调度器进行上下文切换的基本单位究竟是什么，它又是如何统一进程与线程这两个概念的呢？</strong></p>\n<blockquote>\n<p>操作系统中同时存在进程和线程，它们都需要CPU资源且都会发生上下文切换。为了高效管理，调度器并非在两种不同类型的实体间做选择，而是将它们抽象成一个统一的调度单元。</p>\n</blockquote>\n<p>在Linux内核的视角中，进行调度和上下文切换的基本单位是<strong>任务（task）</strong>，它由一个名为 <code>task_struct</code> 的数据结构来描述。这种设计巧妙地统一了进程和线程的概念。</p>\n<p>具体来说，一个<strong>进程</strong>被视为一个资源的集合（如虚拟内存空间、文件描述符等），以及至少一个执行流。当一个进程被创建时，内核会创建一个代表其主执行流的“任务”，这个任务就是主线程。</p>\n<p>如果这个进程通过系统调用（如 <code>clone()</code>）创建了新的<strong>线程</strong>，内核所做的仅仅是创建了一个新的“任务”。这个新任务会共享其父进程的资源（如内存空间），但拥有自己独立的CPU状态、寄存器和栈，因此可以被独立调度。</p>\n<p>因此，调度器无需关心它正在处理的是“进程”还是“线程”。它只维护一个所有可运行“任务”的列表，并从中选择下一个来执行。这种统一的抽象大大简化了调度器的设计和实现。</p>\n<h3 id=\"二-切换的代价轻量级与重量级\"><a class=\"anchor\" href=\"#二-切换的代价轻量级与重量级\">#</a> <strong>二、切换的代价：轻量级与重量级</strong></h3>\n<p><strong>同样是线程切换，为何在同一进程内的成本会远低于跨进程切换，其背后最主要的开销差异体现在哪里？</strong></p>\n<blockquote>\n<p>上下文切换的成本并非一成不变。当CPU的控制权从一个线程转移到另一个线程时，如果两个线程共享同一个内存空间，切换就相对轻快；反之，如果它们分属不同进程，切换过程就需要处理更复杂的重量级资源，导致开销剧增。</p>\n</blockquote>\n<p>这两种切换成本差异的根源在于是否需要更换<strong>虚拟内存空间</strong>。</p>\n<table>\n<thead>\n<tr>\n<th>特性</th>\n<th>同进程内切换 (轻量级)</th>\n<th>跨进程切换 (重量级)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>共享资源</strong></td>\n<td>共享同一虚拟内存空间、文件描述符等</td>\n<td>拥有独立的虚拟内存空间和资源</td>\n</tr>\n<tr>\n<td><strong>核心操作</strong></td>\n<td>保存/恢复线程私有的CPU寄存器、栈指针等</td>\n<td>除线程私有状态外，还需切换整个页表</td>\n</tr>\n<tr>\n<td><strong>主要开销</strong></td>\n<td>仅CPU状态切换，速度快</td>\n<td>内存管理单元(MMU)相关操作，开销大</td>\n</tr>\n<tr>\n<td><strong>缓存影响</strong></td>\n<td>对 <strong>TLB</strong> (转译后备缓冲器) 无影响</td>\n<td>导致 <strong>TLB</strong> 大部分失效，引起性能下降</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"三-完全公平的实现虚拟运行时间vruntime\"><a class=\"anchor\" href=\"#三-完全公平的实现虚拟运行时间vruntime\">#</a> <strong>三、完全公平的实现：虚拟运行时间（vruntime）</strong></h3>\n<p><strong>Linux的CFS调度器是如何通过“虚拟运行时间”（vruntime）这一核心机制，来实现其“完全公平”的调度策略的？</strong></p>\n<blockquote>\n<p>为了在多任务环境中实现公平，调度器不能简单地轮流分配时间。CFS（完全公平调度器）引入了一个精巧的机制，它追踪每个任务“应得”的运行时间，并总是优先选择那个“受委屈最多”的任务，从而在宏观上达到公平。</p>\n</blockquote>\n<p>CFS (Completely Fair Scheduler) 的核心目标并非让每个任务获得绝对相等的时间片，而是让每个任务获得与其权重（优先级）相称的<strong>CPU使用比例</strong>。它通过<strong>虚拟运行时间 (<code>vruntime</code>)</strong> 这一机制来实现这一目标。</p>\n<p>每个任务都有一个 <code>vruntime</code> 计数器。当任务在CPU上运行时，它的 <code>vruntime</code> 会不断增长。这个增长的速度会根据任务的优先级进行加权：高优先级任务的 <code>vruntime</code> 增长得<em>慢</em>，低优先级任务的 <code>vruntime</code> 增长得<em>快</em>。</p>\n<p>CFS调度器的调度规则只有一条：<strong>在所有可运行的任务中，永远选择 vruntime 值最小的那个任务来执行。</strong></p>\n<p>这个简单的规则确保了那个在“虚拟时间”上等待最久（即“受委屈最多”）的任务能够优先获得CPU。因为高优先级任务的 <code>vruntime</code> 跑得慢，所以它能获得更多的实际运行时间，才能让自己的 <code>vruntime</code> 追上其他任务。这样，CFS就将复杂的调度问题转化为了一个简单的“谁最小，谁运行”的问题，从而实现了对所有任务的公平调度。</p>\n<h3 id=\"四-公平与效率的平衡术\"><a class=\"anchor\" href=\"#四-公平与效率的平衡术\">#</a> <strong>四、公平与效率的平衡术</strong></h3>\n<p><strong>既然调度器的首要原则是公平，那么它采用了哪些策略来间接缓解高昂的跨进程切换开销对系统整体吞吐量的影响，从而在公平与效率之间取得平衡？</strong></p>\n<blockquote>\n<p>一个理想的调度器不仅要公平，还要高效。如果为了绝对公平而频繁地进行高成本的进程切换，系统总性能会下降。因此，调度器在坚守其公平原则的同时，也必须内建一些机制来摊薄和优化这些切换带来的开销。</p>\n</blockquote>\n<p>调度器在坚守“公平”（<code>vruntime</code>优先）这一首要原则的同时，通过以下几种策略来兼顾效率，缓解高昂切换成本带来的影响：</p>\n<ol>\n<li><strong>最小调度粒度 (Minimum Granularity)</strong>：调度器会确保任何一个任务一旦被调度上CPU，至少会运行一个最小的时间（例如1-2毫秒）。这就避免了因任务过多导致时间片被无限细分，从而使得CPU把大量时间浪费在“切换”而非“执行”上的情况。这个机制相当于为每一次上下文切换的成本设置了一个“保底”的有效工作时间，从而摊薄了开销。</li>\n<li><strong>目标延迟 (Target Latency)</strong>：CFS会尝试在一个可配置的时间周期（目标延迟，如20毫秒）内，让所有可运行的任务都至少执行一次。它会根据当前可运行任务的数量来动态计算每个任务应得的时间片。这在任务数量较少时，可以提供更长的执行时间，减少切换频率；在任务数量多时，又能保证较低的响应延迟。</li>\n<li><strong>智能唤醒策略</strong>：当一个任务从睡眠中被唤醒时，调度器会智能地决定将它放到哪个CPU的运行队列中。它通常会优先选择任务上次运行的CPU，或者唤醒它的任务所在的CPU，以期提高缓存的利用率，这与下一节的CPU亲和性紧密相关。</li>\n</ol>\n<h3 id=\"五-缓存的价值cpu亲和性\"><a class=\"anchor\" href=\"#五-缓存的价值cpu亲和性\">#</a> <strong>五、缓存的价值：CPU亲和性</strong></h3>\n<p><strong>CPU亲和性策略具体是如何通过提升缓存命中率，来显著降低任务因上下文切换（尤其是在CPU核心间迁移）而导致的性能损失的？</strong></p>\n<blockquote>\n<p>上下文切换的代价不仅在于切换操作本身，更在于其对CPU高速缓存的破坏性影响。调度器通过一种名为“CPU亲和性”的策略，试图让任务“记住”它上次运行的核心，从而最大化地重用缓存中的“热”数据，避免昂贵的内存访问。</p>\n</blockquote>\n<p><strong>CPU亲和性 (Cache Affinity)</strong> 并不减少上下文切换本身的直接开销（如保存寄存器），但它能极大地缓解切换带来的<strong>间接性能损失</strong>，这个损失主要来源于CPU高速缓存的失效。</p>\n<p>其工作原理如下：</p>\n<p>当一个任务在某个CPU核心上运行时，它所需要的数据和指令会被加载到该核心的 <code>L1</code>、<code>L2</code> 甚至 <code>L3</code> 缓存中。我们称这个缓存是<strong>热的 (hot)</strong>。从缓存中读取数据的速度比从主内存读取要快几个数量级。</p>\n<p>如果该任务被切换出去，稍后又被调度器放回<strong>同一个CPU核心</strong>上运行，那么它之前留在缓存中的数据有很大概率仍然存在。任务可以立刻高速地访问这些“热”数据，迅速恢复到最佳运行性能。</p>\n<p>相反，如果调度器将这个任务迁移到<strong>另一个CPU核心</strong>上，新核心的缓存对这个任务来说是<strong>冷的 (cold)</strong>。任务必须重新从缓慢的主内存中加载所有需要的数据，这个过程会造成显著的性能瓶颈。</p>\n<p>因此，CPU亲和性策略就是<strong>让调度器“倾向于”将一个任务调度回它上一次执行的那个CPU核心上</strong>。通过维持这种“亲和性”，调度器最大化了缓存的重用率，显著减少了因任务迁移带来的性能惩罚，从而在宏观上提升了整个系统的运行效率。</p>\n",
            "tags": [
                "Linux",
                "任务调度"
            ]
        },
        {
            "id": "https://soruan.github.io/2025/08/24/SBC/%E8%B0%83%E8%AF%95USB%E6%91%84%E5%83%8F%E5%A4%B4/",
            "url": "https://soruan.github.io/2025/08/24/SBC/%E8%B0%83%E8%AF%95USB%E6%91%84%E5%83%8F%E5%A4%B4/",
            "title": "调试USB摄像头",
            "date_published": "2025-08-24T12:21:57.000Z",
            "content_html": "<h1 id=\"usb摄像头带麦克风和扬声器调试\"><a class=\"anchor\" href=\"#usb摄像头带麦克风和扬声器调试\">#</a> USB摄像头（带麦克风和扬声器）调试</h1>\n<p>带麦克风咪头和扬声器的USB摄像头<br />\n<img loading=\"lazy\" src=\"https://markdownforyuanhao.oss-cn-hangzhou.aliyuncs.com/img1/20250824202654485.jpg\" alt=\"qq_pic_merged_1756038364912\" /></p>\n<h2 id=\"摄像头探测\"><a class=\"anchor\" href=\"#摄像头探测\">#</a> 摄像头探测</h2>\n<p>首先，需要确认摄像头设备是否被系统正确识别。</p>\n<ol>\n<li>\n<p>列出USB设备</p>\n<p>使用lsusb命令可以查看所有连接到系统的USB设备。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">hao@lckfb-taishanpi:~$</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> lsusb</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">Bus</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 001</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Device</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 001:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> ID</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 1d6b:0002</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Linux</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Foundation</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 2.0</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> root</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> hub</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">Bus</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 002</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Device</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 001:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> ID</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 1d6b:0003</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Linux</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Foundation</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 3.0</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> root</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> hub</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">Bus</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 003</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Device</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 001:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> ID</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 1d6b:0002</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Linux</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Foundation</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 2.0</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> root</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> hub</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">Bus</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 004</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Device</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 001:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> ID</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 1d6b:0001</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Linux</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Foundation</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 1.1</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> root</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> hub</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">Bus</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 004</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Device</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 002:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> ID</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 349c:3307</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Generic</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> HD</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> video</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">  </span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">Bus</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 005</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Device</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 001:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> ID</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 1d6b:0002</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Linux</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Foundation</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 2.0</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> root</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> hub</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">Bus</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 006</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Device</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 001:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> ID</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 1d6b:0001</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Linux</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Foundation</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 1.1</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> root</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> hub</span></span></code></pre>\n<p>其中<code>HD video</code>就是我们的USB摄像头。</p>\n</li>\n<li>\n<p>查看视频设备节点</p>\n<p>系统会为视频设备创建相应的设备文件。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">hao@lckfb-taishanpi:~$</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> ls</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> /dev/video</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\">*</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">/dev/video0</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  /dev/video1</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  /dev/video2</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  /dev/video5</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  /dev/video-dec1</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  /dev/video-dec2</span></span></code></pre>\n</li>\n<li>\n<p>使用v4l-utils工具</p>\n<p>v4l-utils是一个强大的视频设备调试工具集，可以提供更详细的设备信息。如果系统未安装，请先安装。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">sudo</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> apt-get</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> install</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> v4l-utils</span></span></code></pre>\n<p>使用<code>v4l2-ctl</code>列出所有视频设备及其关联的设备节点。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">hao@lckfb-taishanpi:~$</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> v4l2-ctl</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> --list-devices</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">rockchip,rk3328-vpu-dec</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">platform:fdea0000.video-codec</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">:</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        /dev/video2</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        /dev/media1</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">rockchip,rk3568-vepu-enc</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">platform:fdee0000.video-codec</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">:</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        /dev/video5</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        /dev/media3</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">rockchip-rga</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">platform:rga</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">:</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        /dev/video0</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">rkvdec2</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">platform:rkvdec2</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">:</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        /dev/video1</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        /dev/media0</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">HD</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> video</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">  :</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> HD</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> video</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">   </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">usb-fd840000.usb-1</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">:</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        /dev/video3</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        /dev/video4</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        /dev/media2</span></span></code></pre>\n<p>从输出中可以看到，名为<code>HD video</code>的USB摄像头关联了<code>/dev/video3</code>和<code>/dev/video4</code>两个设备节点。</p>\n</li>\n</ol>\n<h2 id=\"查看摄像头参数\"><a class=\"anchor\" href=\"#查看摄像头参数\">#</a> 查看摄像头参数</h2>\n<p>接下来，我们需要确定哪个设备节点是有效的，并查看其支持的视频格式、分辨率和帧率。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">hao@lckfb-taishanpi:~$</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> v4l2-ctl</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -d</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> /dev/video4</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> --list-formats-ext</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">ioctl:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> VIDIOC_ENUM_FMT</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        Type:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Video</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Capture</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">hao@lckfb-taishanpi:~$</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> v4l2-ctl</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -d</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> /dev/video3</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> --list-formats-ext</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">ioctl:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> VIDIOC_ENUM_FMT</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">        Type:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Video</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Capture</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#999999;--shiki-dark:#666666\">        </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">[</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">0</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">]</span><span style=\"color:#998418;--shiki-dark:#B8A965\">:</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> '</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">MJPG</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">'</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">Motion-JPEG, </span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">compressed</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">                Size:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Discrete</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 1280x720</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">                        Interval:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Discrete</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 0.067s</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">15.000 </span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">fps</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">                        Interval:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Discrete</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 0.100s</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">10.000 </span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">fps</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">                Size:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Discrete</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 800x480</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">                        Interval:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Discrete</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 0.050s</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">20.000 </span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">fps</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">                        Interval:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Discrete</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 0.067s</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">15.000 </span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">fps</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">                Size:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Discrete</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 640x480</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">                        Interval:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Discrete</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 0.040s</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">25.000 </span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">fps</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">                        Interval:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Discrete</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 0.067s</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">15.000 </span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">fps</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">                Size:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Discrete</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 480x320</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">                        Interval:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Discrete</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 0.040s</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">25.000 </span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">fps</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">                        Interval:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Discrete</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 0.067s</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">15.000 </span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">fps</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">                Size:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Discrete</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 480x854</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">                        Interval:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Discrete</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 0.040s</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">25.000 </span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">fps</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">                        Interval:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Discrete</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 0.050s</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">(</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">20.000 </span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">fps</span><span style=\"color:#2993a3;--shiki-dark:#5eaab5\">)</span></span></code></pre>\n<p>结果表明，<code>/dev/video4</code>不支持视频捕获格式，而<code>/dev/video3</code>支持<code>MJPG</code>格式，并列出了多种分辨率和帧率的组合。因此，我们应该使用<code>/dev/video3</code>作为视频输入设备。</p>\n<h2 id=\"使用摄像头\"><a class=\"anchor\" href=\"#使用摄像头\">#</a> 使用摄像头</h2>\n<h3 id=\"拍照\"><a class=\"anchor\" href=\"#拍照\">#</a> 拍照</h3>\n<p>使用<code>ffmpeg</code>从摄像头捕获一帧图像并保存为图片。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">ffmpeg</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -f</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> v4l2</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -i</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> /dev/video3</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -ss</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 0.5</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -vframes</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 1</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -update</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 1</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">&#x3C;</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">您的文件名.jp</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">g</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span></span></code></pre>\n<h3 id=\"录制视频无声\"><a class=\"anchor\" href=\"#录制视频无声\">#</a> 录制视频（无声）</h3>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">ffmpeg</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -f</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> v4l2</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -input_format</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> mjpeg</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -s</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 1280x720</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -r</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 15</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -i</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> /dev/video3</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -c:v</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> copy</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> output.mkv</span></span></code></pre>\n<p>在终端里按<code>Ctrl + C</code>停止录制。</p>\n<p><strong>参数说明:</strong></p>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-f v4l2</code></td>\n<td>强制使用<code>v4l2</code>驱动。</td>\n</tr>\n<tr>\n<td><code>-input_format mjpeg</code></td>\n<td>指定输入流是摄像头支持的<code>mjpeg</code>格式。</td>\n</tr>\n<tr>\n<td><code>-s 1280x720</code></td>\n<td>设置视频分辨率。</td>\n</tr>\n<tr>\n<td><code>-r 15</code></td>\n<td>设置视频帧率。</td>\n</tr>\n<tr>\n<td><code>-i /dev/video3</code></td>\n<td>指定输入设备。</td>\n</tr>\n<tr>\n<td><code>-c:v copy</code></td>\n<td>直接复制视频流，不进行重新编码，以降低CPU消耗。</td>\n</tr>\n<tr>\n<td><code>output.mkv</code></td>\n<td>输出的视频文件名。</td>\n</tr>\n</tbody>\n</table>\n<p><strong>注意</strong>: 分辨率和帧率需要选择摄像头支持的组合。根据探测结果，<code>1280x720</code>分辨率下支持<code>15.000 fps</code>。</p>\n<h2 id=\"音频设备探测\"><a class=\"anchor\" href=\"#音频设备探测\">#</a> 音频设备探测</h2>\n<p>使用<code>aplay</code>和<code>arecord</code>命令探测播放和录音设备。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">hao@lckfb-taishanpi:~$</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> aplay</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -l</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">****</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> List of PLAYBACK Hardware Devices </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">****</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">card</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 0:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> video</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span><span style=\"color:rgba(255, 18, 18, 0.8);--shiki-dark:rgba(255, 18, 18, 0.8)\">[</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">HD </span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">video],</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> device</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 0:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> USB</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Audio</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span><span style=\"color:rgba(255, 18, 18, 0.8);--shiki-dark:rgba(255, 18, 18, 0.8)\">[</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">USB </span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Audio]</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">  Subdevices:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 1/1</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">  Subdevice</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> #0: subdevice #0</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">card</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 1:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> RK809</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span><span style=\"color:rgba(255, 18, 18, 0.8);--shiki-dark:rgba(255, 18, 18, 0.8)\">[</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">Analog </span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">RK809],</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> device</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 0:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> fe410000.i2s-rk817-hifi</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> rk817-hifi-0</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span><span style=\"color:rgba(255, 18, 18, 0.8);--shiki-dark:rgba(255, 18, 18, 0.8)\">[</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">fe410000.i2s-rk817-hifi </span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">rk817-hifi-0]</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">  Subdevices:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 0/1</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">  Subdevice</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> #0: subdevice #0</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">hao@lckfb-taishanpi:~$</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> arecord</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -l</span></span>\n<span class=\"line\"><span style=\"color:#AB5959;--shiki-dark:#CB7676\">****</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> List of CAPTURE Hardware Devices </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">****</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">card</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 0:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> video</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span><span style=\"color:rgba(255, 18, 18, 0.8);--shiki-dark:rgba(255, 18, 18, 0.8)\">[</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">HD </span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">video],</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> device</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 0:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> USB</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> Audio</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span><span style=\"color:rgba(255, 18, 18, 0.8);--shiki-dark:rgba(255, 18, 18, 0.8)\">[</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">USB </span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">Audio]</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">  Subdevices:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 1/1</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">  Subdevice</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> #0: subdevice #0</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">card</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 1:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> RK809</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span><span style=\"color:rgba(255, 18, 18, 0.8);--shiki-dark:rgba(255, 18, 18, 0.8)\">[</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">Analog </span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">RK809],</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> device</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 0:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> fe410000.i2s-rk817-hifi</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> rk817-hifi-0</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\"> </span><span style=\"color:rgba(255, 18, 18, 0.8);--shiki-dark:rgba(255, 18, 18, 0.8)\">[</span><span style=\"color:#393A34;--shiki-dark:#DBD7CAEE\">fe410000.i2s-rk817-hifi </span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">rk817-hifi-0]</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">  Subdevices:</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> 0/1</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">  Subdevice</span><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"> #0: subdevice #0</span></span></code></pre>\n<p><strong>设备列表:</strong></p>\n<table>\n<thead>\n<tr>\n<th>设备名称</th>\n<th>类型</th>\n<th>声卡号 (Card)</th>\n<th>设备号 (Device)</th>\n<th>ALSA标识</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>HD video</strong></td>\n<td>播放 &amp; 录制</td>\n<td>0</td>\n<td>0</td>\n<td><code>hw:0,0</code></td>\n</tr>\n<tr>\n<td><strong>Analog RK809</strong></td>\n<td>播放 &amp; 录制</td>\n<td>1</td>\n<td>0</td>\n<td><code>hw:1,0</code></td>\n</tr>\n</tbody>\n</table>\n<p>我们的USB摄像头集成了麦克风和扬声器，被识别为声卡0。</p>\n<h2 id=\"使用音频设备\"><a class=\"anchor\" href=\"#使用音频设备\">#</a> 使用音频设备</h2>\n<h3 id=\"录制有声视频\"><a class=\"anchor\" href=\"#录制有声视频\">#</a> 录制有声视频</h3>\n<p>结合视频和音频输入，录制带有声音的视频。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">ffmpeg</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -f</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> v4l2</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -input_format</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> mjpeg</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -i</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> /dev/video3</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -f</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> alsa</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -channels</span><span style=\"color:#2F798A;--shiki-dark:#4C9A91\"> 1</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -i</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> hw:0,0</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -c:v</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> copy</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -c:a</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> aac</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> video_with_audio.mp4</span></span></code></pre>\n<p><strong>新增音频参数说明:</strong></p>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-f alsa</code></td>\n<td>强制使用<code>alsa</code>作为音频驱动。</td>\n</tr>\n<tr>\n<td><code>-channels 1</code></td>\n<td>设置音频通道为单声道。某些设备可能不支持双声道录制。</td>\n</tr>\n<tr>\n<td><code>-i hw:0,0</code></td>\n<td>指定音频输入设备（声卡0，设备0）。</td>\n</tr>\n<tr>\n<td><code>-c:a aac</code></td>\n<td>指定音频编码器为<code>aac</code>。</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"播放音频\"><a class=\"anchor\" href=\"#播放音频\">#</a> 播放音频</h3>\n<ul>\n<li>\n<p><strong>使用<code>aplay</code>播放<code>.wav</code>格式文件</strong></p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">aplay</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -D</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> hw:0,0</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> test_sound.wav</span></span></code></pre>\n<p><code>-D hw:0,0</code>明确指定使用声卡0，设备0进行播放。</p>\n</li>\n<li>\n<p>使用ffplay播放多种格式音频</p>\n<p>ffplay可以播放mp3等多种格式，并且能自动选择默认声卡。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">ffplay</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> music.mp3</span></span></code></pre>\n</li>\n</ul>\n",
            "tags": [
                "SBC",
                "音视频"
            ]
        }
    ]
}